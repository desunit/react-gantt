"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const c=require("react/jsx-runtime"),e=require("react"),be=require("@svar-ui/react-core"),Se=require("@svar-ui/lib-dom"),Be=require("@svar-ui/gantt-locales"),Je=require("@svar-ui/core-locales"),jt=require("@svar-ui/lib-state"),ke=require("@svar-ui/gantt-store"),R=require("@svar-ui/lib-react"),gt=require("@svar-ui/grid-store"),wt=require("@svar-ui/react-grid"),Dt=require("react-dom"),ut=require("@svar-ui/react-toolbar"),It=require("@svar-ui/react-menu"),_e=require("@svar-ui/react-editor"),He=e.createContext(null);function ze(s){const n=s.getAttribute("data-id"),r=parseInt(n);return isNaN(r)||r.toString()!=n?n:r}function Lt(s,n,r){const i=s.getBoundingClientRect(),l=n.querySelector(".wx-body").getBoundingClientRect();return{top:i.top-l.top,left:i.left-l.left,dt:i.bottom-r.clientY,db:r.clientY-i.top}}function dt(s){return s&&s.getAttribute("data-context-id")}const ft=5;function Nt(s,n){let r,i,l,N,y,h,o,k,b;function F(T){N=T.clientX,y=T.clientY,h={...Lt(r,s,T),y:n.getTask(l).$y},document.body.style.userSelect="none"}function z(T){r=Se.locate(T),dt(r)&&(l=ze(r),b=setTimeout(()=>{k=!0,n&&n.touchStart&&n.touchStart(),F(T.touches[0])},500),s.addEventListener("touchmove",I),s.addEventListener("contextmenu",H),window.addEventListener("touchend",V))}function H(T){if(k||b)return T.preventDefault(),!1}function P(T){T.which===1&&(r=Se.locate(T),dt(r)&&(l=ze(r),s.addEventListener("mousemove",te),window.addEventListener("mouseup",j),F(T)))}function d(T){s.removeEventListener("mousemove",te),s.removeEventListener("touchmove",I),document.body.removeEventListener("mouseup",j),document.body.removeEventListener("touchend",V),document.body.style.userSelect="",T&&(s.removeEventListener("mousedown",P),s.removeEventListener("touchstart",z))}function S(T){const re=T.clientX-N,Z=T.clientY-y;if(!i){if(Math.abs(re)<ft&&Math.abs(Z)<ft||n&&n.start&&n.start({id:l,e:T})===!1)return;i=r.cloneNode(!0),i.style.pointerEvents="none",i.classList.add("wx-reorder-task"),i.style.position="absolute",i.style.left=h.left+"px",i.style.top=h.top+"px",r.style.visibility="hidden",r.parentNode.insertBefore(i,r)}if(i){const ce=Math.round(Math.max(0,h.top+Z));if(n&&n.move&&n.move({id:l,top:ce,detail:o})===!1)return;const G=n.getTask(l),we=G.$y;if(!h.start&&h.y==we)return O();h.start=!0,h.y=G.$y-4,i.style.top=ce+"px";const U=document.elementFromPoint(T.clientX,T.clientY),W=Se.locate(U);if(W&&W!==r){const w=ze(W),M=W.getBoundingClientRect(),se=M.top+M.height/2,B=T.clientY+h.db>se&&W.nextElementSibling!==r,ie=T.clientY-h.dt<se&&W.previousElementSibling!==r;o?.after==w||o?.before==w?o=null:B?o={id:l,after:w}:ie&&(o={id:l,before:w})}}}function te(T){S(T)}function I(T){k?(T.preventDefault(),S(T.touches[0])):b&&(clearTimeout(b),b=null)}function V(){k=null,b&&(clearTimeout(b),b=null),O()}function j(){O()}function O(){r&&(r.style.visibility=""),i&&(i.parentNode.removeChild(i),n&&n.end&&n.end({id:l,top:h.top})),l=r=i=h=o=null,d()}return s.style.position!=="absolute"&&(s.style.position="relative"),s.addEventListener("mousedown",P),s.addEventListener("touchstart",z),{destroy(){d(!0)}}}function Pt({row:s,column:n}){function r(l,N){return{justifyContent:N.align,paddingLeft:`${(l.$level-1)*20}px`}}const i=n&&n._cell;return c.jsxs("div",{className:"wx-pqc08MHU wx-content",style:r(s,n),children:[s.data||s.lazy?c.jsx("i",{className:`wx-pqc08MHU wx-toggle-icon wxi-menu-${s.open?"down":"right"}`,"data-action":"open-task"}):c.jsx("i",{className:"wx-pqc08MHU wx-toggle-placeholder"}),c.jsx("div",{className:"wx-pqc08MHU wx-text",children:i?c.jsx(i,{row:s,column:n}):s.text})]})}function xt({column:s,cell:n}){const r=e.useMemo(()=>s.id,[s?.id]);return n||s.id=="add-task"?c.jsx("div",{style:{textAlign:s.align},children:c.jsx("i",{className:"wx-9DAESAHW wx-action-icon wxi-plus","data-action":r})}):null}function Ot(s){const{readonly:n,compactMode:r,width:i=0,display:l="all",columnWidth:N=0,onTableAPIChange:y,multiTaskRows:h=!1,rowMapping:o=null}=s,[k,b]=R.useWritableProp(N),[F,z]=e.useState(),H=e.useContext(be.context.i18n),P=e.useMemo(()=>H.getGroup("gantt"),[H]),d=e.useContext(He),S=R.useStore(d,"scrollTop"),te=R.useStore(d,"cellHeight"),I=R.useStore(d,"_scrollTask"),V=R.useStore(d,"_selected"),j=R.useStore(d,"area"),O=R.useStore(d,"_tasks"),T=R.useStore(d,"_scales"),re=R.useStore(d,"columns"),Z=R.useStore(d,"_sort"),ce=R.useStore(d,"calendar"),G=R.useStore(d,"durationUnit"),we=R.useStore(d,"splitTasks"),[U,W]=e.useState(null),w=e.useMemo(()=>!O||!j?[]:h&&o?O:O.slice(j.start,j.end),[O,j,h,o]),M=e.useCallback((a,g)=>{if(g==="add-task")d.exec(g,{target:a,task:{text:P("New Task")},mode:"child",show:!0});else if(g==="open-task"){const $=w.find(Y=>Y.id===a);($?.data||$?.lazy)&&d.exec(g,{id:a,mode:!$.open})}},[w]),se=e.useCallback(a=>{const g=Se.locateID(a),$=a.target.dataset.action;$&&a.preventDefault(),g?$==="add-task"||$==="open-task"?M(g,$):d.exec("select-task",{id:g,toggle:a.ctrlKey||a.metaKey,range:a.shiftKey,show:!0}):$==="add-task"&&M(null,$)},[d,M]),B=e.useRef(null),ie=e.useRef(null),[oe,he]=e.useState(0),[De,$e]=e.useState(!1);e.useEffect(()=>{const a=ie.current;if(!a||typeof ResizeObserver>"u")return;const g=()=>he(a.clientWidth);g();const $=new ResizeObserver(g);return $.observe(a),()=>$.disconnect()},[]);const Ee=e.useRef(null),Re=e.useCallback(a=>{const g=a.id,{before:$,after:Y}=a,ge=a.onMove;let de=$||Y,Me=$?"before":"after";if(ge){if(Me==="after"){const We=d.getTask(de);We.data?.length&&We.open&&(Me="before",de=We.data[0].id)}Ee.current={id:g,[Me]:de}}else Ee.current=null;d.exec("move-task",{id:g,mode:Me,target:de,inProgress:ge})},[d]),Ce=e.useMemo(()=>h&&o?0:j?.from??0,[j,h,o]),Ie=e.useMemo(()=>T?.height??0,[T]),Q=e.useMemo(()=>!r&&l!=="grid"?(k??0)>(i??0):(k??0)>(oe??0),[r,l,k,i,oe]),p=e.useMemo(()=>{const a={};return Q&&l==="all"||l==="grid"&&Q?a.width=k:l==="grid"&&(a.width="100%"),a},[Q,l,k]),_=e.useMemo(()=>U&&!w.find(a=>a.id===U.id)?[...w,U]:w,[w,U]),X=e.useMemo(()=>{if(!h||!o)return _;const a=new Map,g=new Set;return _.forEach($=>{const Y=o.taskRows.get($.id)??$.id;g.has(Y)||(a.set(Y,{...$,$rowTasks:o.rowMap.get(Y)||[$.id]}),g.add(Y))}),Array.from(a.values())},[_,h,o]),A=e.useMemo(()=>{let a=(re||[]).map(Y=>{Y={...Y};const ge=Y.header;if(typeof ge=="object"){const de=ge.text&&P(ge.text);Y.header={...ge,text:de}}else Y.header=P(ge);return Y});const g=a.findIndex(Y=>Y.id==="text"),$=a.findIndex(Y=>Y.id==="add-task");if(g!==-1&&(a[g].cell&&(a[g]._cell=a[g].cell),a[g].cell=Pt),$!==-1){a[$].cell=a[$].cell||xt;const Y=a[$].header;if(typeof Y!="object"&&(a[$].header={text:Y}),a[$].header.cell=Y.cell||xt,n)a.splice($,1);else if(r){const[ge]=a.splice($,1);a.unshift(ge)}}return a.length>0&&(a[a.length-1].resize=!1),a},[re,P,n,r]),J=e.useMemo(()=>l==="all"?`${i}px`:l==="grid"?"calc(100% - 4px)":A.find(a=>a.id==="add-task")?"50px":"0",[l,i,A]),me=e.useMemo(()=>{if(X&&Z?.length){const a={};return Z.forEach(({key:g,order:$},Y)=>{a[g]={order:$,...Z.length>1&&{index:Y}}}),a}return{}},[X,Z]),ne=e.useCallback(()=>A.some(a=>a.flexgrow&&!a.hidden),[]),v=e.useMemo(()=>ne(),[ne,De]),K=e.useMemo(()=>{let a=l==="chart"?A.filter($=>$.id==="add-task"):A;const g=l==="all"?i:oe;if(!v){let $=k,Y=!1;if(A.some(ge=>ge.$width)){let ge=0;$=A.reduce((de,Me)=>(Me.hidden||(ge+=Me.width,de+=Me.$width||Me.width),de),0),ge>$&&$>g&&(Y=!0)}if(Y||$<g){let ge=1;return Y||(ge=(g-50)/($-50||1)),a.map(de=>(de.id!=="add-task"&&!de.hidden&&(de.$width||(de.$width=de.width),de.width=de.$width*ge),de))}}return a},[l,A,v,k,i,oe]),ue=e.useCallback(a=>{if(!ne()){const g=K.reduce(($,Y)=>(a&&Y.$width&&(Y.$width=Y.width),$+(Y.hidden?0:Y.width)),0);g!==k&&b(g)}$e(!0),$e(!1)},[ne,K,k,b]),x=e.useCallback(()=>{A.filter(g=>g.flexgrow&&!g.hidden).length===1&&A.forEach(g=>{g.$width&&!g.flexgrow&&!g.hidden&&(g.width=g.$width)})},[]),ee=e.useCallback(a=>{if(!n){const g=Se.locateID(a),$=Se.locateAttr(a,"data-col-id");!($&&A.find(ge=>ge.id==$))?.editor&&g&&d.exec("show-editor",{id:g})}},[d,n]),fe=e.useMemo(()=>Array.isArray(V)?V.map(a=>a.id):[],[V]),q=e.useRef(Ce);q.current=Ce,e.useEffect(()=>{const a=$=>{if(B.current){const Y=B.current.querySelector(".wx-body");Y&&(Y.style.top=-(($??0)-(q.current??0))+"px")}ie.current&&(ie.current.scrollTop=0)};return a(S),d.on("scroll-chart",({top:$})=>{$!==void 0&&a($)})},[d,S]),e.useEffect(()=>{if(B.current){const a=B.current.querySelector(".wx-body");a&&(a.style.top=-((S??0)-(Ce??0))+"px")}},[Ce]),e.useEffect(()=>{const a=B.current;if(!a)return;const g=a.querySelector(".wx-table-box .wx-body");if(!g||typeof ResizeObserver>"u")return;const $=new ResizeObserver(()=>{if(B.current){const Y=B.current.querySelector(".wx-body");Y&&(Y.style.top=-((S??0)-(q.current??0))+"px")}});return $.observe(g),()=>{$.disconnect()}},[K,p,l,J,X,S]),e.useEffect(()=>{if(!I||!F)return;const{id:a}=I,g=F.getState().focusCell;g&&g.row!==a&&B.current&&B.current.contains(document.activeElement)&&F.exec("focus-cell",{row:a,column:g.column})},[I,F]);const Te=e.useCallback(({id:a})=>{if(n)return!1;d.getTask(a).open&&d.exec("open-task",{id:a,mode:!1});const g=d.getState()._tasks.find($=>$.id===a);if(W(g||null),!g)return!1},[d,n]),je=e.useCallback(({id:a,top:g})=>{Ee.current?Re({...Ee.current,onMove:!1}):d.exec("drag-task",{id:a,top:g+(Ce??0),inProgress:!1}),W(null)},[d,Re,Ce]),ae=e.useCallback(({id:a,top:g,detail:$})=>{$&&Re({...$,onMove:!0}),d.exec("drag-task",{id:a,top:g+(Ce??0),inProgress:!0})},[d,Re,Ce]);e.useEffect(()=>{const a=B.current;return a?Nt(a,{start:Te,end:je,move:ae,getTask:d.getTask}).destroy:void 0},[d,Te,je,ae]);const ye=e.useCallback(a=>{const{key:g,isInput:$}=a;if(!$&&(g==="arrowup"||g==="arrowdown"))return a.eventSource="grid",d.exec("hotkey",a),!1;if(g==="enter"){const Y=F?.getState().focusCell;if(Y){const{row:ge,column:de}=Y;de==="add-task"?M(ge,"add-task"):de==="text"&&M(ge,"open-task")}}},[d,M,F]),xe=e.useRef(null),Ne=()=>{xe.current={setTableAPI:z,handleHotkey:ye,sortVal:Z,api:d,adjustColumns:x,setColumnWidth:ue,tasks:w,calendarVal:ce,durationUnitVal:G,splitTasksVal:we,onTableAPIChange:y}};Ne(),e.useEffect(()=>{Ne()},[z,ye,Z,d,x,ue,w,ce,G,we,y]);const Oe=e.useCallback(a=>{z(a),a.intercept("hotkey",g=>xe.current.handleHotkey(g)),a.intercept("scroll",()=>!1),a.intercept("select-row",()=>!1),a.intercept("sort-rows",g=>{const $=xe.current.sortVal,{key:Y,add:ge}=g,de=$?$.find(We=>We.key===Y):null;let Me="asc";return de&&(Me=!de||de.order==="asc"?"desc":"asc"),d.exec("sort-tasks",{key:Y,order:Me,add:ge}),!1}),a.on("resize-column",()=>{xe.current.setColumnWidth(!0)}),a.on("hide-column",g=>{g.mode||xe.current.adjustColumns(),xe.current.setColumnWidth()}),a.intercept("update-cell",g=>{const{id:$,column:Y,value:ge}=g,de=xe.current.tasks.find(Me=>Me.id===$);if(de){const Me={...de};let We=ge;We&&!isNaN(We)&&!(We instanceof Date)&&(We*=1),Me[Y]=We,ke.prepareEditTask(Me,{calendar:xe.current.calendarVal,durationUnit:xe.current.durationUnitVal,splitTasks:xe.current.splitTasksVal},Y),d.exec("update-task",{id:$,task:Me})}return!1}),y&&y(a)},[]);return c.jsx("div",{className:"wx-rHj6070p wx-table-container",style:{flex:`0 0 ${J}`},ref:ie,children:c.jsx("div",{ref:B,style:p,className:"wx-rHj6070p wx-table",onClick:se,onDoubleClick:ee,children:c.jsx(wt.Grid,{init:Oe,sizes:{rowHeight:te,headerHeight:(Ie??0)-1},rowStyle:a=>a.$reorder?"wx-rHj6070p wx-reorder-task":"wx-rHj6070p",columnStyle:a=>`wx-rHj6070p wx-text-${a.align}${a.id==="add-task"?" wx-action":""}`,data:X,columns:K,selectedRows:[...fe],sortMarks:me})})})}function Wt({borders:s=""}){const n=e.useContext(He),r=R.useStore(n,"cellWidth"),i=R.useStore(n,"cellHeight"),l=e.useRef(null),[N,y]=e.useState("#e4e4e4");e.useEffect(()=>{if(typeof getComputedStyle<"u"&&l.current){const o=getComputedStyle(l.current).getPropertyValue("--wx-gantt-border");y(o?o.substring(o.indexOf("#")):"#1d1e261a")}},[]);const h={width:"100%",height:"100%",background:r!=null&&i!=null?`url(${ke.grid(r,i,N,s)})`:void 0,position:"absolute",pointerEvents:"none"};return c.jsx("div",{ref:l,style:h})}function _t({onSelectLink:s,selectedLink:n,readonly:r}){const i=e.useContext(He),l=R.useStore(i,"_links"),N=R.useStore(i,"criticalPath"),y=e.useRef(null),h=e.useCallback(o=>{const k=o?.target?.classList;!k?.contains("wx-line")&&!k?.contains("wx-delete-button")&&s(null)},[s]);return e.useEffect(()=>{if(!r&&n&&y.current){const o=k=>{y.current&&!y.current.contains(k.target)&&h(k)};return document.addEventListener("click",o),()=>{document.removeEventListener("click",o)}}},[r,n,h]),c.jsxs("svg",{className:"wx-dkx3NwEn wx-links",children:[(l||[]).map(o=>{const k="wx-dkx3NwEn wx-line"+(N&&o.$critical?" wx-critical":"")+(r?"":" wx-line-selectable");return c.jsx("polyline",{className:k,points:o.$p,onClick:()=>!r&&s(o.id),"data-link-id":o.id},o.id)}),!r&&n&&c.jsx("polyline",{ref:y,className:"wx-dkx3NwEn wx-line wx-line-selected wx-line-selectable wx-delete-link",points:n.$p})]})}function Ht(s){const{task:n,type:r}=s;function i(N){const y=n.segments[N];return{left:`${y.$x}px`,top:"0px",width:`${y.$w}px`,height:"100%"}}function l(N){if(!n.progress)return 0;const y=n.duration*n.progress/100,h=n.segments;let o=0,k=0,b=null;do{const F=h[k];k===N&&(o>y?b=0:b=Math.min((y-o)/F.duration,1)*100),o+=F.duration,k++}while(b===null&&k<h.length);return b||0}return c.jsx("div",{className:"wx-segments wx-GKbcLEGA",children:n.segments.map((N,y)=>c.jsxs("div",{className:`wx-segment wx-bar wx-${r} wx-GKbcLEGA`,"data-segment":y,style:i(y),children:[n.progress?c.jsx("div",{className:"wx-progress-wrapper",children:c.jsx("div",{className:"wx-progress-percent wx-GKbcLEGA",style:{width:`${l(y)}%`}})}):null,c.jsx("div",{className:"wx-content",children:N.text||""})]},y))})}let Ye=[],Ze=null,ht=null;const mt=(s,n)=>{if(!n||!n.start)return null;const{start:r,lengthUnitWidth:i,lengthUnit:l}=n,N=864e5,y=l==="week"?7:l==="month"?30:l==="quarter"?91:l==="year"?365:1,h=Math.floor(s/i),o=new Date(r.getTime()+h*y*N);return o.setUTCHours(0,0,0,0),console.log("[pixelToDate]",{px:s,units:h,scalesStart:r.toISOString(),result:o.toISOString()}),o},At=(s,n,r)=>{if(!r||!s||!n)return 0;const{lengthUnit:i}=r,y=(i==="week"?7:i==="month"?30:i==="quarter"?91:i==="year"?365:1)*864e5;return Math.round((s.getTime()-n.getTime())/y)},zt=(s,n,r)=>{if(!r||!s)return console.log("[addCells] early return:",{scales:!!r,date:s?.toISOString?.()}),s;const{lengthUnit:i}=r,y=(i==="week"?7:i==="month"?30:i==="quarter"?91:i==="year"?365:1)*864e5,h=new Date(s.getTime()+n*y);return h.setUTCHours(0,0,0,0),console.log("[addCells]",{date:s.toISOString(),cells:n,lengthUnit:i,result:h.toISOString()}),h},Gt=(s,n,r,i)=>s<i&&n>r;function Ut(s){const{readonly:n,taskTemplate:r,multiTaskRows:i=!1,rowMapping:l=null,marqueeSelect:N=!1,copyPaste:y=!1,allowTaskIntersection:h=!0}=s,o=e.useContext(He),[k,b]=R.useStoreWithCounter(o,"_tasks"),[F,z]=R.useStoreWithCounter(o,"_links"),H=R.useStore(o,"area"),P=R.useStore(o,"_scales"),d=R.useStore(o,"taskTypes"),S=e.useMemo(()=>{if(!P||!P.start)return P;const t=new Date(Date.UTC(P.start.getFullYear(),P.start.getMonth(),P.start.getDate())),u=t.getUTCDay(),f=u===0?-6:1-u,m=new Date(t.getTime()+f*864e5);return m.setUTCHours(0,0,0,0),console.log("[scales-normalize]",{raw:P.start.toISOString(),utc:t.toISOString(),dayOfWeek:u,daysToMonday:f,monday:m.toISOString()}),{...P,start:m}},[P]),te=R.useStore(o,"baselines"),[I,V]=R.useStoreWithCounter(o,"_selected"),j=R.useStore(o,"_scrollTask"),O=R.useStore(o,"criticalPath"),T=R.useStore(o,"tasks"),re=R.useStore(o,"schedule"),Z=R.useStore(o,"splitTasks"),ce=e.useMemo(()=>{if(!H||!Array.isArray(k))return[];const t=H.start??0,u=H.end??0;return i&&l?k.map(f=>({...f})):k.slice(t,u).map(f=>({...f}))},[b,H,i,l]),G=R.useStore(o,"cellHeight"),we=e.useMemo(()=>{if(!i||!l||!ce.length)return ce;const t=new Map,u=[];return k.forEach(f=>{const m=l.taskRows.get(f.id)??f.id;t.has(m)||(t.set(m,u.length),u.push(m))}),ce.map(f=>{const m=l.taskRows.get(f.id)??f.id,E=t.get(m)??0;return{...f,$y:E*G,$y_base:f.$y_base!==void 0?E*G:void 0}})},[ce,i,l,k,G]),U=e.useMemo(()=>S.lengthUnitWidth,[S]),W=e.useMemo(()=>S.lengthUnit||"day",[S]),w=e.useRef(!1),[M,se]=e.useState(void 0),[B,ie]=e.useState(null),oe=e.useRef(null),[he,De]=e.useState(null),[$e,Ee]=e.useState(void 0),Re=e.useRef(null),[Ce,Ie]=e.useState(0),[Q,p]=e.useState(null),_=e.useRef(null),[X,A]=e.useState(null),[J,me]=e.useState(null),[ne,v]=e.useState(null),K=e.useRef(null);K.current=J;const ue=e.useRef(200),x=e.useRef(null),ee=e.useMemo(()=>{const t=x.current;return!!(I.length&&t&&t.contains(document.activeElement))},[I,x.current]),fe=e.useMemo(()=>ee&&I[I.length-1]?.id,[ee,I]);e.useEffect(()=>{if(j&&ee&&j){const{id:t}=j,u=x.current?.querySelector(`.wx-bar[data-id='${t}']`);u&&u.focus({preventScroll:!0})}},[j]),e.useEffect(()=>{const t=x.current;if(t&&(Ie(t.offsetWidth||0),typeof ResizeObserver<"u")){const u=new ResizeObserver(f=>{f[0]&&Ie(f[0].contentRect.width)});return u.observe(t),()=>u.disconnect()}},[x.current]);const q=e.useCallback(()=>{document.body.style.userSelect="none"},[]),Te=e.useCallback(()=>{document.body.style.userSelect=""},[]),je=e.useCallback((t,u,f)=>{if(u.target.classList.contains("wx-line")||(f||(f=o.getTask(ze(t))),f.type==="milestone"||f.type==="summary"))return"";const m=Se.locate(u,"data-segment");m&&(t=m);const{left:E,width:D}=t.getBoundingClientRect(),C=(u.clientX-E)/D;let L=.2/(D>200?D/200:1);return C<L?"start":C>1-L?"end":""},[o]),ae=e.useMemo(()=>{const t=new Set;if(h||!i||!l)return t;const u=new Map;return k.forEach(f=>{if(f.type==="summary"||f.type==="milestone")return;const m=l.taskRows.get(f.id)??f.id;u.has(m)||u.set(m,[]),u.get(m).push(f)}),u.forEach(f=>{if(!(f.length<2))for(let m=0;m<f.length;m++)for(let E=m+1;E<f.length;E++){const D=f[m],C=f[E],L=D.$x,le=D.$x+D.$w,pe=C.$x,ve=C.$x+C.$w;Gt(L,le,pe,ve)&&(t.add(D.id),t.add(C.id))}}),t},[h,i,l,k,b]),ye=e.useMemo(()=>{const t=new Map;if(!i||!l)return k.forEach(m=>{t.set(m.id,m.$y)}),t;const u=new Map,f=[];return k.forEach(m=>{const E=l.taskRows.get(m.id)??m.id;u.has(E)||(u.set(E,f.length),f.push(E))}),k.forEach(m=>{const E=l.taskRows.get(m.id)??m.id,D=u.get(E)??0;t.set(m.id,D*G)}),t},[k,i,l,G]),xe=e.useMemo(()=>{const t=new Map;if(!i||!l)return k.forEach(m=>{t.set(m.id,m.$y),m.row!==void 0&&t.set(m.row,m.$y)}),t;const u=new Map,f=[];return k.forEach(m=>{const E=l.taskRows.get(m.id)??m.id;u.has(E)||(u.set(E,f.length),f.push(E))}),u.forEach((m,E)=>{t.set(E,m*G)}),t},[k,i,l,G]),Ne=e.useCallback(t=>{if(!x.current)return[];const f=Math.min(t.startX,t.currentX),m=Math.max(t.startX,t.currentX),E=Math.min(t.startY,t.currentY),D=Math.max(t.startY,t.currentY);return k.filter(C=>{const L=C.$x,le=C.$x+C.$w,ve=ye.get(C.id)??C.$y,Pe=ve+C.$h;return L<m&&le>f&&ve<D&&Pe>E})},[k,ye]),Oe=e.useMemo(()=>new Set(I.map(t=>t.id)),[I,V]),a=e.useCallback(t=>Oe.has(t),[Oe]),g=e.useCallback((t,u)=>{const{clientX:f}=u,m=ze(t),E=o.getTask(m),D=u.target.classList;if(!u.target.closest(".wx-delete-button")&&!n){if(D.contains("wx-progress-marker")){const{progress:C}=o.getTask(m);oe.current={id:m,x:f,progress:C,dx:0,node:t,marker:u.target},u.target.classList.add("wx-progress-in-drag")}else{const C=je(t,u,E)||"move",L={id:m,mode:C,x:f,dx:0,l:E.$x,w:E.$w};if(Z&&E.segments?.length){const le=Se.locate(u,"data-segment");le&&(L.segmentIndex=le.dataset.segment*1,ke.extendDragOptions(E,L))}ie(L)}q()}},[o,n,je,q,Z]),$=e.useCallback(t=>{if(t.button!==0||ne)return;const u=Se.locate(t);if(!u&&N&&!n){const f=x.current;if(!f)return;const m=f.getBoundingClientRect(),E=t.clientX-m.left,D=t.clientY-m.top;if(y){const L=mt(E,S);L&&(K.current=L,me(L))}const C={startX:E,startY:D,currentX:E,currentY:D,ctrlKey:t.ctrlKey||t.metaKey};p(C),_.current=C,q();return}if(u){if(N&&!n&&I.length>1){const f=ze(u);if(a(f)){const m=t.target.classList;if(!m.contains("wx-link")&&!m.contains("wx-progress-marker")&&!t.target.closest(".wx-delete-button")){const E=o.getTask(f);if(!je(u,t,E)){const C=new Map;I.forEach(L=>{const le=o.getTask(L.id);if(le){if(re?.auto&&le.type==="summary")return;C.set(L.id,{$x:le.$x,$w:le.$w,start:le.start,end:le.end})}}),A({baseTaskId:f,startX:t.clientX,dx:0,originalPositions:C}),q();return}}}}g(u,t)}},[g,N,y,n,I,a,o,je,re,q,S,ne]),Y=e.useCallback(t=>{const u=Se.locate(t);u&&(Re.current=setTimeout(()=>{Ee(!0),g(u,t.touches[0])},300))},[g]),ge=e.useCallback(t=>{De(t&&{...F.find(u=>u.id===t)})},[F]),de=e.useCallback(()=>{const t=_.current;if(t){const u=Ne(t);t.ctrlKey?u.forEach(f=>{o.exec("select-task",{id:f.id,toggle:!0,marquee:!0})}):(I.length>0&&o.exec("select-task",{id:null,marquee:!0}),u.forEach((f,m)=>{o.exec("select-task",{id:f.id,toggle:m>0,marquee:!0})})),p(null),_.current=null,Te(),w.current=!0;return}if(X){const{dx:u,originalPositions:f}=X,m=Math.round(u/U);if(m!==0){let E=!0;f.forEach((D,C)=>{const L=o.getTask(C);L&&(o.exec("update-task",{id:C,diff:m,task:{start:L.start,end:L.end},skipUndo:!E}),E=!1)}),w.current=!0}else f.forEach((E,D)=>{o.exec("drag-task",{id:D,left:E.$x,width:E.$w,inProgress:!1})});A(null),Te();return}if(oe.current){const{dx:u,id:f,marker:m,value:E}=oe.current;oe.current=null,typeof E<"u"&&u&&o.exec("update-task",{id:f,task:{progress:E},inProgress:!1}),m.classList.remove("wx-progress-in-drag"),w.current=!0,Te()}else if(B){const{id:u,mode:f,dx:m,l:E,w:D,start:C,segment:L,index:le}=B;if(ie(null),C){const pe=Math.round(m/U);if(!pe)o.exec("drag-task",{id:u,width:D,left:E,inProgress:!1,...L&&{segmentIndex:le}});else{let ve={},Pe=o.getTask(u);L&&(Pe=Pe.segments[le]);const Ge=1440*60*1e3,Le=pe*(W==="week"?7:W==="month"?30:W==="quarter"?91:W==="year"?365:1)*Ge;f==="move"?(ve.start=new Date(Pe.start.getTime()+Le),ve.end=new Date(Pe.end.getTime()+Le)):f==="start"?(ve.start=new Date(Pe.start.getTime()+Le),ve.end=Pe.end):f==="end"&&(ve.start=Pe.start,ve.end=new Date(Pe.end.getTime()+Le)),o.exec("update-task",{id:u,task:ve,...L&&{segmentIndex:le}})}w.current=!0}Te()}},[o,Te,B,U,W,Q,X,Ne,I]),Me=e.useCallback((t,u)=>{const{clientX:f,clientY:m}=u,E=x.current;if(E){const D=E.getBoundingClientRect();ue.current=f-D.left}if(ne){if(!E)return;const D=E.getBoundingClientRect(),C=f-D.left;v(L=>({...L,currentX:C}));return}if(!n){if(Q){const D=x.current;if(!D)return;const C=D.getBoundingClientRect(),L=f-C.left,le=m-C.top;p(pe=>({...pe,currentX:L,currentY:le})),_.current&&(_.current.currentX=L,_.current.currentY=le);return}if(X){const D=f-X.startX;X.originalPositions.forEach((C,L)=>{const le=C.$x+D;o.exec("drag-task",{id:L,left:le,width:C.$w,inProgress:!0})}),A(C=>({...C,dx:D}));return}if(oe.current){const{node:D,x:C,id:L}=oe.current,le=oe.current.dx=f-C,pe=Math.round(le/D.offsetWidth*100);let ve=oe.current.progress+pe;oe.current.value=ve=Math.min(Math.max(0,ve),100),o.exec("update-task",{id:L,task:{progress:ve},inProgress:!0})}else if(B){ge(null);const{mode:D,l:C,w:L,x:le,id:pe,start:ve,segment:Pe,index:Ge}=B,Ae=o.getTask(pe),Le=f-le;if(!ve&&Math.abs(Le)<20||D==="start"&&L-Le<U||D==="end"&&L+Le<U||D==="move"&&(Le<0&&C+Le<0||Le>0&&C+L+Le>Ce)||B.segment&&!ke.isSegmentMoveAllowed(Ae,B))return;const Ke={...B,dx:Le};let Ue,qe;if(D==="start"?(Ue=C+Le,qe=L-Le):D==="end"?(Ue=C,qe=L+Le):D==="move"&&(Ue=C+Le,qe=L),o.exec("drag-task",{id:pe,width:qe,left:Ue,inProgress:!0,...Pe&&{segmentIndex:Ge}}),!Ke.start&&(D==="move"&&Ae.$x==C||D!=="move"&&Ae.$w==L)){w.current=!0,de();return}Ke.start=!0,ie(Ke)}else{const D=Se.locate(t);if(D){const C=o.getTask(ze(D)),le=Se.locate(t,"data-segment")||D,pe=je(le,u,C);le.style.cursor=pe&&!n?"col-resize":"pointer"}}}},[o,n,B,U,Ce,je,ge,de,Q,X,ne]),We=e.useCallback(t=>{Me(t,t)},[Me]),bt=e.useCallback(t=>{$e?(t.preventDefault(),Me(t,t.touches[0])):Re.current&&(clearTimeout(Re.current),Re.current=null)},[$e,Me]),Ve=e.useCallback(()=>{de()},[de]),yt=e.useCallback(()=>{Ee(null),Re.current&&(clearTimeout(Re.current),Re.current=null),de()},[de]);e.useEffect(()=>(window.addEventListener("mouseup",Ve),()=>{window.removeEventListener("mouseup",Ve)}),[Ve]);const Tt=e.useCallback(t=>{if(!n){const u=Se.locateID(t.target);if(u&&!t.target.classList.contains("wx-link")){const f=Se.locateID(t.target,"data-segment");o.exec("show-editor",{id:u,...f!==null&&{segmentIndex:f}})}}},[o,n]),Ct=["e2s","s2s","e2e","s2e"],Xe=e.useCallback((t,u)=>Ct[(t?1:0)+(u?0:2)],[]),Fe=e.useCallback((t,u)=>{const f=M.id,m=M.start;return t===f?!0:!!F.find(E=>E.target==t&&E.source==f&&E.type===Xe(m,u))},[M,z,Xe]),et=e.useCallback(()=>{M&&se(null)},[M]),tt=e.useCallback((t,u,f)=>{if(!u.length||!t||f==null)return;console.log("[paste] executePaste called:",{targetDate:t.toISOString(),taskCount:u.length,parent:f});const m=864e5,E=o.getHistory();E?.startBatch();const D=new Date(t);D.setUTCHours(0,0,0,0),console.log("[paste] scalesValue:",{start:S?.start?.toISOString?.(),lengthUnit:S?.lengthUnit,lengthUnitWidth:S?.lengthUnitWidth}),u.forEach((C,L)=>{const le=`task-${Date.now()}-${L}`;console.log("[paste] task input:",{text:C.text,_startCellOffset:C._startCellOffset,_startDayOfWeek:C._startDayOfWeek,_durationDays:C._durationDays,start:C.start?.toISOString?.(),end:C.end?.toISOString?.()});const pe=zt(D,C._startCellOffset||0,S);console.log("[paste] cellOffset:",pe?.toISOString?.());const ve=new Date(pe.getTime()+(C._startDayOfWeek||0)*m);ve.setUTCHours(0,0,0,0);const Pe=new Date(ve.getTime()+(C._durationDays||7)*m);Pe.setUTCHours(0,0,0,0),console.log("[paste] task calculated:",{text:C.text,newStart:ve.toISOString(),newEnd:Pe.toISOString(),row:C.row}),o.exec("add-task",{task:{id:le,text:C.text,start:ve,end:Pe,type:C.type||"task",parent:f,row:C.row},target:f,mode:"child",skipUndo:L>0})}),E?.endBatch()},[o,S]),St=e.useCallback(t=>{if(w.current){w.current=!1;return}if(ne&&ne.currentX!=null){const f=mt(ne.currentX,S);f&&tt(f,ne.tasks,ne.parent),v(null);return}const u=Se.locateID(t.target);if(u){const f=o.getTask(u),m=k.find(D=>D.id===u);console.log("[click] task:",f?.text,"id:",u),console.log("[click] api.getTask:",{start:f?.start,end:f?.end,duration:f?.duration}),console.log("[click] rendered:",{start:m?.start,end:m?.end,$w:m?.$w,$x:m?.$x});const E=t.target.classList;if(E.contains("wx-link")){const D=E.contains("wx-left");if(!M){se({id:u,start:D});return}M.id!==u&&!Fe(u,D)&&o.exec("add-link",{link:{source:M.id,target:u,type:Xe(M.start,D)}})}else if(E.contains("wx-delete-button-icon"))o.exec("delete-link",{id:he.id}),De(null);else{let D;const C=Se.locate(t,"data-segment");C&&(D=C.dataset.segment*1),o.exec("select-task",{id:u,toggle:t.ctrlKey||t.metaKey,range:t.shiftKey,segmentIndex:D})}}et()},[o,M,z,he,Fe,Xe,et,ne,S,tt]),vt=e.useCallback(t=>({left:`${t.$x}px`,top:`${t.$y}px`,width:`${t.$w}px`,height:`${t.$h}px`}),[]),Mt=e.useCallback(t=>({left:`${t.$x_base}px`,top:`${t.$y_base}px`,width:`${t.$w_base}px`,height:`${t.$h_base}px`}),[]),Et=e.useCallback(t=>{if($e||Re.current)return t.preventDefault(),!1},[$e]),st=e.useMemo(()=>d.map(t=>t.id),[d]),nt=e.useCallback(t=>{let u=st.includes(t)?t:"task";return["task","milestone","summary"].includes(t)||(u=`task ${u}`),u},[st]),rt=e.useCallback(t=>{o.exec(t.action,t.data)},[o]),Qe=e.useCallback(t=>O&&T.byId(t).$critical,[O,T]),ot=e.useCallback(t=>{if(re?.auto){const u=T.getSummaryId(t,!0),f=T.getSummaryId(M.id,!0);return M?.id&&!(Array.isArray(u)?u:[u]).includes(M.id)&&!(Array.isArray(f)?f:[f]).includes(t)}return M},[re,T,M]),lt=e.useCallback(()=>{const t=o.getState()._selected;if(!t||!t.length)return;const u=864e5,f=t.map(L=>{const le=o.getTask(L.id);if(!le)return null;const pe=k.find($t=>$t.id===L.id);if(!pe)return null;const{$x:ve,$y:Pe,$h:Ge,$w:Ae,$skip:Le,$level:Ke,$index:Ue,$y_base:qe,$x_base:ms,$w_base:gs,$h_base:ws,$skip_baseline:ps,$critical:ks,$reorder:bs,...Rt}=pe,it=pe.end&&pe.start?Math.round((pe.end.getTime()-pe.start.getTime())/u):0,at=pe.start?(pe.start.getUTCDay()+6)%7:0;return console.log("[copy] task:",{id:le.id,text:le.text,start:pe.start?.toISOString?.(),end:pe.end?.toISOString?.(),durationDays:it,startDayOfWeek:at,$w:Ae,$h:Ge,row:pe.row,parent:pe.parent}),{...Rt,_durationDays:it,_startDayOfWeek:at,_originalWidth:Ae,_originalHeight:Ge}}).filter(Boolean);if(!f.length)return;const E=f[0].parent,D=f.filter(L=>L.parent===E);if(D.length===0)return;const C=D.reduce((L,le)=>le.start&&(!L||le.start<L)?le.start:L,null);Ye=D.map(L=>({...L,_startCellOffset:At(L.start,C,S)})),ht=E,Ze=C,console.log("[copy] clipboard stored:",{taskCount:Ye.length,baseDate:C?.toISOString?.(),parent:E,tasks:Ye.map(L=>({id:L.id,text:L.text,_startCellOffset:L._startCellOffset,_startDayOfWeek:L._startDayOfWeek,_durationDays:L._durationDays}))})},[o,S]);e.useEffect(()=>y?o.intercept("hotkey",u=>{if(u.key==="ctrl+c"||u.key==="meta+c")return lt(),!1;if(u.key==="ctrl+v"||u.key==="meta+v")return!Ye.length||!Ze||v({tasks:Ye,baseDate:Ze,parent:ht,currentX:ue.current}),!1}):void 0,[y,o,lt]),e.useEffect(()=>{if(!ne)return;const t=u=>{u.key==="Escape"&&(u.preventDefault(),u.stopPropagation(),v(null))};return document.addEventListener("keydown",t,!0),()=>document.removeEventListener("keydown",t,!0)},[ne]);const ct=e.useMemo(()=>{if(!Q)return null;const t=Math.min(Q.startX,Q.currentX),u=Math.min(Q.startY,Q.currentY),f=Math.abs(Q.currentX-Q.startX),m=Math.abs(Q.currentY-Q.startY);return{left:`${t}px`,top:`${u}px`,width:`${f}px`,height:`${m}px`}},[Q]);return c.jsxs("div",{className:"wx-GKbcLEGA wx-bars",style:{lineHeight:`${we.length?we[0].$h:0}px`},ref:x,onContextMenu:Et,onMouseDown:$,onMouseMove:We,onTouchStart:Y,onTouchMove:bt,onTouchEnd:yt,onClick:St,onDoubleClick:Tt,onDragStart:t=>(t.preventDefault(),!1),children:[c.jsx(_t,{onSelectLink:ge,selectedLink:he,readonly:n}),we.map(t=>{if(t.$skip&&t.$skip_baseline)return null;const u=ae.has(t.id),f=`wx-bar wx-${nt(t.type)}`+(t.$css?` ${t.$css}`:"")+($e&&B&&t.id===B.id?" wx-touch":"")+(M&&M.id===t.id?" wx-selected":"")+(Oe.has(t.id)?" wx-selected":"")+(Qe(t.id)?" wx-critical":"")+(t.$reorder?" wx-reorder-task":"")+(Z&&t.segments?" wx-split":"")+(u?" wx-collision":""),m="wx-link wx-left"+(M?" wx-visible":"")+(!M||!Fe(t.id,!0)&&ot(t.id)?" wx-target":"")+(M&&M.id===t.id&&M.start?" wx-selected":"")+(Qe(t.id)?" wx-critical":""),E="wx-link wx-right"+(M?" wx-visible":"")+(!M||!Fe(t.id,!1)&&ot(t.id)?" wx-target":"")+(M&&M.id===t.id&&!M.start?" wx-selected":"")+(Qe(t.id)?" wx-critical":"");return c.jsxs(e.Fragment,{children:[!t.$skip&&c.jsxs("div",{className:"wx-GKbcLEGA "+f,style:vt(t),"data-tooltip-id":t.id,"data-id":t.id,tabIndex:fe===t.id?0:-1,children:[n?null:t.id===he?.target&&he?.type[2]==="s"?c.jsx(be.Button,{type:"danger",css:"wx-left wx-delete-button wx-delete-link",children:c.jsx("i",{className:"wxi-close wx-delete-button-icon"})}):c.jsx("div",{className:"wx-GKbcLEGA "+m,children:c.jsx("div",{className:"wx-GKbcLEGA wx-inner"})}),t.type!=="milestone"?c.jsxs(c.Fragment,{children:[t.progress&&!(Z&&t.segments)?c.jsx("div",{className:"wx-GKbcLEGA wx-progress-wrapper",children:c.jsx("div",{className:"wx-GKbcLEGA wx-progress-percent",style:{width:`${t.progress}%`}})}):null,!n&&!(Z&&t.segments)?c.jsx("div",{className:"wx-GKbcLEGA wx-progress-marker",style:{left:`calc(${t.progress}% - 10px)`},children:t.progress}):null,r?c.jsx(r,{data:t,api:o,onAction:rt}):Z&&t.segments?c.jsx(Ht,{task:t,type:nt(t.type)}):c.jsx("div",{className:"wx-GKbcLEGA wx-content",children:t.$barText||t.text||""}),u&&c.jsx("div",{className:"wx-GKbcLEGA wx-collision-warning",title:"This task overlaps with another task in the same row",children:"!"})]}):c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"wx-GKbcLEGA wx-content"}),r?c.jsx(r,{data:t,api:o,onAction:rt}):c.jsx("div",{className:"wx-GKbcLEGA wx-text-out",children:t.$barText||t.text})]}),n?null:t.id===he?.target&&he?.type[2]==="e"?c.jsx(be.Button,{type:"danger",css:"wx-right wx-delete-button wx-delete-link",children:c.jsx("i",{className:"wxi-close wx-delete-button-icon"})}):c.jsx("div",{className:"wx-GKbcLEGA "+E,children:c.jsx("div",{className:"wx-GKbcLEGA wx-inner"})})]}),te&&!t.$skip_baseline?c.jsx("div",{className:"wx-GKbcLEGA wx-baseline"+(t.type==="milestone"?" wx-milestone":""),style:Mt(t)}):null]},t.id)}),Q&&ct&&c.jsx("div",{className:"wx-GKbcLEGA wx-marquee-selection",style:ct}),ne&&ne.currentX!=null&&ne.tasks.map((t,u)=>{const m=(Math.floor(ne.currentX/U)+(t._startCellOffset||0))*U,E=t._originalWidth||U,D=t._originalHeight||G,C=xe.get(t.row)??(t.$y||0);return c.jsx("div",{className:"wx-GKbcLEGA wx-bar wx-task wx-paste-preview",style:{left:m,top:C,width:E,height:D},children:c.jsx("div",{className:"wx-GKbcLEGA wx-content",children:t.$barText||t.text})},`preview-${u}`)})]})}function qt(s){const{highlightTime:n,onScaleClick:r}=s,i=e.useContext(He),l=R.useStore(i,"_scales");return c.jsx("div",{className:"wx-ZkvhDKir wx-scale",style:{width:l.width},children:(l?.rows||[]).map((N,y)=>c.jsx("div",{className:"wx-ZkvhDKir wx-row",style:{height:`${N.height}px`},children:(N.cells||[]).map((h,o)=>{const k=n?n(h.date,h.unit):"",b="wx-cell "+(h.css||"")+" "+(k||""),F=typeof h.value=="string"&&h.value.includes("<");return c.jsx("div",{className:"wx-ZkvhDKir "+b,style:{width:`${h.width}px`,cursor:r?"pointer":void 0},onClick:r?z=>r(h.date,h.unit,z.nativeEvent):void 0,...F?{dangerouslySetInnerHTML:{__html:h.value}}:{children:h.value}},o)})},y))})}const Yt=new Map;function Xt(s){const n=e.useRef(null),r=e.useRef(0),i=e.useRef(null),l=typeof window<"u"&&window.__RENDER_METRICS_ENABLED__;n.current===null&&(n.current=performance.now()),r.current++,e.useEffect(()=>{if(l)return cancelAnimationFrame(i.current),i.current=requestAnimationFrame(()=>{const N={label:s,time:performance.now()-n.current,renders:r.current,timestamp:Date.now()};Yt.set(s,N),window.dispatchEvent(new CustomEvent("render-metric",{detail:N}))}),()=>cancelAnimationFrame(i.current)})}function Ft(s){const{readonly:n,fullWidth:r,fullHeight:i,taskTemplate:l,cellBorders:N,highlightTime:y,onScaleClick:h,multiTaskRows:o=!1,rowMapping:k=null,marqueeSelect:b=!1,copyPaste:F=!1,scrollToCurrentWeek:z=!1,currentWeekColor:H=null,allowTaskIntersection:P=!0}=s,d=e.useContext(He),[S,te]=R.useStoreWithCounter(d,"_selected"),I=R.useStore(d,"scrollTop"),V=R.useStore(d,"cellHeight"),j=R.useStore(d,"cellWidth"),O=R.useStore(d,"_scales"),T=R.useStore(d,"_markers"),re=R.useStore(d,"_scrollTask"),Z=R.useStore(d,"zoom"),ce=R.useStore(d,"_tasks"),[G,we]=e.useState(),U=e.useRef(null),W=e.useRef(0),w=e.useRef(!1),M=1+(O?.rows?.length||0),se=e.useMemo(()=>{if(!o||!k||!ce?.length)return null;const p=new Map,_=new Map,X=[];return ce.forEach(A=>{const J=k.taskRows.get(A.id)??A.id;_.has(J)||(_.set(J,X.length),X.push(J))}),ce.forEach(A=>{const J=k.taskRows.get(A.id)??A.id,me=_.get(J)??0;p.set(A.id,me*V)}),p},[ce,o,k,V]),B=e.useMemo(()=>{const p=[];return S&&S.length&&V&&S.forEach(_=>{const X=se?.get(_.id)??_.$y;p.push({height:`${V}px`,top:`${X-3}px`})}),p},[te,V,se]),ie=e.useMemo(()=>Math.max(G||0,i),[G,i]);e.useEffect(()=>{const p=U.current;p&&typeof I=="number"&&(p.scrollTop=I)},[I]);const oe=()=>{he()};function he(p){const _=U.current;if(!_)return;const X={};X.left=_.scrollLeft,d.exec("scroll-chart",X)}function De(){const p=U.current,X=Math.ceil((G||0)/(V||1))+1,A=Math.floor((p&&p.scrollTop||0)/(V||1)),J=Math.max(0,A-M),me=A+X+M,ne=J*(V||0);d.exec("render-data",{start:J,end:me,from:ne})}e.useEffect(()=>{De()},[G,I]);const $e=e.useCallback(p=>{if(!p)return;const{id:_,mode:X}=p;if(X.toString().indexOf("x")<0)return;const A=U.current;if(!A)return;const{clientWidth:J}=A,me=d.getTask(_);if(me.$x+me.$w<A.scrollLeft)d.exec("scroll-chart",{left:me.$x-(j||0)}),A.scrollLeft=me.$x-(j||0);else if(me.$x>=J+A.scrollLeft){const ne=J<me.$w?j||0:me.$w;d.exec("scroll-chart",{left:me.$x-J+ne}),A.scrollLeft=me.$x-J+ne}},[d,j]);e.useEffect(()=>{$e(re)},[re]);function Ee(p){if(Z&&(p.ctrlKey||p.metaKey)){p.preventDefault();const _=U.current,X=p.clientX-(_?_.getBoundingClientRect().left:0);if(W.current+=p.deltaY,Math.abs(W.current)>=150){const J=-Math.sign(W.current);W.current=0,d.exec("zoom-scale",{dir:J,offset:X})}}}const Re=e.useCallback(p=>{const _=y(p.date,p.unit);return _?{css:_,width:p.width}:null},[y]),Ce=e.useMemo(()=>{if(!O||!y||!["hour","day","week"].includes(O.minUnit))return null;let _=0;return O.rows[O.rows.length-1].cells.map(X=>{const A=Re(X),J=_;return _+=X.width,A?{...A,left:J}:null})},[O,y,Re]),Ie=e.useCallback(p=>{p.eventSource="chart",d.exec("hotkey",p)},[d]);e.useEffect(()=>{const p=U.current;if(!p)return;const _=()=>we(p.clientHeight);_();const X=new ResizeObserver(()=>_());return X.observe(p),()=>{X.disconnect()}},[U.current]);const Q=e.useRef(null);return e.useEffect(()=>{const p=U.current;if(p&&!Q.current)return Q.current=gt.hotkeys(p,{keys:{arrowup:!0,arrowdown:!0},exec:_=>Ie(_)}),()=>{Q.current?.destroy(),Q.current=null}},[]),e.useEffect(()=>{const p=U.current;if(!p)return;const _=Ee;return p.addEventListener("wheel",_),()=>{p.removeEventListener("wheel",_)}},[Ee]),e.useEffect(()=>{if(!z||w.current||!O||!U.current||!G)return;const p=U.current,{clientWidth:_}=p,X=new Date,A=O.rows[O.rows.length-1]?.cells;if(!A)return;let J=-1,me=0;const ne=[];for(let K=0;K<A.length;K++){const ue=A[K];ne.push({left:me,width:ue.width});const x=ue.date;if(ue.unit==="week"){const ee=new Date(x);ee.setUTCDate(ee.getUTCDate()+7),X>=x&&X<ee&&(J=K)}else ue.unit==="day"&&X.getUTCFullYear()===x.getUTCFullYear()&&X.getUTCMonth()===x.getUTCMonth()&&X.getUTCDate()===x.getUTCDate()&&(J=K);me+=ue.width}let v=J;if(J>0&&(v=J-1),v>=0&&ne[v]){const K=ne[v],ue=Math.max(0,K.left);p.scrollLeft=ue,d.exec("scroll-chart",{left:ue}),w.current=!0}},[z,O,G,d]),Xt("chart"),c.jsxs("div",{className:"wx-mR7v2Xag wx-chart",tabIndex:-1,ref:U,onScroll:oe,children:[c.jsx(qt,{highlightTime:y,onScaleClick:h,scales:O}),T&&T.length?c.jsx("div",{className:"wx-mR7v2Xag wx-markers",style:{height:`${ie}px`},children:T.map((p,_)=>c.jsx("div",{className:`wx-mR7v2Xag wx-marker ${p.css||""}`,style:{left:`${p.left}px`},children:c.jsx("div",{className:"wx-mR7v2Xag wx-content",children:p.text})},_))}):null,c.jsxs("div",{className:"wx-mR7v2Xag wx-area",style:{width:`${r}px`,height:`${ie}px`},children:[Ce?c.jsx("div",{className:"wx-mR7v2Xag wx-gantt-holidays",style:{height:"100%"},children:Ce.map((p,_)=>p?c.jsx("div",{className:"wx-mR7v2Xag "+p.css,style:{width:`${p.width}px`,left:`${p.left}px`}},_):null)}):null,c.jsx(Wt,{borders:N}),S&&S.length?S.map((p,_)=>p.$y?c.jsx("div",{className:"wx-mR7v2Xag wx-selected","data-id":p.id,style:B[_]},p.id):null):null,c.jsx(Ut,{readonly:n,taskTemplate:l,multiTaskRows:o,rowMapping:k,marqueeSelect:b,copyPaste:F,allowTaskIntersection:P})]})]})}function Kt(s){const{position:n="after",size:r=4,dir:i="x",onMove:l,onDisplayChange:N,compactMode:y,containerWidth:h=0,leftThreshold:o=50,rightThreshold:k=50}=s,[b,F]=R.useWritableProp(s.value??0),[z,H]=R.useWritableProp(s.display??"all");function P(ie){let oe=0;n=="center"?oe=r/2:n=="before"&&(oe=r);const he={size:[r+"px","auto"],p:[ie-oe+"px","0px"],p2:["auto","0px"]};if(i!="x")for(let De in he)he[De]=he[De].reverse();return he}const[d,S]=e.useState(!1),[te,I]=e.useState(null),V=e.useRef(0),j=e.useRef(),O=e.useRef(),T=e.useRef(z);e.useEffect(()=>{T.current=z},[z]),e.useEffect(()=>{te===null&&b>0&&I(b)},[te,b]);function re(ie){return i=="x"?ie.clientX:ie.clientY}const Z=e.useCallback(ie=>{const oe=j.current+re(ie)-V.current;F(oe);let he;oe<=o?he="chart":h-oe<=k?he="grid":he="all",T.current!==he&&(H(he),T.current=he),O.current&&clearTimeout(O.current),O.current=setTimeout(()=>l&&l(oe),100)},[h,o,k,l]),ce=e.useCallback(()=>{document.body.style.cursor="",document.body.style.userSelect="",S(!1),window.removeEventListener("mousemove",Z),window.removeEventListener("mouseup",ce)},[Z]),G=e.useMemo(()=>z!=="all"?"auto":i=="x"?"ew-resize":"ns-resize",[z,i]),we=e.useCallback(ie=>{!y&&(z==="grid"||z==="chart")||(V.current=re(ie),j.current=b,S(!0),document.body.style.cursor=G,document.body.style.userSelect="none",window.addEventListener("mousemove",Z),window.addEventListener("mouseup",ce))},[G,Z,ce,b,y,z]);function U(){H("all"),te!==null&&(F(te),l&&l(te))}function W(ie){if(y){const oe=z==="chart"?"grid":"chart";H(oe),N(oe)}else if(z==="grid"||z==="chart")U(),N("all");else{const oe=ie==="left"?"chart":"grid";H(oe),N(oe)}}function w(){W("left")}function M(){W("right")}const se=e.useMemo(()=>P(b),[b,n,r,i]),B=["wx-resizer",`wx-resizer-${i}`,`wx-resizer-display-${z}`,d?"wx-resizer-active":""].filter(Boolean).join(" ");return c.jsxs("div",{className:"wx-pFykzMlT "+B,onMouseDown:we,style:{width:se.size[0],height:se.size[1],cursor:G},children:[c.jsxs("div",{className:"wx-pFykzMlT wx-button-expand-box",children:[c.jsx("div",{className:"wx-pFykzMlT wx-button-expand-content wx-button-expand-left",children:c.jsx("i",{className:"wx-pFykzMlT wxi-menu-left",onClick:w})}),c.jsx("div",{className:"wx-pFykzMlT wx-button-expand-content wx-button-expand-right",children:c.jsx("i",{className:"wx-pFykzMlT wxi-menu-right",onClick:M})})]}),c.jsx("div",{className:"wx-pFykzMlT wx-resizer-line"})]})}const Bt=650;function pt(s){let n;function r(){n=new ResizeObserver(l=>{for(let N of l)if(N.target===document.body){let y=N.contentRect.width<=Bt;s(y)}}),n.observe(document.body)}function i(){n&&(n.disconnect(),n=null)}return{observe:r,disconnect:i}}function Vt(s){const{taskTemplate:n,readonly:r,cellBorders:i,highlightTime:l,onScaleClick:N,onTableAPIChange:y,multiTaskRows:h=!1,rowMapping:o=null,marqueeSelect:k=!1,copyPaste:b=!1,scrollToCurrentWeek:F=!1,currentWeekColor:z=null,allowTaskIntersection:H=!0}=s,P=e.useContext(He),d=R.useStore(P,"_tasks"),S=R.useStore(P,"_scales"),te=R.useStore(P,"cellHeight"),I=R.useStore(P,"columns"),V=R.useStore(P,"_scrollTask"),j=R.useStore(P,"undo"),O=e.useMemo(()=>{if(!h)return o;const v=new Map,K=new Map;return d.forEach(ue=>{const x=ue.row??ue.id;K.set(ue.id,x),v.has(x)||v.set(x,[]),v.get(x).push(ue.id)}),{rowMap:v,taskRows:K}},[d,h,o]),[T,re]=e.useState(!1);let[Z,ce]=e.useState(0);const[G,we]=e.useState(0),[U,W]=e.useState(0),[w,M]=e.useState(void 0),[se,B]=e.useState("all"),ie=e.useRef(null),oe=e.useCallback(v=>{re(K=>(v!==K&&(v?(ie.current=se,se==="all"&&B("grid")):(!ie.current||ie.current==="all")&&B("all")),v))},[se]);e.useEffect(()=>{const v=pt(oe);return v.observe(),()=>{v.disconnect()}},[oe]);const he=e.useMemo(()=>{let v;return I.every(K=>K.width&&!K.flexgrow)?v=I.reduce((K,ue)=>K+parseInt(ue.width),0):T&&se==="chart"?v=parseInt(I.find(K=>K.id==="action")?.width)||50:v=440,Z=v,v},[I,T,se]);e.useEffect(()=>{ce(he)},[he]);const De=e.useMemo(()=>(G??0)-(w??0),[G,w]),$e=e.useMemo(()=>S.width,[S]),Ee=e.useMemo(()=>{if(!h||!O)return d.length*te;const v=new Set;return d.forEach(K=>{const ue=O.taskRows.get(K.id)??K.id;v.add(ue)}),v.size*te},[d,te,h,O]),Re=e.useMemo(()=>S.height+Ee+De,[S,Ee,De]),Ce=e.useMemo(()=>Z+$e,[Z,$e]),Ie=e.useRef(null),Q=e.useCallback(()=>{Promise.resolve().then(()=>{if((G??0)>(Ce??0)){const v=(G??0)-Z;P.exec("expand-scale",{minWidth:v})}})},[G,Ce,Z,P]);e.useEffect(()=>{let v;return Ie.current&&(v=new ResizeObserver(Q),v.observe(Ie.current)),()=>{v&&v.disconnect()}},[Ie.current,Q]),e.useEffect(()=>{Q()},[$e]);const p=e.useRef(null),_=e.useRef(null),X=e.useCallback(()=>{const v=p.current;v&&P.exec("scroll-chart",{top:v.scrollTop})},[P]),A=e.useRef({rTasks:[],rScales:{height:0},rCellHeight:0,scrollSize:0,ganttDiv:null,ganttHeight:0});e.useEffect(()=>{A.current={rTasks:d,rScales:S,rCellHeight:te,scrollSize:De,ganttDiv:p.current,ganttHeight:U??0}},[d,S,te,De,U]);const J=e.useCallback(v=>{if(!v)return;const{rTasks:K,rScales:ue,rCellHeight:x,scrollSize:ee,ganttDiv:fe,ganttHeight:q}=A.current;if(!fe)return;const{id:Te}=v,je=K.findIndex(ae=>ae.id===Te);if(je>-1){const ae=q-ue.height,ye=je*x,xe=fe.scrollTop;let Ne=null;ye<xe?Ne=ye:ye+x>xe+ae&&(Ne=ye-ae+x+ee),Ne!==null&&(P.exec("scroll-chart",{top:Math.max(Ne,0)}),p.current.scrollTop=Math.max(Ne,0))}},[P]);e.useEffect(()=>{J(V)},[V]),e.useEffect(()=>{const v=p.current,K=_.current;if(!v||!K)return;const ue=()=>{Dt.flushSync(()=>{W(v.offsetHeight),we(v.offsetWidth),M(K.offsetWidth)})},x=new ResizeObserver(ue);return x.observe(v),()=>x.disconnect()},[p.current]);const me=e.useRef(null),ne=e.useRef(null);return e.useEffect(()=>{ne.current&&(ne.current.destroy(),ne.current=null);const v=me.current;if(v)return ne.current=gt.hotkeys(v,{keys:{"ctrl+c":!0,"ctrl+v":!0,"ctrl+x":!0,"ctrl+d":!0,"meta+c":!0,"meta+v":!0,"meta+x":!0,"meta+d":!0,backspace:!0,"ctrl+z":j,"ctrl+y":j,"meta+z":j,"meta+shift+z":j},exec:K=>{if(K.isInput)return;const ue=K.key;if(ue==="ctrl+z"||ue==="meta+z"){P.exec("undo",{});return}if(ue==="ctrl+y"||ue==="meta+shift+z"){P.exec("redo",{});return}P.exec("hotkey",K)}}),()=>{ne.current?.destroy(),ne.current=null}},[j]),c.jsx("div",{className:"wx-jlbQoHOz wx-gantt",ref:p,onScroll:X,children:c.jsx("div",{className:"wx-jlbQoHOz wx-pseudo-rows",style:{height:Re,width:"100%"},ref:_,children:c.jsx("div",{className:"wx-jlbQoHOz wx-stuck",style:{height:U,width:w},children:c.jsxs("div",{tabIndex:0,className:"wx-jlbQoHOz wx-layout",ref:me,children:[I.length?c.jsxs(c.Fragment,{children:[c.jsx(Ot,{display:se,compactMode:T,columnWidth:he,width:Z,readonly:r,fullHeight:Ee,onTableAPIChange:y,multiTaskRows:h,rowMapping:O}),c.jsx(Kt,{value:Z,display:se,compactMode:T,containerWidth:G,onMove:v=>ce(v),onDisplayChange:v=>B(v)})]}):null,c.jsx("div",{className:"wx-jlbQoHOz wx-content",ref:Ie,children:c.jsx(Ft,{readonly:r,fullWidth:$e,fullHeight:Ee,taskTemplate:n,cellBorders:i,highlightTime:l,onScaleClick:N,multiTaskRows:h,rowMapping:O,marqueeSelect:k,copyPaste:b,scrollToCurrentWeek:F,currentWeekColor:z,allowTaskIntersection:H})})]})})})})}function Qt(s){return{year:"%Y",quarter:`${s("Q")} %Q`,month:"%M",week:`${s("Week")} %w`,day:"%M %j",hour:"%H:%i"}}function Zt(s,n){return typeof s=="function"?s:Se.dateToString(s,n)}function kt(s,n){return s.map(({format:r,...i})=>({...i,format:Zt(r,n)}))}function Jt(s,n){const r=Qt(n);for(let i in r)r[i]=Se.dateToString(r[i],s);return r}function es(s,n){if(!s||!s.length)return s;const r=Se.dateToString("%d-%m-%Y",n);return s.map(i=>i.template?i:i.id==="start"||i.id=="end"?{...i,_template:l=>r(l),template:l=>r(l)}:i.id==="duration"?{...i,_template:l=>l,template:l=>l}:i)}function ts(s,n){return s.levels?{...s,levels:s.levels.map(r=>({...r,scales:kt(r.scales,n)}))}:s}const ss=s=>s.split("-").map(n=>n?n.charAt(0).toUpperCase()+n.slice(1):"").join(""),ns=[{unit:"month",step:1,format:"%F %Y"},{unit:"day",step:1,format:"%j"}],rs=e.forwardRef(function({taskTemplate:n=null,markers:r=[],taskTypes:i=ke.defaultTaskTypes,tasks:l=[],selected:N=[],activeTask:y=null,links:h=[],scales:o=ns,columns:k=ke.defaultColumns,start:b=null,end:F=null,lengthUnit:z="day",durationUnit:H="day",cellWidth:P=100,cellHeight:d=38,scaleHeight:S=36,readonly:te=!1,cellBorders:I="full",zoom:V=!1,baselines:j=!1,highlightTime:O=null,onScaleClick:T=null,init:re=null,autoScale:Z=!0,unscheduledTasks:ce=!1,criticalPath:G=null,schedule:we={type:"forward"},projectStart:U=null,projectEnd:W=null,calendar:w=null,undo:M=!1,splitTasks:se=!1,multiTaskRows:B=!1,marqueeSelect:ie=!1,copyPaste:oe=!1,currentWeekHighlight:he=!1,currentWeekColor:De=null,scrollToCurrentWeek:$e=!1,allowTaskIntersection:Ee=!0,...Re},Ce){const Ie=e.useRef();Ie.current=Re;const Q=e.useMemo(()=>new ke.DataStore(R.writable),[]),p=e.useMemo(()=>({...Je.en,...Be.en}),[]),_=e.useContext(be.context.i18n),X=e.useMemo(()=>_?_.extend(p,!0):Se.locale(p),[_,p]),A=e.useMemo(()=>X.getRaw().calendar,[X]),J=e.useMemo(()=>{let ae={zoom:ts(V,A),scales:kt(o,A),columns:es(k,A),links:ke.normalizeLinks(h),cellWidth:P};return ae.zoom&&(ae={...ae,...ke.normalizeZoom(ae.zoom,Jt(A,X.getGroup("gantt")),ae.scales,P)}),ae},[V,o,k,h,P,A,X]),me=e.useRef(null);me.current!==l&&(ke.parseTaskDates(l,{durationUnit:H,splitTasks:se,calendar:w}),me.current=l),e.useEffect(()=>{ke.parseTaskDates(l,{durationUnit:H,splitTasks:se,calendar:w})},[l,H,w,se]);const ne=e.useMemo(()=>{if(!B)return null;const ae=new Map,ye=new Map,xe=Ne=>{Ne.forEach(Oe=>{const a=Oe.row??Oe.id;ye.set(Oe.id,a),ae.has(a)||ae.set(a,[]),ae.get(a).push(Oe.id),Oe.data&&Oe.data.length>0&&xe(Oe.data)})};return xe(l),{rowMap:ae,taskRows:ye}},[l,B]),v=e.useMemo(()=>Q.in,[Q]),K=e.useRef(null);K.current===null&&(K.current=new jt.EventBusRouter((ae,ye)=>{const xe="on"+ss(ae);Ie.current&&Ie.current[xe]&&Ie.current[xe](ye)}),v.setNext(K.current));const[ue,x]=e.useState(null),ee=e.useRef(null);ee.current=ue;const fe=e.useMemo(()=>({getState:Q.getState.bind(Q),getReactiveState:Q.getReactive.bind(Q),getStores:()=>({data:Q}),exec:v.exec,setNext:ae=>(K.current=K.current.setNext(ae),K.current),intercept:v.intercept.bind(v),on:v.on.bind(v),detach:v.detach.bind(v),getTask:Q.getTask.bind(Q),serialize:Q.serialize.bind(Q),getTable:ae=>ae?new Promise(ye=>setTimeout(()=>ye(ee.current),1)):ee.current,getHistory:()=>Q.getHistory()}),[Q,v]);e.useImperativeHandle(Ce,()=>({...fe}),[fe]);const q=e.useRef(0);e.useEffect(()=>{q.current?Q.init({tasks:l,links:J.links,start:b,columns:J.columns,end:F,lengthUnit:z,cellWidth:J.cellWidth,cellHeight:d,scaleHeight:S,scales:J.scales,taskTypes:i,zoom:J.zoom,selected:N,activeTask:y,baselines:j,autoScale:Z,unscheduledTasks:ce,markers:r,durationUnit:H,criticalPath:G,schedule:we,projectStart:U,projectEnd:W,calendar:w,undo:M,_weekStart:A.weekStart,splitTasks:se}):re&&re(fe),q.current++},[fe,re,l,J,b,F,z,d,S,i,N,y,j,Z,ce,r,H,G,we,U,W,w,M,A,se,Q]),q.current===0&&Q.init({tasks:l,links:J.links,start:b,columns:J.columns,end:F,lengthUnit:z,cellWidth:J.cellWidth,cellHeight:d,scaleHeight:S,scales:J.scales,taskTypes:i,zoom:J.zoom,selected:N,activeTask:y,baselines:j,autoScale:Z,unscheduledTasks:ce,markers:r,durationUnit:H,criticalPath:G,schedule:we,projectStart:U,projectEnd:W,calendar:w,undo:M,_weekStart:A.weekStart,splitTasks:se});const Te=e.useMemo(()=>{const ae=new Date,ye=A?.weekStart??0,xe=new Date(Date.UTC(ae.getUTCFullYear(),ae.getUTCMonth(),ae.getUTCDate())),Oe=(xe.getUTCDay()-ye+7)%7;xe.setUTCDate(xe.getUTCDate()-Oe),xe.setUTCHours(0,0,0,0);const a=new Date(xe);return a.setUTCDate(a.getUTCDate()+7),g=>g>=xe&&g<a},[A]),je=e.useMemo(()=>(ae,ye)=>{let xe=[];if(w)ye=="day"&&!w.getDayHours(ae)&&xe.push("wx-weekend"),ye=="hour"&&!w.getDayHours(ae)&&xe.push("wx-weekend");else if(O){const Ne=O(ae,ye);Ne&&xe.push(Ne)}return he&&(ye==="week"||ye==="day")&&Te(ae)&&xe.push("wx-current-week"),xe.join(" ")},[w,O,he,Te]);return c.jsx(be.context.i18n.Provider,{value:X,children:c.jsx(He.Provider,{value:fe,children:c.jsx(Vt,{taskTemplate:n,readonly:te,cellBorders:I,highlightTime:je,onScaleClick:T,onTableAPIChange:x,multiTaskRows:B,rowMapping:ne,marqueeSelect:ie,copyPaste:oe,scrollToCurrentWeek:$e,currentWeekColor:De,allowTaskIntersection:Ee})})})});function os({api:s=null,items:n=[]}){const r=e.useContext(be.context.i18n),i=e.useMemo(()=>r||Se.locale(Be.en),[r]),l=e.useMemo(()=>i.getGroup("gantt"),[i]),N=R.useStoreLater(s,"_selected"),y=R.useStoreLater(s,"undo"),h=R.useStoreLater(s,"history"),o=R.useStoreLater(s,"splitTasks"),k=["undo","redo"],b=e.useMemo(()=>{const z=ke.getToolbarButtons({undo:!0,splitTasks:!0});return(n.length?n:ke.getToolbarButtons({undo:y,splitTasks:o})).map(P=>{let d={...P,disabled:!1};return d.handler=ke.isHandledAction(z,d.id)?S=>ke.handleAction(s,S.id,null,l):d.handler,d.text&&(d.text=l(d.text)),d.menuText&&(d.menuText=l(d.menuText)),d})},[n,s,l,y,o]),F=e.useMemo(()=>{const z=[];return b.forEach(H=>{const P=H.id;if(P==="add-task")z.push(H);else if(k.includes(P))k.includes(P)&&z.push({...H,disabled:H.isDisabled(h)});else{if(!N?.length||!s)return;z.push({...H,disabled:H.isDisabled&&N.some(d=>H.isDisabled(d,s.getState()))})}}),z.filter((H,P)=>{if(s&&H.isHidden)return!N.some(d=>H.isHidden(d,s.getState()));if(H.comp==="separator"){const d=z[P+1];if(!d||d.comp==="separator")return!1}return!0})},[s,N,h,b]);return r?c.jsx(ut.Toolbar,{items:F}):c.jsx(be.context.i18n.Provider,{value:i,children:c.jsx(ut.Toolbar,{items:F})})}const ls=e.forwardRef(function({options:n=[],api:r=null,resolver:i=null,filter:l=null,at:N="point",children:y,onClick:h,css:o},k){const b=e.useRef(null),F=e.useRef(null),z=e.useContext(be.context.i18n),H=e.useMemo(()=>z||Se.locale({...Be.en,...Je.en}),[z]),P=e.useMemo(()=>H.getGroup("gantt"),[H]),d=R.useStoreLater(r,"taskTypes"),S=R.useStoreLater(r,"selected"),te=R.useStoreLater(r,"_selected"),I=R.useStoreLater(r,"splitTasks"),V=e.useMemo(()=>ke.getMenuOptions({splitTasks:!0}),[]);e.useEffect(()=>{r&&(r.on("scroll-chart",()=>{b.current&&b.current.show&&b.current.show()}),r.on("drag-task",()=>{b.current&&b.current.show&&b.current.show()}))},[r]);function j(W){return W.map(w=>(w={...w},w.text&&(w.text=P(w.text)),w.subtext&&(w.subtext=P(w.subtext)),w.data&&(w.data=j(w.data)),w))}function O(){const W=n.length?n:ke.getMenuOptions({splitTasks:I}),w=W.find(M=>M.id==="convert-task");return w&&(w.data=[],(d||[]).forEach(M=>{w.data.push(w.dataFactory(M))})),j(W)}const T=e.useMemo(()=>O(),[r,n,d,I,P]),re=e.useMemo(()=>te&&te.length?te:[],[te]),Z=e.useCallback((W,w)=>{let M=W?r?.getTask(W):null;if(i){const se=i(W,w);M=se===!0?M:se}if(M){const se=Se.locateID(w.target,"data-segment");se!==null?F.current={id:M.id,segmentIndex:se}:F.current=M.id,(!Array.isArray(S)||!S.includes(M.id))&&r&&r.exec&&r.exec("select-task",{id:M.id})}return M},[r,i,S]),ce=e.useCallback(W=>{const w=W.action;w&&(ke.isHandledAction(V,w.id)&&ke.handleAction(r,w.id,F.current,P),h&&h(W))},[r,P,h,V]),G=e.useCallback((W,w)=>{const M=re.length?re:w?[w]:[];let se=l?M.every(B=>l(W,B)):!0;if(se&&(W.isHidden&&(se=!M.some(B=>W.isHidden(B,r.getState(),F.current))),W.isDisabled)){const B=M.some(ie=>W.isDisabled(ie,r.getState(),F.current));W.disabled=B}return se},[l,re,r]);e.useImperativeHandle(k,()=>({show:(W,w)=>{b.current&&b.current.show&&b.current.show(W,w)}}));const we=e.useCallback(W=>{b.current&&b.current.show&&b.current.show(W)},[]),U=c.jsxs(c.Fragment,{children:[c.jsx(It.ContextMenu,{filter:G,options:T,dataKey:"id",resolver:Z,onClick:ce,at:N,ref:b,css:o}),c.jsx("span",{onContextMenu:we,"data-menu-ignore":"true",children:typeof y=="function"?y():y})]});if(!z&&be.context.i18n?.Provider){const W=be.context.i18n.Provider;return c.jsx(W,{value:H,children:U})}return U});function cs({api:s,autoSave:n,onLinksChange:r}){const l=e.useContext(be.context.i18n).getGroup("gantt"),N=R.useStore(s,"activeTask"),y=R.useStore(s,"_activeTask"),h=R.useStore(s,"_links"),o=R.useStore(s,"schedule"),k=R.useStore(s,"unscheduledTasks"),[b,F]=e.useState();function z(){if(N){const S=h.filter(I=>I.target==N).map(I=>({link:I,task:s.getTask(I.source)})),te=h.filter(I=>I.source==N).map(I=>({link:I,task:s.getTask(I.target)}));return[{title:l("Predecessors"),data:S},{title:l("Successors"),data:te}]}}e.useEffect(()=>{F(z())},[N,h]);const H=e.useMemo(()=>[{id:"e2s",label:l("End-to-start")},{id:"s2s",label:l("Start-to-start")},{id:"e2e",label:l("End-to-end")},{id:"s2e",label:l("Start-to-end")}],[l]);function P(S){n?s.exec("delete-link",{id:S}):(F(te=>(te||[]).map(I=>({...I,data:I.data.filter(V=>V.link.id!==S)}))),r&&r({id:S,action:"delete-link",data:{id:S}}))}function d(S,te){n?s.exec("update-link",{id:S,link:te}):(F(I=>(I||[]).map(V=>({...V,data:V.data.map(j=>j.link.id===S?{...j,link:{...j.link,...te}}:j)}))),r&&r({id:S,action:"update-link",data:{id:S,link:te}}))}return c.jsx(c.Fragment,{children:(b||[]).map((S,te)=>S.data.length?c.jsx("div",{className:"wx-j93aYGQf wx-links",children:c.jsx(be.Field,{label:S.title,position:"top",children:c.jsx("table",{children:c.jsx("tbody",{children:S.data.map(I=>c.jsxs("tr",{children:[c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("div",{className:"wx-j93aYGQf wx-task-name",children:I.task.text||""})}),o?.auto&&I.link.type==="e2s"?c.jsx("td",{className:"wx-j93aYGQf wx-cell wx-link-lag",children:c.jsx(be.Text,{type:"number",placeholder:l("Lag"),value:I.link.lag,disabled:k&&y?.unscheduled,onChange:V=>{V.input||d(I.link.id,{lag:V.value})}})}):null,c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("div",{className:"wx-j93aYGQf wx-wrapper",children:c.jsx(be.Combo,{value:I.link.type,placeholder:l("Select link type"),options:H,onChange:V=>d(I.link.id,{type:V.value}),children:({option:V})=>V.label})})}),c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("i",{className:"wx-j93aYGQf wxi-delete wx-delete-icon",onClick:()=>P(I.link.id),role:"button"})})]},I.link.id))})})})},te):null)})}function is(s){const{value:n,time:r,format:i,onchange:l,onChange:N,...y}=s,h=N??l;function o(k){const b=new Date(k.value);b.setUTCHours(n.getUTCHours()),b.setUTCMinutes(n.getUTCMinutes()),h&&h({value:b})}return c.jsxs("div",{className:"wx-hFsbgDln date-time-controll",children:[c.jsx(be.DatePicker,{...y,value:n,onChange:o,format:i,buttons:["today"],clear:!1}),r?c.jsx(be.TimePicker,{value:n,onChange:h,format:i}):null]})}_e.registerEditorItem("select",be.RichSelect);_e.registerEditorItem("date",is);_e.registerEditorItem("twostate",be.TwoState);_e.registerEditorItem("slider",be.Slider);_e.registerEditorItem("counter",be.Counter);_e.registerEditorItem("links",cs);function as({api:s,items:n=[],css:r="",layout:i="default",readonly:l=!1,placement:N="sidebar",bottomBar:y=!0,topBar:h=!0,autoSave:o=!0,focus:k=!1,hotkeys:b={}}){const F=e.useContext(be.context.i18n),z=e.useMemo(()=>F||Se.locale({...Be.en,...Je.en}),[F]),H=e.useMemo(()=>z.getGroup("gantt"),[z]),P=z.getRaw(),d=e.useMemo(()=>{const x=P.gantt?.dateFormat||P.formats?.dateFormat;return Se.dateToString(x,P.calendar)},[P]),S=e.useMemo(()=>{if(h===!0&&!l){const x=[{comp:"icon",icon:"wxi-close",id:"close"},{comp:"spacer"},{comp:"button",type:"danger",text:H("Delete"),id:"delete"}];return o?{items:x}:{items:[...x,{comp:"button",type:"primary",text:H("Save"),id:"save"}]}}return h},[h,l,o,H]),[te,I]=e.useState(!1),V=e.useMemo(()=>te?"wx-full-screen":"",[te]),j=e.useCallback(x=>{I(x)},[]);e.useEffect(()=>{const x=pt(j);return x.observe(),()=>{x.disconnect()}},[j]);const O=R.useStore(s,"_activeTask"),T=R.useStore(s,"activeTask"),re=R.useStore(s,"unscheduledTasks"),Z=R.useStore(s,"links"),ce=R.useStore(s,"splitTasks"),G=e.useMemo(()=>ce&&T?.segmentIndex,[ce,T]),we=e.useMemo(()=>G||G===0,[G]),U=e.useMemo(()=>ke.getEditorItems({unscheduledTasks:re}),[re]),W=R.useStore(s,"undo"),[w,M]=e.useState({}),[se,B]=e.useState(null),[ie,oe]=e.useState(),[he,De]=e.useState(null),$e=R.useStore(s,"taskTypes"),Ee=e.useMemo(()=>{if(!O)return null;let x;if(we&&O.segments?x={...O.segments[G]}:x={...O},l){let ee={parent:x.parent};return U.forEach(({key:fe,comp:q})=>{if(q!=="links"){const Te=x[fe];q==="date"&&Te instanceof Date?ee[fe]=d(Te):q==="slider"&&fe==="progress"?ee[fe]=`${Te}%`:ee[fe]=Te}}),ee}return x||null},[O,we,G,l,U,d]);e.useEffect(()=>{oe(Ee)},[Ee]),e.useEffect(()=>{M({}),De(null),B(null)},[T]);function Re(x,ee){return x.map(fe=>{const q={...fe};if(fe.config&&(q.config={...q.config}),q.comp==="links"&&s&&(q.api=s,q.autoSave=o,q.onLinksChange=Q),q.comp==="select"&&q.key==="type"){const Te=q.options??($e||[]);q.options=Te.map(je=>({...je,label:H(je.label)}))}return q.comp==="slider"&&q.key==="progress"&&(q.labelTemplate=Te=>`${H(q.label)} ${Te}%`),q.label&&(q.label=H(q.label)),q.config?.placeholder&&(q.config.placeholder=H(q.config.placeholder)),ee&&(q.isDisabled&&q.isDisabled(ee,s.getState())?q.disabled=!0:delete q.disabled),q})}const Ce=e.useMemo(()=>{let x=n.length?n:U;return x=Re(x,ie),ie?x.filter(ee=>!ee.isHidden||!ee.isHidden(ie,s.getState())):x},[n,U,ie,$e,H,s,o]),Ie=e.useMemo(()=>Ce.map(x=>x.key),[Ce]);function Q({id:x,action:ee,data:fe}){M(q=>({...q,[x]:{action:ee,data:fe}}))}const p=e.useCallback(()=>{for(let x in w)if(Z.byId(x)){const{action:ee,data:fe}=w[x];s.exec(ee,fe)}},[s,w,Z]),_=e.useCallback(()=>{const x=T?.id||T;if(we){if(O?.segments){const ee=O.segments.filter((fe,q)=>q!==G);s.exec("update-task",{id:x,task:{segments:ee}})}}else s.exec("delete-task",{id:x})},[s,T,we,O,G]),X=e.useCallback(()=>{s.exec("show-editor",{id:null})},[s]),A=e.useCallback(x=>{const{item:ee,changes:fe}=x;ee.id==="delete"&&_(),ee.id==="save"&&(fe.length?X():p()),ee.comp&&X()},[s,T,o,p,_,X]),J=e.useCallback((x,ee,fe)=>(re&&x.type==="summary"&&(x.unscheduled=!1),ke.prepareEditTask(x,s.getState(),ee),fe||B(!1),x),[re,s]),me=e.useCallback(x=>{x={...x,unscheduled:re&&x.unscheduled&&x.type!=="summary"},delete x.links,delete x.data,(Ie.indexOf("duration")===-1||x.segments&&!x.duration)&&delete x.duration;const ee={id:T?.id||T,task:x,...we&&{segmentIndex:G}};o&&se&&(ee.inProgress=se),s.exec("update-task",ee),o||p()},[s,T,re,o,p,Ie,we,G,se]),ne=e.useCallback(x=>{let{update:ee,key:fe,input:q}=x;if(q&&B(!0),x.update=J({...ee},fe,q),!o)oe(x.update);else if(!he&&!q){const Te=Ce.find(ye=>ye.key===fe),je=ee[fe];(!Te.validation||Te.validation(je))&&(!Te.required||je)&&me(x.update)}},[o,J,he,Ce,me]),v=e.useCallback(x=>{o||me(x.values)},[o,me]),K=e.useCallback(x=>{De(x.errors)},[]),ue=e.useMemo(()=>W?{"ctrl+z":x=>{x.preventDefault(),s.exec("undo")},"ctrl+y":x=>{x.preventDefault(),s.exec("redo")}}:{},[W,s]);return Ee?c.jsx(be.Locale,{children:c.jsx(_e.Editor,{css:`wx-XkvqDXuw wx-gantt-editor ${V} ${r}`,items:Ce,values:Ee,topBar:S,bottomBar:y,placement:N,layout:i,readonly:l,autoSave:o,focus:k,onAction:A,onSave:v,onValidation:K,onChange:ne,hotkeys:b&&{...ue,...b}})}):null}const us=({children:s,columns:n=null,api:r})=>{const[i,l]=e.useState(null);return e.useEffect(()=>{r&&r.getTable(!0).then(l)},[r]),c.jsx(wt.HeaderMenu,{api:i,columns:n,children:s})};function ds(s){const{api:n,content:r,children:i}=s,l=e.useRef(null),N=e.useRef(null),[y,h]=e.useState({}),[o,k]=e.useState(null),[b,F]=e.useState({});function z(j){for(;j;){if(j.getAttribute){const O=j.getAttribute("data-tooltip-id"),T=j.getAttribute("data-tooltip-at"),re=j.getAttribute("data-tooltip");if(O||re)return{id:O,tooltip:re,target:j,at:T}}j=j.parentNode}return{id:null,tooltip:null,target:null,at:null}}e.useEffect(()=>{const j=N.current;if(j&&b&&(b.text||r)){const O=j.getBoundingClientRect();let T=!1,re=b.left,Z=b.top;O.right>=y.right&&(re=y.width-O.width-5,T=!0),O.bottom>=y.bottom&&(Z=b.top-(O.bottom-y.bottom+2),T=!0),T&&F(ce=>ce&&{...ce,left:re,top:Z})}},[b,y,r]);const H=e.useRef(null),P=300,d=j=>{clearTimeout(H.current),H.current=setTimeout(()=>{j()},P)};function S(j){let{id:O,tooltip:T,target:re,at:Z}=z(j.target);if(F(null),k(null),!T)if(O)T=I(O);else{clearTimeout(H.current);return}const ce=j.clientX;d(()=>{O&&k(te(V(O)));const G=re.getBoundingClientRect(),we=l.current,U=we?we.getBoundingClientRect():{top:0,left:0,right:0,bottom:0,width:0,height:0};let W,w;Z==="left"?(W=G.top+5-U.top,w=G.right+5-U.left):(W=G.top+G.height-U.top,w=ce-U.left),h(U),F({top:W,left:w,text:T})})}function te(j){return n?.getTask(V(j))||null}function I(j){return te(j)?.text||""}function V(j){const O=parseInt(j);return isNaN(O)?j:O}return c.jsxs("div",{className:"wx-KG0Lwsqo wx-tooltip-area",ref:l,onMouseMove:S,children:[b&&(b.text||r)?c.jsx("div",{className:"wx-KG0Lwsqo wx-gantt-tooltip",ref:N,style:{top:`${b.top}px`,left:`${b.left}px`},children:r?c.jsx(r,{data:o}):b.text?c.jsx("div",{className:"wx-KG0Lwsqo wx-gantt-tooltip-text",children:b.text}):null}):null,i]})}function fs({fonts:s=!0,children:n}){return n?c.jsx(be.Material,{fonts:s,children:n()}):c.jsx(be.Material,{fonts:s})}function xs({fonts:s=!0,children:n}){return n?c.jsx(be.Willow,{fonts:s,children:n}):c.jsx(be.Willow,{fonts:s})}function hs({fonts:s=!0,children:n}){return n?c.jsx(be.WillowDark,{fonts:s,children:n}):c.jsx(be.WillowDark,{fonts:s})}Object.defineProperty(exports,"defaultColumns",{enumerable:!0,get:()=>ke.defaultColumns});Object.defineProperty(exports,"defaultEditorItems",{enumerable:!0,get:()=>ke.defaultEditorItems});Object.defineProperty(exports,"defaultMenuOptions",{enumerable:!0,get:()=>ke.defaultMenuOptions});Object.defineProperty(exports,"defaultTaskTypes",{enumerable:!0,get:()=>ke.defaultTaskTypes});Object.defineProperty(exports,"defaultToolbarButtons",{enumerable:!0,get:()=>ke.defaultToolbarButtons});Object.defineProperty(exports,"getEditorItems",{enumerable:!0,get:()=>ke.getEditorItems});Object.defineProperty(exports,"getMenuOptions",{enumerable:!0,get:()=>ke.getMenuOptions});Object.defineProperty(exports,"getToolbarButtons",{enumerable:!0,get:()=>ke.getToolbarButtons});Object.defineProperty(exports,"registerScaleUnit",{enumerable:!0,get:()=>ke.registerScaleUnit});Object.defineProperty(exports,"registerEditorItem",{enumerable:!0,get:()=>_e.registerEditorItem});exports.ContextMenu=ls;exports.Editor=as;exports.Gantt=rs;exports.HeaderMenu=us;exports.Material=fs;exports.Toolbar=os;exports.Tooltip=ds;exports.Willow=xs;exports.WillowDark=hs;
//# sourceMappingURL=index.cjs.map
