"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const c=require("react/jsx-runtime"),e=require("react"),be=require("@svar-ui/react-core"),ve=require("@svar-ui/lib-dom"),Be=require("@svar-ui/gantt-locales"),Je=require("@svar-ui/core-locales"),Dt=require("@svar-ui/lib-state"),we=require("@svar-ui/gantt-store"),D=require("@svar-ui/lib-react"),gt=require("@svar-ui/grid-store"),wt=require("@svar-ui/react-grid"),$t=require("react-dom"),ut=require("@svar-ui/react-toolbar"),It=require("@svar-ui/react-menu"),_e=require("@svar-ui/react-editor"),He=e.createContext(null);function ze(s){const n=s.getAttribute("data-id"),r=parseInt(n);return isNaN(r)||r.toString()!=n?n:r}function Lt(s,n,r){const i=s.getBoundingClientRect(),l=n.querySelector(".wx-body").getBoundingClientRect();return{top:i.top-l.top,left:i.left-l.left,dt:i.bottom-r.clientY,db:r.clientY-i.top}}function dt(s){return s&&s.getAttribute("data-context-id")}const ft=5;function Nt(s,n){let r,i,l,W,h,S,o,v,b;function Y(M){W=M.clientX,h=M.clientY,S={...Lt(r,s,M),y:n.getTask(l).$y},document.body.style.userSelect="none"}function q(M){r=ve.locate(M),dt(r)&&(l=ze(r),b=setTimeout(()=>{v=!0,n&&n.touchStart&&n.touchStart(),Y(M.touches[0])},500),s.addEventListener("touchmove",L),s.addEventListener("contextmenu",E),window.addEventListener("touchend",Q))}function E(M){if(v||b)return M.preventDefault(),!1}function y(M){M.which===1&&(r=ve.locate(M),dt(r)&&(l=ze(r),s.addEventListener("mousemove",B),window.addEventListener("mouseup",T),Y(M)))}function f(M){s.removeEventListener("mousemove",B),s.removeEventListener("touchmove",L),document.body.removeEventListener("mouseup",T),document.body.removeEventListener("touchend",Q),document.body.style.userSelect="",M&&(s.removeEventListener("mousedown",y),s.removeEventListener("touchstart",q))}function P(M){const Z=M.clientX-W,J=M.clientY-h;if(!i){if(Math.abs(Z)<ft&&Math.abs(J)<ft||n&&n.start&&n.start({id:l,e:M})===!1)return;i=r.cloneNode(!0),i.style.pointerEvents="none",i.classList.add("wx-reorder-task"),i.style.position="absolute",i.style.left=S.left+"px",i.style.top=S.top+"px",r.style.visibility="hidden",r.parentNode.insertBefore(i,r)}if(i){const ee=Math.round(Math.max(0,S.top+J));if(n&&n.move&&n.move({id:l,top:ee,detail:o})===!1)return;const te=n.getTask(l),se=te.$y;if(!S.start&&S.y==se)return _();S.start=!0,S.y=te.$y-4,i.style.top=ee+"px";const ne=document.elementFromPoint(M.clientX,M.clientY),$=ve.locate(ne);if($&&$!==r){const R=ze($),p=$.getBoundingClientRect(),ue=p.top+p.height/2,V=M.clientY+S.db>ue&&$.nextElementSibling!==r,ie=M.clientY-S.dt<ue&&$.previousElementSibling!==r;o?.after==R||o?.before==R?o=null:V?o={id:l,after:R}:ie&&(o={id:l,before:R})}}}function B(M){P(M)}function L(M){v?(M.preventDefault(),P(M.touches[0])):b&&(clearTimeout(b),b=null)}function Q(){v=null,b&&(clearTimeout(b),b=null),_()}function T(){_()}function _(){r&&(r.style.visibility=""),i&&(i.parentNode.removeChild(i),n&&n.end&&n.end({id:l,top:S.top})),l=r=i=S=o=null,f()}return s.style.position!=="absolute"&&(s.style.position="relative"),s.addEventListener("mousedown",y),s.addEventListener("touchstart",q),{destroy(){f(!0)}}}function Pt({row:s,column:n}){function r(l,W){return{justifyContent:W.align,paddingLeft:`${(l.$level-1)*20}px`}}const i=n&&n._cell;return c.jsxs("div",{className:"wx-pqc08MHU wx-content",style:r(s,n),children:[s.data||s.lazy?c.jsx("i",{className:`wx-pqc08MHU wx-toggle-icon wxi-menu-${s.open?"down":"right"}`,"data-action":"open-task"}):c.jsx("i",{className:"wx-pqc08MHU wx-toggle-placeholder"}),c.jsx("div",{className:"wx-pqc08MHU wx-text",children:i?c.jsx(i,{row:s,column:n}):s.text})]})}function xt({column:s,cell:n}){const r=e.useMemo(()=>s.id,[s?.id]);return n||s.id=="add-task"?c.jsx("div",{style:{textAlign:s.align},children:c.jsx("i",{className:"wx-9DAESAHW wx-action-icon wxi-plus","data-action":r})}):null}function Ot(s){const{readonly:n,compactMode:r,width:i=0,display:l="all",columnWidth:W=0,onTableAPIChange:h,multiTaskRows:S=!1,rowMapping:o=null}=s,[v,b]=D.useWritableProp(W),[Y,q]=e.useState(),E=e.useContext(be.context.i18n),y=e.useMemo(()=>E.getGroup("gantt"),[E]),f=e.useContext(He),P=D.useStore(f,"scrollTop"),B=D.useStore(f,"cellHeight"),L=D.useStore(f,"_scrollTask"),Q=D.useStore(f,"_selected"),T=D.useStore(f,"area"),_=D.useStore(f,"_tasks"),M=D.useStore(f,"_scales"),Z=D.useStore(f,"columns"),J=D.useStore(f,"_sort"),ee=D.useStore(f,"calendar"),te=D.useStore(f,"durationUnit"),se=D.useStore(f,"splitTasks"),[ne,$]=e.useState(null),R=e.useMemo(()=>!_||!T?[]:S&&o?_:_.slice(T.start,T.end),[_,T,S,o]),p=e.useCallback((a,k)=>{if(k==="add-task")f.exec(k,{target:a,task:{text:y("New Task")},mode:"child",show:!0});else if(k==="open-task"){const I=R.find(G=>G.id===a);(I?.data||I?.lazy)&&f.exec(k,{id:a,mode:!I.open})}},[R]),ue=e.useCallback(a=>{const k=ve.locateID(a),I=a.target.dataset.action;I&&a.preventDefault(),k?I==="add-task"||I==="open-task"?p(k,I):f.exec("select-task",{id:k,toggle:a.ctrlKey||a.metaKey,range:a.shiftKey,show:!0}):I==="add-task"&&p(null,I)},[f,p]),V=e.useRef(null),ie=e.useRef(null),[oe,de]=e.useState(0),[$e,De]=e.useState(!1);e.useEffect(()=>{const a=ie.current;if(!a||typeof ResizeObserver>"u")return;const k=()=>de(a.clientWidth);k();const I=new ResizeObserver(k);return I.observe(a),()=>I.disconnect()},[]);const Ie=e.useRef(null),Re=e.useCallback(a=>{const k=a.id,{before:I,after:G}=a,he=a.onMove;let ae=I||G,je=I?"before":"after";if(he){if(je==="after"){const We=f.getTask(ae);We.data?.length&&We.open&&(je="before",ae=We.data[0].id)}Ie.current={id:k,[je]:ae}}else Ie.current=null;f.exec("move-task",{id:k,mode:je,target:ae,inProgress:he})},[f]),pe=e.useMemo(()=>S&&o?0:T?.from??0,[T,S,o]),fe=e.useMemo(()=>M?.height??0,[M]),x=e.useMemo(()=>!r&&l!=="grid"?(v??0)>(i??0):(v??0)>(oe??0),[r,l,v,i,oe]),H=e.useMemo(()=>{const a={};return x&&l==="all"||l==="grid"&&x?a.width=v:l==="grid"&&(a.width="100%"),a},[x,l,v]),F=e.useMemo(()=>ne&&!R.find(a=>a.id===ne.id)?[...R,ne]:R,[R,ne]),A=e.useMemo(()=>{if(!S||!o)return F;const a=new Map,k=new Set;return F.forEach(I=>{const G=o.taskRows.get(I.id)??I.id;k.has(G)||(a.set(G,{...I,$rowTasks:o.rowMap.get(G)||[I.id]}),k.add(G))}),Array.from(a.values())},[F,S,o]),z=e.useMemo(()=>{let a=(Z||[]).map(G=>{G={...G};const he=G.header;if(typeof he=="object"){const ae=he.text&&y(he.text);G.header={...he,text:ae}}else G.header=y(he);return G});const k=a.findIndex(G=>G.id==="text"),I=a.findIndex(G=>G.id==="add-task");if(k!==-1&&(a[k].cell&&(a[k]._cell=a[k].cell),a[k].cell=Pt),I!==-1){a[I].cell=a[I].cell||xt;const G=a[I].header;if(typeof G!="object"&&(a[I].header={text:G}),a[I].header.cell=G.cell||xt,n)a.splice(I,1);else if(r){const[he]=a.splice(I,1);a.unshift(he)}}return a.length>0&&(a[a.length-1].resize=!1),a},[Z,y,n,r]),me=e.useMemo(()=>l==="all"?`${i}px`:l==="grid"?"calc(100% - 4px)":z.find(a=>a.id==="add-task")?"50px":"0",[l,i,z]),Te=e.useMemo(()=>{if(A&&J?.length){const a={};return J.forEach(({key:k,order:I},G)=>{a[k]={order:I,...J.length>1&&{index:G}}}),a}return{}},[A,J]),g=e.useCallback(()=>z.some(a=>a.flexgrow&&!a.hidden),[]),X=e.useMemo(()=>g(),[g,$e]),ce=e.useMemo(()=>{let a=l==="chart"?z.filter(I=>I.id==="add-task"):z;const k=l==="all"?i:oe;if(!X){let I=v,G=!1;if(z.some(he=>he.$width)){let he=0;I=z.reduce((ae,je)=>(je.hidden||(he+=je.width,ae+=je.$width||je.width),ae),0),he>I&&I>k&&(G=!0)}if(G||I<k){let he=1;return G||(he=(k-50)/(I-50||1)),a.map(ae=>(ae.id!=="add-task"&&!ae.hidden&&(ae.$width||(ae.$width=ae.width),ae.width=ae.$width*he),ae))}}return a},[l,z,X,v,i,oe]),ye=e.useCallback(a=>{if(!g()){const k=ce.reduce((I,G)=>(a&&G.$width&&(G.$width=G.width),I+(G.hidden?0:G.width)),0);k!==v&&b(k)}De(!0),De(!1)},[g,ce,v,b]),m=e.useCallback(()=>{z.filter(k=>k.flexgrow&&!k.hidden).length===1&&z.forEach(k=>{k.$width&&!k.flexgrow&&!k.hidden&&(k.width=k.$width)})},[]),re=e.useCallback(a=>{if(!n){const k=ve.locateID(a),I=ve.locateAttr(a,"data-col-id");!(I&&z.find(he=>he.id==I))?.editor&&k&&f.exec("show-editor",{id:k})}},[f,n]),xe=e.useMemo(()=>Array.isArray(Q)?Q.map(a=>a.id):[],[Q]),U=e.useRef(pe);U.current=pe,e.useEffect(()=>{const a=I=>{if(V.current){const G=V.current.querySelector(".wx-body");G&&(G.style.top=-((I??0)-(U.current??0))+"px")}ie.current&&(ie.current.scrollTop=0)};return a(P),f.on("scroll-chart",({top:I})=>{I!==void 0&&a(I)})},[f,P]),e.useEffect(()=>{if(V.current){const a=V.current.querySelector(".wx-body");a&&(a.style.top=-((P??0)-(pe??0))+"px")}},[pe]),e.useEffect(()=>{const a=V.current;if(!a)return;const k=a.querySelector(".wx-table-box .wx-body");if(!k||typeof ResizeObserver>"u")return;const I=new ResizeObserver(()=>{if(V.current){const G=V.current.querySelector(".wx-body");G&&(G.style.top=-((P??0)-(U.current??0))+"px")}});return I.observe(k),()=>{I.disconnect()}},[ce,H,l,me,A,P]),e.useEffect(()=>{if(!L||!Y)return;const{id:a}=L,k=Y.getState().focusCell;k&&k.row!==a&&V.current&&V.current.contains(document.activeElement)&&Y.exec("focus-cell",{row:a,column:k.column})},[L,Y]);const Ce=e.useCallback(({id:a})=>{if(n)return!1;f.getTask(a).open&&f.exec("open-task",{id:a,mode:!1});const k=f.getState()._tasks.find(I=>I.id===a);if($(k||null),!k)return!1},[f,n]),K=e.useCallback(({id:a,top:k})=>{Ie.current?Re({...Ie.current,onMove:!1}):f.exec("drag-task",{id:a,top:k+(pe??0),inProgress:!1}),$(null)},[f,Re,pe]),Se=e.useCallback(({id:a,top:k,detail:I})=>{I&&Re({...I,onMove:!0}),f.exec("drag-task",{id:a,top:k+(pe??0),inProgress:!0})},[f,Re,pe]);e.useEffect(()=>{const a=V.current;return a?Nt(a,{start:Ce,end:K,move:Se,getTask:f.getTask}).destroy:void 0},[f,Ce,K,Se]);const ke=e.useCallback(a=>{const{key:k,isInput:I}=a;if(!I&&(k==="arrowup"||k==="arrowdown"))return a.eventSource="grid",f.exec("hotkey",a),!1;if(k==="enter"){const G=Y?.getState().focusCell;if(G){const{row:he,column:ae}=G;ae==="add-task"?p(he,"add-task"):ae==="text"&&p(he,"open-task")}}},[f,p,Y]),Me=e.useRef(null),Pe=()=>{Me.current={setTableAPI:q,handleHotkey:ke,sortVal:J,api:f,adjustColumns:m,setColumnWidth:ye,tasks:R,calendarVal:ee,durationUnitVal:te,splitTasksVal:se,onTableAPIChange:h}};Pe(),e.useEffect(()=>{Pe()},[q,ke,J,f,m,ye,R,ee,te,se,h]);const Oe=e.useCallback(a=>{q(a),a.intercept("hotkey",k=>Me.current.handleHotkey(k)),a.intercept("scroll",()=>!1),a.intercept("select-row",()=>!1),a.intercept("sort-rows",k=>{const I=Me.current.sortVal,{key:G,add:he}=k,ae=I?I.find(We=>We.key===G):null;let je="asc";return ae&&(je=!ae||ae.order==="asc"?"desc":"asc"),f.exec("sort-tasks",{key:G,order:je,add:he}),!1}),a.on("resize-column",()=>{Me.current.setColumnWidth(!0)}),a.on("hide-column",k=>{k.mode||Me.current.adjustColumns(),Me.current.setColumnWidth()}),a.intercept("update-cell",k=>{const{id:I,column:G,value:he}=k,ae=Me.current.tasks.find(je=>je.id===I);if(ae){const je={...ae};let We=he;We&&!isNaN(We)&&!(We instanceof Date)&&(We*=1),je[G]=We,we.prepareEditTask(je,{calendar:Me.current.calendarVal,durationUnit:Me.current.durationUnitVal,splitTasks:Me.current.splitTasksVal},G),f.exec("update-task",{id:I,task:je})}return!1}),h&&h(a)},[]);return c.jsx("div",{className:"wx-rHj6070p wx-table-container",style:{flex:`0 0 ${me}`},ref:ie,children:c.jsx("div",{ref:V,style:H,className:"wx-rHj6070p wx-table",onClick:ue,onDoubleClick:re,children:c.jsx(wt.Grid,{init:Oe,sizes:{rowHeight:B,headerHeight:(fe??0)-1},rowStyle:a=>a.$reorder?"wx-rHj6070p wx-reorder-task":"wx-rHj6070p",columnStyle:a=>`wx-rHj6070p wx-text-${a.align}${a.id==="add-task"?" wx-action":""}`,data:A,columns:ce,selectedRows:[...xe],sortMarks:Te})})})}function Wt({borders:s=""}){const n=e.useContext(He),r=D.useStore(n,"cellWidth"),i=D.useStore(n,"cellHeight"),l=e.useRef(null),[W,h]=e.useState("#e4e4e4");e.useEffect(()=>{if(typeof getComputedStyle<"u"&&l.current){const o=getComputedStyle(l.current).getPropertyValue("--wx-gantt-border");h(o?o.substring(o.indexOf("#")):"#1d1e261a")}},[]);const S={width:"100%",height:"100%",background:r!=null&&i!=null?`url(${we.grid(r,i,W,s)})`:void 0,position:"absolute",pointerEvents:"none"};return c.jsx("div",{ref:l,style:S})}function _t({onSelectLink:s,selectedLink:n,readonly:r}){const i=e.useContext(He),l=D.useStore(i,"_links"),W=D.useStore(i,"criticalPath"),h=e.useRef(null),S=e.useCallback(o=>{const v=o?.target?.classList;!v?.contains("wx-line")&&!v?.contains("wx-delete-button")&&s(null)},[s]);return e.useEffect(()=>{if(!r&&n&&h.current){const o=v=>{h.current&&!h.current.contains(v.target)&&S(v)};return document.addEventListener("click",o),()=>{document.removeEventListener("click",o)}}},[r,n,S]),c.jsxs("svg",{className:"wx-dkx3NwEn wx-links",children:[(l||[]).map(o=>{const v="wx-dkx3NwEn wx-line"+(W&&o.$critical?" wx-critical":"")+(r?"":" wx-line-selectable");return c.jsx("polyline",{className:v,points:o.$p,onClick:()=>!r&&s(o.id),"data-link-id":o.id},o.id)}),!r&&n&&c.jsx("polyline",{ref:h,className:"wx-dkx3NwEn wx-line wx-line-selected wx-line-selectable wx-delete-link",points:n.$p})]})}function Ht(s){const{task:n,type:r}=s;function i(W){const h=n.segments[W];return{left:`${h.$x}px`,top:"0px",width:`${h.$w}px`,height:"100%"}}function l(W){if(!n.progress)return 0;const h=n.duration*n.progress/100,S=n.segments;let o=0,v=0,b=null;do{const Y=S[v];v===W&&(o>h?b=0:b=Math.min((h-o)/Y.duration,1)*100),o+=Y.duration,v++}while(b===null&&v<S.length);return b||0}return c.jsx("div",{className:"wx-segments wx-GKbcLEGA",children:n.segments.map((W,h)=>c.jsxs("div",{className:`wx-segment wx-bar wx-${r} wx-GKbcLEGA`,"data-segment":h,style:i(h),children:[n.progress?c.jsx("div",{className:"wx-progress-wrapper",children:c.jsx("div",{className:"wx-progress-percent wx-GKbcLEGA",style:{width:`${l(h)}%`}})}):null,c.jsx("div",{className:"wx-content",children:W.text||""})]},h))})}let Ye=[],Ze=null,ht=null;const mt=(s,n)=>{if(!n||!n.start)return null;const{start:r,lengthUnitWidth:i,lengthUnit:l}=n,W=864e5,h=l==="week"?7:l==="month"?30:l==="quarter"?91:l==="year"?365:1,S=Math.floor(s/i),o=new Date(r.getTime()+S*h*W);return o.setUTCHours(0,0,0,0),console.log("[pixelToDate]",{px:s,units:S,scalesStart:r.toISOString(),result:o.toISOString()}),o},At=(s,n,r)=>{if(!r||!s||!n)return 0;const{lengthUnit:i}=r,h=(i==="week"?7:i==="month"?30:i==="quarter"?91:i==="year"?365:1)*864e5;return Math.round((s.getTime()-n.getTime())/h)},zt=(s,n,r)=>{if(!r||!s)return console.log("[addCells] early return:",{scales:!!r,date:s?.toISOString?.()}),s;const{lengthUnit:i}=r,h=(i==="week"?7:i==="month"?30:i==="quarter"?91:i==="year"?365:1)*864e5,S=new Date(s.getTime()+n*h);return S.setUTCHours(0,0,0,0),console.log("[addCells]",{date:s.toISOString(),cells:n,lengthUnit:i,result:S.toISOString()}),S},Gt=(s,n,r,i)=>s<i&&n>r;function Ut(s){const{readonly:n,taskTemplate:r,multiTaskRows:i=!1,rowMapping:l=null,marqueeSelect:W=!1,copyPaste:h=!1,allowTaskIntersection:S=!0}=s,o=e.useContext(He),[v,b]=D.useStoreWithCounter(o,"_tasks"),[Y,q]=D.useStoreWithCounter(o,"_links"),E=D.useStore(o,"area"),y=D.useStore(o,"_scales"),f=D.useStore(o,"taskTypes"),P=e.useMemo(()=>{if(!y||!y.start)return y;const t=new Date(Date.UTC(y.start.getFullYear(),y.start.getMonth(),y.start.getDate())),u=t.getUTCDay(),d=u===0?-6:1-u,w=new Date(t.getTime()+d*864e5);return w.setUTCHours(0,0,0,0),console.log("[scales-normalize]",{raw:y.start.toISOString(),utc:t.toISOString(),dayOfWeek:u,daysToMonday:d,monday:w.toISOString()}),{...y,start:w}},[y]),B=D.useStore(o,"baselines"),[L,Q]=D.useStoreWithCounter(o,"_selected"),T=D.useStore(o,"_scrollTask"),_=D.useStore(o,"criticalPath"),M=D.useStore(o,"tasks"),Z=D.useStore(o,"schedule"),J=D.useStore(o,"splitTasks"),ee=e.useMemo(()=>{if(!E||!Array.isArray(v))return[];const t=E.start??0,u=E.end??0;return i&&l?v.map(d=>({...d})):v.slice(t,u).map(d=>({...d}))},[b,E,i,l]),te=D.useStore(o,"cellHeight"),se=e.useMemo(()=>{if(!i||!l||!ee.length)return ee;const t=new Map,u=[];return v.forEach(d=>{const w=l.taskRows.get(d.id)??d.id;t.has(w)||(t.set(w,u.length),u.push(w))}),ee.map(d=>{const w=l.taskRows.get(d.id)??d.id,j=t.get(w)??0;return{...d,$y:j*te,$y_base:d.$y_base!==void 0?j*te:void 0}})},[ee,i,l,v,te]),ne=e.useMemo(()=>P.lengthUnitWidth,[P]),$=e.useMemo(()=>P.lengthUnit||"day",[P]),R=e.useRef(!1),[p,ue]=e.useState(void 0),[V,ie]=e.useState(null),oe=e.useRef(null),[de,$e]=e.useState(null),[De,Ie]=e.useState(void 0),Re=e.useRef(null),[pe,fe]=e.useState(0),[x,H]=e.useState(null),F=e.useRef(null),[A,z]=e.useState(null),[me,Te]=e.useState(null),[g,X]=e.useState(null),ce=e.useRef(null);ce.current=me;const ye=e.useRef(200),m=e.useRef(null),re=e.useMemo(()=>{const t=m.current;return!!(L.length&&t&&t.contains(document.activeElement))},[L,m.current]),xe=e.useMemo(()=>re&&L[L.length-1]?.id,[re,L]);e.useEffect(()=>{if(T&&re&&T){const{id:t}=T,u=m.current?.querySelector(`.wx-bar[data-id='${t}']`);u&&u.focus({preventScroll:!0})}},[T]),e.useEffect(()=>{const t=m.current;if(t&&(fe(t.offsetWidth||0),typeof ResizeObserver<"u")){const u=new ResizeObserver(d=>{d[0]&&fe(d[0].contentRect.width)});return u.observe(t),()=>u.disconnect()}},[m.current]);const U=e.useCallback(()=>{document.body.style.userSelect="none"},[]),Ce=e.useCallback(()=>{document.body.style.userSelect=""},[]),K=e.useCallback((t,u,d)=>{if(u.target.classList.contains("wx-line")||(d||(d=o.getTask(ze(t))),d.type==="milestone"||d.type==="summary"))return"";const w=ve.locate(u,"data-segment");w&&(t=w);const{left:j,width:N}=t.getBoundingClientRect(),C=(u.clientX-j)/N;let O=.2/(N>200?N/200:1);return C<O?"start":C>1-O?"end":""},[o]),Se=e.useMemo(()=>{const t=new Set;if(S||!i||!l)return t;const u=new Map;return v.forEach(d=>{if(d.type==="summary"||d.type==="milestone")return;const w=l.taskRows.get(d.id)??d.id;u.has(w)||u.set(w,[]),u.get(w).push(d)}),u.forEach(d=>{if(!(d.length<2))for(let w=0;w<d.length;w++)for(let j=w+1;j<d.length;j++){const N=d[w],C=d[j],O=N.$x,le=N.$x+N.$w,ge=C.$x,Ee=C.$x+C.$w;Gt(O,le,ge,Ee)&&(t.add(N.id),t.add(C.id))}}),t},[S,i,l,v,b]),ke=e.useMemo(()=>{const t=new Map;if(!i||!l)return v.forEach(w=>{t.set(w.id,w.$y)}),t;const u=new Map,d=[];return v.forEach(w=>{const j=l.taskRows.get(w.id)??w.id;u.has(j)||(u.set(j,d.length),d.push(j))}),v.forEach(w=>{const j=l.taskRows.get(w.id)??w.id,N=u.get(j)??0;t.set(w.id,N*te)}),t},[v,i,l,te]),Me=e.useMemo(()=>{const t=new Map;if(!i||!l)return v.forEach(w=>{t.set(w.id,w.$y),w.row!==void 0&&t.set(w.row,w.$y)}),t;const u=new Map,d=[];return v.forEach(w=>{const j=l.taskRows.get(w.id)??w.id;u.has(j)||(u.set(j,d.length),d.push(j))}),u.forEach((w,j)=>{t.set(j,w*te)}),t},[v,i,l,te]),Pe=e.useCallback(t=>{if(!m.current)return[];const d=Math.min(t.startX,t.currentX),w=Math.max(t.startX,t.currentX),j=Math.min(t.startY,t.currentY),N=Math.max(t.startY,t.currentY);return v.filter(C=>{const O=C.$x,le=C.$x+C.$w,Ee=ke.get(C.id)??C.$y,Ne=Ee+C.$h;return O<w&&le>d&&Ee<N&&Ne>j})},[v,ke]),Oe=e.useMemo(()=>new Set(L.map(t=>t.id)),[L,Q]),a=e.useCallback(t=>Oe.has(t),[Oe]),k=e.useCallback((t,u)=>{const{clientX:d}=u,w=ze(t),j=o.getTask(w),N=u.target.classList;if(!u.target.closest(".wx-delete-button")&&!n){if(N.contains("wx-progress-marker")){const{progress:C}=o.getTask(w);oe.current={id:w,x:d,progress:C,dx:0,node:t,marker:u.target},u.target.classList.add("wx-progress-in-drag")}else{const C=K(t,u,j)||"move",O={id:w,mode:C,x:d,dx:0,l:j.$x,w:j.$w};if(J&&j.segments?.length){const le=ve.locate(u,"data-segment");le&&(O.segmentIndex=le.dataset.segment*1,we.extendDragOptions(j,O))}ie(O)}U()}},[o,n,K,U,J]),I=e.useCallback(t=>{if(t.button!==0||g)return;const u=ve.locate(t);if(!u&&W&&!n){const d=m.current;if(!d)return;const w=d.getBoundingClientRect(),j=t.clientX-w.left,N=t.clientY-w.top;if(h){const O=mt(j,P);O&&(ce.current=O,Te(O))}const C={startX:j,startY:N,currentX:j,currentY:N,ctrlKey:t.ctrlKey||t.metaKey};H(C),F.current=C,U();return}if(u){if(W&&!n&&L.length>1){const d=ze(u);if(a(d)){const w=t.target.classList;if(!w.contains("wx-link")&&!w.contains("wx-progress-marker")&&!t.target.closest(".wx-delete-button")){const j=o.getTask(d);if(!K(u,t,j)){const C=new Map;L.forEach(O=>{const le=o.getTask(O.id);if(le){if(Z?.auto&&le.type==="summary")return;C.set(O.id,{$x:le.$x,$w:le.$w,start:le.start,end:le.end})}}),z({baseTaskId:d,startX:t.clientX,dx:0,originalPositions:C}),U();return}}}}k(u,t)}},[k,W,h,n,L,a,o,K,Z,U,P,g]),G=e.useCallback(t=>{const u=ve.locate(t);u&&(Re.current=setTimeout(()=>{Ie(!0),k(u,t.touches[0])},300))},[k]),he=e.useCallback(t=>{$e(t&&{...Y.find(u=>u.id===t)})},[Y]),ae=e.useCallback(()=>{const t=F.current;if(t){const u=Pe(t);t.ctrlKey?u.forEach(d=>{o.exec("select-task",{id:d.id,toggle:!0,marquee:!0})}):(L.length>0&&o.exec("select-task",{id:null,marquee:!0}),u.forEach((d,w)=>{o.exec("select-task",{id:d.id,toggle:w>0,marquee:!0})})),H(null),F.current=null,Ce(),R.current=!0;return}if(A){const{dx:u,originalPositions:d}=A,w=Math.round(u/ne);if(w!==0){let j=!0;d.forEach((N,C)=>{const O=o.getTask(C);O&&(o.exec("update-task",{id:C,diff:w,task:{start:O.start,end:O.end},skipUndo:!j}),j=!1)}),R.current=!0}else d.forEach((j,N)=>{o.exec("drag-task",{id:N,left:j.$x,width:j.$w,inProgress:!1})});z(null),Ce();return}if(oe.current){const{dx:u,id:d,marker:w,value:j}=oe.current;oe.current=null,typeof j<"u"&&u&&o.exec("update-task",{id:d,task:{progress:j},inProgress:!1}),w.classList.remove("wx-progress-in-drag"),R.current=!0,Ce()}else if(V){const{id:u,mode:d,dx:w,l:j,w:N,start:C,segment:O,index:le}=V;if(ie(null),C){const ge=Math.round(w/ne);if(!ge)o.exec("drag-task",{id:u,width:N,left:j,inProgress:!1,...O&&{segmentIndex:le}});else{let Ee={},Ne=o.getTask(u);O&&(Ne=Ne.segments[le]);const Ge=1440*60*1e3,Le=ge*($==="week"?7:$==="month"?30:$==="quarter"?91:$==="year"?365:1)*Ge;d==="move"?(Ee.start=new Date(Ne.start.getTime()+Le),Ee.end=new Date(Ne.end.getTime()+Le)):d==="start"?(Ee.start=new Date(Ne.start.getTime()+Le),Ee.end=Ne.end):d==="end"&&(Ee.start=Ne.start,Ee.end=new Date(Ne.end.getTime()+Le)),o.exec("update-task",{id:u,task:Ee,...O&&{segmentIndex:le}})}R.current=!0}Ce()}},[o,Ce,V,ne,$,x,A,Pe,L]),je=e.useCallback((t,u)=>{const{clientX:d,clientY:w}=u,j=m.current;if(j){const N=j.getBoundingClientRect();ye.current=d-N.left}if(g){if(!j)return;const N=j.getBoundingClientRect(),C=d-N.left;X(O=>({...O,currentX:C}));return}if(!n){if(x){const N=m.current;if(!N)return;const C=N.getBoundingClientRect(),O=d-C.left,le=w-C.top;H(ge=>({...ge,currentX:O,currentY:le})),F.current&&(F.current.currentX=O,F.current.currentY=le);return}if(A){const N=d-A.startX;A.originalPositions.forEach((C,O)=>{const le=C.$x+N;o.exec("drag-task",{id:O,left:le,width:C.$w,inProgress:!0})}),z(C=>({...C,dx:N}));return}if(oe.current){const{node:N,x:C,id:O}=oe.current,le=oe.current.dx=d-C,ge=Math.round(le/N.offsetWidth*100);let Ee=oe.current.progress+ge;oe.current.value=Ee=Math.min(Math.max(0,Ee),100),o.exec("update-task",{id:O,task:{progress:Ee},inProgress:!0})}else if(V){he(null);const{mode:N,l:C,w:O,x:le,id:ge,start:Ee,segment:Ne,index:Ge}=V,Ae=o.getTask(ge),Le=d-le;if(!Ee&&Math.abs(Le)<20||N==="start"&&O-Le<ne||N==="end"&&O+Le<ne||N==="move"&&(Le<0&&C+Le<0||Le>0&&C+O+Le>pe)||V.segment&&!we.isSegmentMoveAllowed(Ae,V))return;const Ke={...V,dx:Le};let Ue,qe;if(N==="start"?(Ue=C+Le,qe=O-Le):N==="end"?(Ue=C,qe=O+Le):N==="move"&&(Ue=C+Le,qe=O),o.exec("drag-task",{id:ge,width:qe,left:Ue,inProgress:!0,...Ne&&{segmentIndex:Ge}}),!Ke.start&&(N==="move"&&Ae.$x==C||N!=="move"&&Ae.$w==O)){R.current=!0,ae();return}Ke.start=!0,ie(Ke)}else{const N=ve.locate(t);if(N){const C=o.getTask(ze(N)),le=ve.locate(t,"data-segment")||N,ge=K(le,u,C);le.style.cursor=ge&&!n?"col-resize":"pointer"}}}},[o,n,V,ne,pe,K,he,ae,x,A,g]),We=e.useCallback(t=>{je(t,t)},[je]),bt=e.useCallback(t=>{De?(t.preventDefault(),je(t,t.touches[0])):Re.current&&(clearTimeout(Re.current),Re.current=null)},[De,je]),Ve=e.useCallback(()=>{ae()},[ae]),yt=e.useCallback(()=>{Ie(null),Re.current&&(clearTimeout(Re.current),Re.current=null),ae()},[ae]);e.useEffect(()=>(window.addEventListener("mouseup",Ve),()=>{window.removeEventListener("mouseup",Ve)}),[Ve]);const Tt=e.useCallback(t=>{if(!n){const u=ve.locateID(t.target);if(u&&!t.target.classList.contains("wx-link")){const d=ve.locateID(t.target,"data-segment");o.exec("show-editor",{id:u,...d!==null&&{segmentIndex:d}})}}},[o,n]),Ct=["e2s","s2s","e2e","s2e"],Xe=e.useCallback((t,u)=>Ct[(t?1:0)+(u?0:2)],[]),Fe=e.useCallback((t,u)=>{const d=p.id,w=p.start;return t===d?!0:!!Y.find(j=>j.target==t&&j.source==d&&j.type===Xe(w,u))},[p,q,Xe]),et=e.useCallback(()=>{p&&ue(null)},[p]),tt=e.useCallback((t,u,d)=>{if(!u.length||!t||d==null)return;console.log("[paste] executePaste called:",{targetDate:t.toISOString(),taskCount:u.length,parent:d});const w=864e5,j=o.getHistory();j?.startBatch();const N=new Date(t);N.setUTCHours(0,0,0,0),console.log("[paste] scalesValue:",{start:P?.start?.toISOString?.(),lengthUnit:P?.lengthUnit,lengthUnitWidth:P?.lengthUnitWidth}),u.forEach((C,O)=>{const le=`task-${Date.now()}-${O}`;console.log("[paste] task input:",{text:C.text,_startCellOffset:C._startCellOffset,_startDayOfWeek:C._startDayOfWeek,_durationDays:C._durationDays,start:C.start?.toISOString?.(),end:C.end?.toISOString?.()});const ge=zt(N,C._startCellOffset||0,P);console.log("[paste] cellOffset:",ge?.toISOString?.());const Ee=new Date(ge.getTime()+(C._startDayOfWeek||0)*w);Ee.setUTCHours(0,0,0,0);const Ne=new Date(Ee.getTime()+(C._durationDays||7)*w);Ne.setUTCHours(0,0,0,0),console.log("[paste] task calculated:",{text:C.text,newStart:Ee.toISOString(),newEnd:Ne.toISOString(),row:C.row}),o.exec("add-task",{task:{id:le,text:C.text,start:Ee,end:Ne,type:C.type||"task",parent:d,row:C.row},target:d,mode:"child",skipUndo:O>0})}),j?.endBatch()},[o,P]),St=e.useCallback(t=>{if(R.current){R.current=!1;return}if(g&&g.currentX!=null){const d=mt(g.currentX,P);d&&tt(d,g.tasks,g.parent),X(null);return}const u=ve.locateID(t.target);if(u){const d=o.getTask(u),w=v.find(N=>N.id===u);console.log("[click] task:",d?.text,"id:",u),console.log("[click] api.getTask:",{start:d?.start,end:d?.end,duration:d?.duration}),console.log("[click] rendered:",{start:w?.start,end:w?.end,$w:w?.$w,$x:w?.$x});const j=t.target.classList;if(j.contains("wx-link")){const N=j.contains("wx-left");if(!p){ue({id:u,start:N});return}p.id!==u&&!Fe(u,N)&&o.exec("add-link",{link:{source:p.id,target:u,type:Xe(p.start,N)}})}else if(j.contains("wx-delete-button-icon"))o.exec("delete-link",{id:de.id}),$e(null);else{let N;const C=ve.locate(t,"data-segment");C&&(N=C.dataset.segment*1),o.exec("select-task",{id:u,toggle:t.ctrlKey||t.metaKey,range:t.shiftKey,segmentIndex:N})}}et()},[o,p,q,de,Fe,Xe,et,g,P,tt]),vt=e.useCallback(t=>({left:`${t.$x}px`,top:`${t.$y}px`,width:`${t.$w}px`,height:`${t.$h}px`}),[]),Mt=e.useCallback(t=>({left:`${t.$x_base}px`,top:`${t.$y_base}px`,width:`${t.$w_base}px`,height:`${t.$h_base}px`}),[]),Et=e.useCallback(t=>{if(De||Re.current)return t.preventDefault(),!1},[De]),st=e.useMemo(()=>f.map(t=>t.id),[f]),nt=e.useCallback(t=>{let u=st.includes(t)?t:"task";return["task","milestone","summary"].includes(t)||(u=`task ${u}`),u},[st]),rt=e.useCallback(t=>{o.exec(t.action,t.data)},[o]),Qe=e.useCallback(t=>_&&M.byId(t).$critical,[_,M]),ot=e.useCallback(t=>{if(Z?.auto){const u=M.getSummaryId(t,!0),d=M.getSummaryId(p.id,!0);return p?.id&&!(Array.isArray(u)?u:[u]).includes(p.id)&&!(Array.isArray(d)?d:[d]).includes(t)}return p},[Z,M,p]),lt=e.useCallback(()=>{const t=o.getState()._selected;if(!t||!t.length)return;const u=864e5,d=t.map(O=>{const le=o.getTask(O.id);if(!le)return null;const ge=v.find(jt=>jt.id===O.id);if(!ge)return null;const{$x:Ee,$y:Ne,$h:Ge,$w:Ae,$skip:Le,$level:Ke,$index:Ue,$y_base:qe,$x_base:ms,$w_base:gs,$h_base:ws,$skip_baseline:ps,$critical:ks,$reorder:bs,...Rt}=ge,it=ge.end&&ge.start?Math.round((ge.end.getTime()-ge.start.getTime())/u):0,at=ge.start?(ge.start.getUTCDay()+6)%7:0;return console.log("[copy] task:",{id:le.id,text:le.text,start:ge.start?.toISOString?.(),end:ge.end?.toISOString?.(),durationDays:it,startDayOfWeek:at,$w:Ae,$h:Ge,row:ge.row,parent:ge.parent}),{...Rt,_durationDays:it,_startDayOfWeek:at,_originalWidth:Ae,_originalHeight:Ge}}).filter(Boolean);if(!d.length)return;const j=d[0].parent,N=d.filter(O=>O.parent===j);if(N.length===0)return;const C=N.reduce((O,le)=>le.start&&(!O||le.start<O)?le.start:O,null);Ye=N.map(O=>({...O,_startCellOffset:At(O.start,C,P)})),ht=j,Ze=C,console.log("[copy] clipboard stored:",{taskCount:Ye.length,baseDate:C?.toISOString?.(),parent:j,tasks:Ye.map(O=>({id:O.id,text:O.text,_startCellOffset:O._startCellOffset,_startDayOfWeek:O._startDayOfWeek,_durationDays:O._durationDays}))})},[o,P]);e.useEffect(()=>h?o.intercept("hotkey",u=>{if(u.key==="ctrl+c"||u.key==="meta+c")return lt(),!1;if(u.key==="ctrl+v"||u.key==="meta+v")return!Ye.length||!Ze||X({tasks:Ye,baseDate:Ze,parent:ht,currentX:ye.current}),!1}):void 0,[h,o,lt]),e.useEffect(()=>{if(!g)return;const t=u=>{u.key==="Escape"&&(u.preventDefault(),u.stopPropagation(),X(null))};return document.addEventListener("keydown",t,!0),()=>document.removeEventListener("keydown",t,!0)},[g]);const ct=e.useMemo(()=>{if(!x)return null;const t=Math.min(x.startX,x.currentX),u=Math.min(x.startY,x.currentY),d=Math.abs(x.currentX-x.startX),w=Math.abs(x.currentY-x.startY);return{left:`${t}px`,top:`${u}px`,width:`${d}px`,height:`${w}px`}},[x]);return c.jsxs("div",{className:"wx-GKbcLEGA wx-bars",style:{lineHeight:`${se.length?se[0].$h:0}px`},ref:m,onContextMenu:Et,onMouseDown:I,onMouseMove:We,onTouchStart:G,onTouchMove:bt,onTouchEnd:yt,onClick:St,onDoubleClick:Tt,onDragStart:t=>(t.preventDefault(),!1),children:[c.jsx(_t,{onSelectLink:he,selectedLink:de,readonly:n}),se.map(t=>{if(t.$skip&&t.$skip_baseline)return null;const u=Se.has(t.id),d=`wx-bar wx-${nt(t.type)}`+(De&&V&&t.id===V.id?" wx-touch":"")+(p&&p.id===t.id?" wx-selected":"")+(Oe.has(t.id)?" wx-selected":"")+(Qe(t.id)?" wx-critical":"")+(t.$reorder?" wx-reorder-task":"")+(J&&t.segments?" wx-split":"")+(u?" wx-collision":""),w="wx-link wx-left"+(p?" wx-visible":"")+(!p||!Fe(t.id,!0)&&ot(t.id)?" wx-target":"")+(p&&p.id===t.id&&p.start?" wx-selected":"")+(Qe(t.id)?" wx-critical":""),j="wx-link wx-right"+(p?" wx-visible":"")+(!p||!Fe(t.id,!1)&&ot(t.id)?" wx-target":"")+(p&&p.id===t.id&&!p.start?" wx-selected":"")+(Qe(t.id)?" wx-critical":"");return c.jsxs(e.Fragment,{children:[!t.$skip&&c.jsxs("div",{className:"wx-GKbcLEGA "+d,style:vt(t),"data-tooltip-id":t.id,"data-id":t.id,tabIndex:xe===t.id?0:-1,children:[n?null:t.id===de?.target&&de?.type[2]==="s"?c.jsx(be.Button,{type:"danger",css:"wx-left wx-delete-button wx-delete-link",children:c.jsx("i",{className:"wxi-close wx-delete-button-icon"})}):c.jsx("div",{className:"wx-GKbcLEGA "+w,children:c.jsx("div",{className:"wx-GKbcLEGA wx-inner"})}),t.type!=="milestone"?c.jsxs(c.Fragment,{children:[t.progress&&!(J&&t.segments)?c.jsx("div",{className:"wx-GKbcLEGA wx-progress-wrapper",children:c.jsx("div",{className:"wx-GKbcLEGA wx-progress-percent",style:{width:`${t.progress}%`}})}):null,!n&&!(J&&t.segments)?c.jsx("div",{className:"wx-GKbcLEGA wx-progress-marker",style:{left:`calc(${t.progress}% - 10px)`},children:t.progress}):null,r?c.jsx(r,{data:t,api:o,onAction:rt}):J&&t.segments?c.jsx(Ht,{task:t,type:nt(t.type)}):c.jsx("div",{className:"wx-GKbcLEGA wx-content",children:t.text||""}),u&&c.jsx("div",{className:"wx-GKbcLEGA wx-collision-warning",title:"This task overlaps with another task in the same row",children:"!"})]}):c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"wx-GKbcLEGA wx-content"}),r?c.jsx(r,{data:t,api:o,onAction:rt}):c.jsx("div",{className:"wx-GKbcLEGA wx-text-out",children:t.text})]}),n?null:t.id===de?.target&&de?.type[2]==="e"?c.jsx(be.Button,{type:"danger",css:"wx-right wx-delete-button wx-delete-link",children:c.jsx("i",{className:"wxi-close wx-delete-button-icon"})}):c.jsx("div",{className:"wx-GKbcLEGA "+j,children:c.jsx("div",{className:"wx-GKbcLEGA wx-inner"})})]}),B&&!t.$skip_baseline?c.jsx("div",{className:"wx-GKbcLEGA wx-baseline"+(t.type==="milestone"?" wx-milestone":""),style:Mt(t)}):null]},t.id)}),x&&ct&&c.jsx("div",{className:"wx-GKbcLEGA wx-marquee-selection",style:ct}),g&&g.currentX!=null&&g.tasks.map((t,u)=>{const w=(Math.floor(g.currentX/ne)+(t._startCellOffset||0))*ne,j=t._originalWidth||ne,N=t._originalHeight||te,C=Me.get(t.row)??(t.$y||0);return c.jsx("div",{className:"wx-GKbcLEGA wx-bar wx-task wx-paste-preview",style:{left:w,top:C,width:j,height:N},children:c.jsx("div",{className:"wx-GKbcLEGA wx-content",children:t.text})},`preview-${u}`)})]})}function qt(s){const{highlightTime:n}=s,r=e.useContext(He),i=D.useStore(r,"_scales");return c.jsx("div",{className:"wx-ZkvhDKir wx-scale",style:{width:i.width},children:(i?.rows||[]).map((l,W)=>c.jsx("div",{className:"wx-ZkvhDKir wx-row",style:{height:`${l.height}px`},children:(l.cells||[]).map((h,S)=>{const o=n?n(h.date,h.unit):"",v="wx-cell "+(h.css||"")+" "+(o||""),b=typeof h.value=="string"&&h.value.includes("<");return c.jsx("div",{className:"wx-ZkvhDKir "+v,style:{width:`${h.width}px`},...b?{dangerouslySetInnerHTML:{__html:h.value}}:{children:h.value}},S)})},W))})}const Yt=new Map;function Xt(s){const n=e.useRef(null),r=e.useRef(0),i=e.useRef(null),l=typeof window<"u"&&window.__RENDER_METRICS_ENABLED__;n.current===null&&(n.current=performance.now()),r.current++,e.useEffect(()=>{if(l)return cancelAnimationFrame(i.current),i.current=requestAnimationFrame(()=>{const W={label:s,time:performance.now()-n.current,renders:r.current,timestamp:Date.now()};Yt.set(s,W),window.dispatchEvent(new CustomEvent("render-metric",{detail:W}))}),()=>cancelAnimationFrame(i.current)})}function Ft(s){const{readonly:n,fullWidth:r,fullHeight:i,taskTemplate:l,cellBorders:W,highlightTime:h,multiTaskRows:S=!1,rowMapping:o=null,marqueeSelect:v=!1,copyPaste:b=!1,scrollToCurrentWeek:Y=!1,currentWeekColor:q=null,allowTaskIntersection:E=!0}=s,y=e.useContext(He),[f,P]=D.useStoreWithCounter(y,"_selected"),B=D.useStore(y,"scrollTop"),L=D.useStore(y,"cellHeight"),Q=D.useStore(y,"cellWidth"),T=D.useStore(y,"_scales"),_=D.useStore(y,"_markers"),M=D.useStore(y,"_scrollTask"),Z=D.useStore(y,"zoom"),J=D.useStore(y,"_tasks"),[ee,te]=e.useState(),se=e.useRef(null),ne=e.useRef(0),$=e.useRef(!1),R=1+(T?.rows?.length||0),p=e.useMemo(()=>{if(!S||!o||!J?.length)return null;const x=new Map,H=new Map,F=[];return J.forEach(A=>{const z=o.taskRows.get(A.id)??A.id;H.has(z)||(H.set(z,F.length),F.push(z))}),J.forEach(A=>{const z=o.taskRows.get(A.id)??A.id,me=H.get(z)??0;x.set(A.id,me*L)}),x},[J,S,o,L]),ue=e.useMemo(()=>{const x=[];return f&&f.length&&L&&f.forEach(H=>{const F=p?.get(H.id)??H.$y;x.push({height:`${L}px`,top:`${F-3}px`})}),x},[P,L,p]),V=e.useMemo(()=>Math.max(ee||0,i),[ee,i]);e.useEffect(()=>{const x=se.current;x&&typeof B=="number"&&(x.scrollTop=B)},[B]);const ie=()=>{oe()};function oe(x){const H=se.current;if(!H)return;const F={};F.left=H.scrollLeft,y.exec("scroll-chart",F)}function de(){const x=se.current,F=Math.ceil((ee||0)/(L||1))+1,A=Math.floor((x&&x.scrollTop||0)/(L||1)),z=Math.max(0,A-R),me=A+F+R,Te=z*(L||0);y.exec("render-data",{start:z,end:me,from:Te})}e.useEffect(()=>{de()},[ee,B]);const $e=e.useCallback(x=>{if(!x)return;const{id:H,mode:F}=x;if(F.toString().indexOf("x")<0)return;const A=se.current;if(!A)return;const{clientWidth:z}=A,me=y.getTask(H);if(me.$x+me.$w<A.scrollLeft)y.exec("scroll-chart",{left:me.$x-(Q||0)}),A.scrollLeft=me.$x-(Q||0);else if(me.$x>=z+A.scrollLeft){const Te=z<me.$w?Q||0:me.$w;y.exec("scroll-chart",{left:me.$x-z+Te}),A.scrollLeft=me.$x-z+Te}},[y,Q]);e.useEffect(()=>{$e(M)},[M]);function De(x){if(Z&&(x.ctrlKey||x.metaKey)){x.preventDefault();const H=se.current,F=x.clientX-(H?H.getBoundingClientRect().left:0);if(ne.current+=x.deltaY,Math.abs(ne.current)>=150){const z=-Math.sign(ne.current);ne.current=0,y.exec("zoom-scale",{dir:z,offset:F})}}}const Ie=e.useCallback(x=>{const H=h(x.date,x.unit);return H?{css:H,width:x.width}:null},[h]),Re=e.useMemo(()=>{if(!T||!h||!["hour","day","week"].includes(T.minUnit))return null;let H=0;return T.rows[T.rows.length-1].cells.map(F=>{const A=Ie(F),z=H;return H+=F.width,A?{...A,left:z}:null})},[T,h,Ie]),pe=e.useCallback(x=>{x.eventSource="chart",y.exec("hotkey",x)},[y]);e.useEffect(()=>{const x=se.current;if(!x)return;const H=()=>te(x.clientHeight);H();const F=new ResizeObserver(()=>H());return F.observe(x),()=>{F.disconnect()}},[se.current]);const fe=e.useRef(null);return e.useEffect(()=>{const x=se.current;if(x&&!fe.current)return fe.current=gt.hotkeys(x,{keys:{arrowup:!0,arrowdown:!0},exec:H=>pe(H)}),()=>{fe.current?.destroy(),fe.current=null}},[]),e.useEffect(()=>{const x=se.current;if(!x)return;const H=De;return x.addEventListener("wheel",H),()=>{x.removeEventListener("wheel",H)}},[De]),e.useEffect(()=>{if(!Y||$.current||!T||!se.current||!ee)return;const x=se.current,{clientWidth:H}=x,F=new Date,A=T.rows[T.rows.length-1]?.cells;if(!A)return;let z=-1,me=0;const Te=[];for(let X=0;X<A.length;X++){const ce=A[X];Te.push({left:me,width:ce.width});const ye=ce.date;if(ce.unit==="week"){const m=new Date(ye);m.setUTCDate(m.getUTCDate()+7),F>=ye&&F<m&&(z=X)}else ce.unit==="day"&&F.getUTCFullYear()===ye.getUTCFullYear()&&F.getUTCMonth()===ye.getUTCMonth()&&F.getUTCDate()===ye.getUTCDate()&&(z=X);me+=ce.width}let g=z;if(z>0&&(g=z-1),g>=0&&Te[g]){const X=Te[g],ce=Math.max(0,X.left);x.scrollLeft=ce,y.exec("scroll-chart",{left:ce}),$.current=!0}},[Y,T,ee,y]),Xt("chart"),c.jsxs("div",{className:"wx-mR7v2Xag wx-chart",tabIndex:-1,ref:se,onScroll:ie,children:[c.jsx(qt,{highlightTime:h,scales:T}),_&&_.length?c.jsx("div",{className:"wx-mR7v2Xag wx-markers",style:{height:`${V}px`},children:_.map((x,H)=>c.jsx("div",{className:`wx-mR7v2Xag wx-marker ${x.css||""}`,style:{left:`${x.left}px`},children:c.jsx("div",{className:"wx-mR7v2Xag wx-content",children:x.text})},H))}):null,c.jsxs("div",{className:"wx-mR7v2Xag wx-area",style:{width:`${r}px`,height:`${V}px`},children:[Re?c.jsx("div",{className:"wx-mR7v2Xag wx-gantt-holidays",style:{height:"100%"},children:Re.map((x,H)=>x?c.jsx("div",{className:"wx-mR7v2Xag "+x.css,style:{width:`${x.width}px`,left:`${x.left}px`}},H):null)}):null,c.jsx(Wt,{borders:W}),f&&f.length?f.map((x,H)=>x.$y?c.jsx("div",{className:"wx-mR7v2Xag wx-selected","data-id":x.id,style:ue[H]},x.id):null):null,c.jsx(Ut,{readonly:n,taskTemplate:l,multiTaskRows:S,rowMapping:o,marqueeSelect:v,copyPaste:b,allowTaskIntersection:E})]})]})}function Kt(s){const{position:n="after",size:r=4,dir:i="x",onMove:l,onDisplayChange:W,compactMode:h,containerWidth:S=0,leftThreshold:o=50,rightThreshold:v=50}=s,[b,Y]=D.useWritableProp(s.value??0),[q,E]=D.useWritableProp(s.display??"all");function y(ie){let oe=0;n=="center"?oe=r/2:n=="before"&&(oe=r);const de={size:[r+"px","auto"],p:[ie-oe+"px","0px"],p2:["auto","0px"]};if(i!="x")for(let $e in de)de[$e]=de[$e].reverse();return de}const[f,P]=e.useState(!1),[B,L]=e.useState(null),Q=e.useRef(0),T=e.useRef(),_=e.useRef(),M=e.useRef(q);e.useEffect(()=>{M.current=q},[q]),e.useEffect(()=>{B===null&&b>0&&L(b)},[B,b]);function Z(ie){return i=="x"?ie.clientX:ie.clientY}const J=e.useCallback(ie=>{const oe=T.current+Z(ie)-Q.current;Y(oe);let de;oe<=o?de="chart":S-oe<=v?de="grid":de="all",M.current!==de&&(E(de),M.current=de),_.current&&clearTimeout(_.current),_.current=setTimeout(()=>l&&l(oe),100)},[S,o,v,l]),ee=e.useCallback(()=>{document.body.style.cursor="",document.body.style.userSelect="",P(!1),window.removeEventListener("mousemove",J),window.removeEventListener("mouseup",ee)},[J]),te=e.useMemo(()=>q!=="all"?"auto":i=="x"?"ew-resize":"ns-resize",[q,i]),se=e.useCallback(ie=>{!h&&(q==="grid"||q==="chart")||(Q.current=Z(ie),T.current=b,P(!0),document.body.style.cursor=te,document.body.style.userSelect="none",window.addEventListener("mousemove",J),window.addEventListener("mouseup",ee))},[te,J,ee,b,h,q]);function ne(){E("all"),B!==null&&(Y(B),l&&l(B))}function $(ie){if(h){const oe=q==="chart"?"grid":"chart";E(oe),W(oe)}else if(q==="grid"||q==="chart")ne(),W("all");else{const oe=ie==="left"?"chart":"grid";E(oe),W(oe)}}function R(){$("left")}function p(){$("right")}const ue=e.useMemo(()=>y(b),[b,n,r,i]),V=["wx-resizer",`wx-resizer-${i}`,`wx-resizer-display-${q}`,f?"wx-resizer-active":""].filter(Boolean).join(" ");return c.jsxs("div",{className:"wx-pFykzMlT "+V,onMouseDown:se,style:{width:ue.size[0],height:ue.size[1],cursor:te},children:[c.jsxs("div",{className:"wx-pFykzMlT wx-button-expand-box",children:[c.jsx("div",{className:"wx-pFykzMlT wx-button-expand-content wx-button-expand-left",children:c.jsx("i",{className:"wx-pFykzMlT wxi-menu-left",onClick:R})}),c.jsx("div",{className:"wx-pFykzMlT wx-button-expand-content wx-button-expand-right",children:c.jsx("i",{className:"wx-pFykzMlT wxi-menu-right",onClick:p})})]}),c.jsx("div",{className:"wx-pFykzMlT wx-resizer-line"})]})}const Bt=650;function pt(s){let n;function r(){n=new ResizeObserver(l=>{for(let W of l)if(W.target===document.body){let h=W.contentRect.width<=Bt;s(h)}}),n.observe(document.body)}function i(){n&&(n.disconnect(),n=null)}return{observe:r,disconnect:i}}function Vt(s){const{taskTemplate:n,readonly:r,cellBorders:i,highlightTime:l,onTableAPIChange:W,multiTaskRows:h=!1,rowMapping:S=null,marqueeSelect:o=!1,copyPaste:v=!1,scrollToCurrentWeek:b=!1,currentWeekColor:Y=null,allowTaskIntersection:q=!0}=s,E=e.useContext(He),y=D.useStore(E,"_tasks"),f=D.useStore(E,"_scales"),P=D.useStore(E,"cellHeight"),B=D.useStore(E,"columns"),L=D.useStore(E,"_scrollTask"),Q=D.useStore(E,"undo"),T=e.useMemo(()=>{if(!h)return S;const g=new Map,X=new Map;return y.forEach(ce=>{const ye=ce.row??ce.id;X.set(ce.id,ye),g.has(ye)||g.set(ye,[]),g.get(ye).push(ce.id)}),{rowMap:g,taskRows:X}},[y,h,S]),[_,M]=e.useState(!1);let[Z,J]=e.useState(0);const[ee,te]=e.useState(0),[se,ne]=e.useState(0),[$,R]=e.useState(void 0),[p,ue]=e.useState("all"),V=e.useRef(null),ie=e.useCallback(g=>{M(X=>(g!==X&&(g?(V.current=p,p==="all"&&ue("grid")):(!V.current||V.current==="all")&&ue("all")),g))},[p]);e.useEffect(()=>{const g=pt(ie);return g.observe(),()=>{g.disconnect()}},[ie]);const oe=e.useMemo(()=>{let g;return B.every(X=>X.width&&!X.flexgrow)?g=B.reduce((X,ce)=>X+parseInt(ce.width),0):_&&p==="chart"?g=parseInt(B.find(X=>X.id==="action")?.width)||50:g=440,Z=g,g},[B,_,p]);e.useEffect(()=>{J(oe)},[oe]);const de=e.useMemo(()=>(ee??0)-($??0),[ee,$]),$e=e.useMemo(()=>f.width,[f]),De=e.useMemo(()=>{if(!h||!T)return y.length*P;const g=new Set;return y.forEach(X=>{const ce=T.taskRows.get(X.id)??X.id;g.add(ce)}),g.size*P},[y,P,h,T]),Ie=e.useMemo(()=>f.height+De+de,[f,De,de]),Re=e.useMemo(()=>Z+$e,[Z,$e]),pe=e.useRef(null),fe=e.useCallback(()=>{Promise.resolve().then(()=>{if((ee??0)>(Re??0)){const g=(ee??0)-Z;E.exec("expand-scale",{minWidth:g})}})},[ee,Re,Z,E]);e.useEffect(()=>{let g;return pe.current&&(g=new ResizeObserver(fe),g.observe(pe.current)),()=>{g&&g.disconnect()}},[pe.current,fe]),e.useEffect(()=>{fe()},[$e]);const x=e.useRef(null),H=e.useRef(null),F=e.useCallback(()=>{const g=x.current;g&&E.exec("scroll-chart",{top:g.scrollTop})},[E]),A=e.useRef({rTasks:[],rScales:{height:0},rCellHeight:0,scrollSize:0,ganttDiv:null,ganttHeight:0});e.useEffect(()=>{A.current={rTasks:y,rScales:f,rCellHeight:P,scrollSize:de,ganttDiv:x.current,ganttHeight:se??0}},[y,f,P,de,se]);const z=e.useCallback(g=>{if(!g)return;const{rTasks:X,rScales:ce,rCellHeight:ye,scrollSize:m,ganttDiv:re,ganttHeight:xe}=A.current;if(!re)return;const{id:U}=g,Ce=X.findIndex(K=>K.id===U);if(Ce>-1){const K=xe-ce.height,Se=Ce*ye,ke=re.scrollTop;let Me=null;Se<ke?Me=Se:Se+ye>ke+K&&(Me=Se-K+ye+m),Me!==null&&(E.exec("scroll-chart",{top:Math.max(Me,0)}),x.current.scrollTop=Math.max(Me,0))}},[E]);e.useEffect(()=>{z(L)},[L]),e.useEffect(()=>{const g=x.current,X=H.current;if(!g||!X)return;const ce=()=>{$t.flushSync(()=>{ne(g.offsetHeight),te(g.offsetWidth),R(X.offsetWidth)})},ye=new ResizeObserver(ce);return ye.observe(g),()=>ye.disconnect()},[x.current]);const me=e.useRef(null),Te=e.useRef(null);return e.useEffect(()=>{Te.current&&(Te.current.destroy(),Te.current=null);const g=me.current;if(g)return Te.current=gt.hotkeys(g,{keys:{"ctrl+c":!0,"ctrl+v":!0,"ctrl+x":!0,"ctrl+d":!0,"meta+c":!0,"meta+v":!0,"meta+x":!0,"meta+d":!0,backspace:!0,"ctrl+z":Q,"ctrl+y":Q,"meta+z":Q,"meta+shift+z":Q},exec:X=>{if(X.isInput)return;const ce=X.key;if(ce==="ctrl+z"||ce==="meta+z"){E.exec("undo",{});return}if(ce==="ctrl+y"||ce==="meta+shift+z"){E.exec("redo",{});return}E.exec("hotkey",X)}}),()=>{Te.current?.destroy(),Te.current=null}},[Q]),c.jsx("div",{className:"wx-jlbQoHOz wx-gantt",ref:x,onScroll:F,children:c.jsx("div",{className:"wx-jlbQoHOz wx-pseudo-rows",style:{height:Ie,width:"100%"},ref:H,children:c.jsx("div",{className:"wx-jlbQoHOz wx-stuck",style:{height:se,width:$},children:c.jsxs("div",{tabIndex:0,className:"wx-jlbQoHOz wx-layout",ref:me,children:[B.length?c.jsxs(c.Fragment,{children:[c.jsx(Ot,{display:p,compactMode:_,columnWidth:oe,width:Z,readonly:r,fullHeight:De,onTableAPIChange:W,multiTaskRows:h,rowMapping:T}),c.jsx(Kt,{value:Z,display:p,compactMode:_,containerWidth:ee,onMove:g=>J(g),onDisplayChange:g=>ue(g)})]}):null,c.jsx("div",{className:"wx-jlbQoHOz wx-content",ref:pe,children:c.jsx(Ft,{readonly:r,fullWidth:$e,fullHeight:De,taskTemplate:n,cellBorders:i,highlightTime:l,multiTaskRows:h,rowMapping:T,marqueeSelect:o,copyPaste:v,scrollToCurrentWeek:b,currentWeekColor:Y,allowTaskIntersection:q})})]})})})})}function Qt(s){return{year:"%Y",quarter:`${s("Q")} %Q`,month:"%M",week:`${s("Week")} %w`,day:"%M %j",hour:"%H:%i"}}function Zt(s,n){return typeof s=="function"?s:ve.dateToString(s,n)}function kt(s,n){return s.map(({format:r,...i})=>({...i,format:Zt(r,n)}))}function Jt(s,n){const r=Qt(n);for(let i in r)r[i]=ve.dateToString(r[i],s);return r}function es(s,n){if(!s||!s.length)return s;const r=ve.dateToString("%d-%m-%Y",n);return s.map(i=>i.template?i:i.id==="start"||i.id=="end"?{...i,_template:l=>r(l),template:l=>r(l)}:i.id==="duration"?{...i,_template:l=>l,template:l=>l}:i)}function ts(s,n){return s.levels?{...s,levels:s.levels.map(r=>({...r,scales:kt(r.scales,n)}))}:s}const ss=s=>s.split("-").map(n=>n?n.charAt(0).toUpperCase()+n.slice(1):"").join(""),ns=[{unit:"month",step:1,format:"%F %Y"},{unit:"day",step:1,format:"%j"}],rs=e.forwardRef(function({taskTemplate:n=null,markers:r=[],taskTypes:i=we.defaultTaskTypes,tasks:l=[],selected:W=[],activeTask:h=null,links:S=[],scales:o=ns,columns:v=we.defaultColumns,start:b=null,end:Y=null,lengthUnit:q="day",durationUnit:E="day",cellWidth:y=100,cellHeight:f=38,scaleHeight:P=36,readonly:B=!1,cellBorders:L="full",zoom:Q=!1,baselines:T=!1,highlightTime:_=null,init:M=null,autoScale:Z=!0,unscheduledTasks:J=!1,criticalPath:ee=null,schedule:te={type:"forward"},projectStart:se=null,projectEnd:ne=null,calendar:$=null,undo:R=!1,splitTasks:p=!1,multiTaskRows:ue=!1,marqueeSelect:V=!1,copyPaste:ie=!1,currentWeekHighlight:oe=!1,currentWeekColor:de=null,scrollToCurrentWeek:$e=!1,allowTaskIntersection:De=!0,...Ie},Re){const pe=e.useRef();pe.current=Ie;const fe=e.useMemo(()=>new we.DataStore(D.writable),[]),x=e.useMemo(()=>({...Je.en,...Be.en}),[]),H=e.useContext(be.context.i18n),F=e.useMemo(()=>H?H.extend(x,!0):ve.locale(x),[H,x]),A=e.useMemo(()=>F.getRaw().calendar,[F]),z=e.useMemo(()=>{let K={zoom:ts(Q,A),scales:kt(o,A),columns:es(v,A),links:we.normalizeLinks(S),cellWidth:y};return K.zoom&&(K={...K,...we.normalizeZoom(K.zoom,Jt(A,F.getGroup("gantt")),K.scales,y)}),K},[Q,o,v,S,y,A,F]),me=e.useRef(null);me.current!==l&&(we.parseTaskDates(l,{durationUnit:E,splitTasks:p,calendar:$}),me.current=l),e.useEffect(()=>{we.parseTaskDates(l,{durationUnit:E,splitTasks:p,calendar:$})},[l,E,$,p]);const Te=e.useMemo(()=>{if(!ue)return null;const K=new Map,Se=new Map,ke=Me=>{Me.forEach(Pe=>{const Oe=Pe.row??Pe.id;Se.set(Pe.id,Oe),K.has(Oe)||K.set(Oe,[]),K.get(Oe).push(Pe.id),Pe.data&&Pe.data.length>0&&ke(Pe.data)})};return ke(l),{rowMap:K,taskRows:Se}},[l,ue]),g=e.useMemo(()=>fe.in,[fe]),X=e.useRef(null);X.current===null&&(X.current=new Dt.EventBusRouter((K,Se)=>{const ke="on"+ss(K);pe.current&&pe.current[ke]&&pe.current[ke](Se)}),g.setNext(X.current));const[ce,ye]=e.useState(null),m=e.useRef(null);m.current=ce;const re=e.useMemo(()=>({getState:fe.getState.bind(fe),getReactiveState:fe.getReactive.bind(fe),getStores:()=>({data:fe}),exec:g.exec,setNext:K=>(X.current=X.current.setNext(K),X.current),intercept:g.intercept.bind(g),on:g.on.bind(g),detach:g.detach.bind(g),getTask:fe.getTask.bind(fe),serialize:fe.serialize.bind(fe),getTable:K=>K?new Promise(Se=>setTimeout(()=>Se(m.current),1)):m.current,getHistory:()=>fe.getHistory()}),[fe,g]);e.useImperativeHandle(Re,()=>({...re}),[re]);const xe=e.useRef(0);e.useEffect(()=>{xe.current?fe.init({tasks:l,links:z.links,start:b,columns:z.columns,end:Y,lengthUnit:q,cellWidth:z.cellWidth,cellHeight:f,scaleHeight:P,scales:z.scales,taskTypes:i,zoom:z.zoom,selected:W,activeTask:h,baselines:T,autoScale:Z,unscheduledTasks:J,markers:r,durationUnit:E,criticalPath:ee,schedule:te,projectStart:se,projectEnd:ne,calendar:$,undo:R,_weekStart:A.weekStart,splitTasks:p}):M&&M(re),xe.current++},[re,M,l,z,b,Y,q,f,P,i,W,h,T,Z,J,r,E,ee,te,se,ne,$,R,A,p,fe]),xe.current===0&&fe.init({tasks:l,links:z.links,start:b,columns:z.columns,end:Y,lengthUnit:q,cellWidth:z.cellWidth,cellHeight:f,scaleHeight:P,scales:z.scales,taskTypes:i,zoom:z.zoom,selected:W,activeTask:h,baselines:T,autoScale:Z,unscheduledTasks:J,markers:r,durationUnit:E,criticalPath:ee,schedule:te,projectStart:se,projectEnd:ne,calendar:$,undo:R,_weekStart:A.weekStart,splitTasks:p});const U=e.useMemo(()=>{const K=new Date,Se=A?.weekStart??0,ke=new Date(Date.UTC(K.getUTCFullYear(),K.getUTCMonth(),K.getUTCDate())),Pe=(ke.getUTCDay()-Se+7)%7;ke.setUTCDate(ke.getUTCDate()-Pe),ke.setUTCHours(0,0,0,0);const Oe=new Date(ke);return Oe.setUTCDate(Oe.getUTCDate()+7),a=>a>=ke&&a<Oe},[A]),Ce=e.useMemo(()=>(K,Se)=>{let ke=[];if($)Se=="day"&&!$.getDayHours(K)&&ke.push("wx-weekend"),Se=="hour"&&!$.getDayHours(K)&&ke.push("wx-weekend");else if(_){const Me=_(K,Se);Me&&ke.push(Me)}return oe&&(Se==="week"||Se==="day")&&U(K)&&ke.push("wx-current-week"),ke.join(" ")},[$,_,oe,U]);return c.jsx(be.context.i18n.Provider,{value:F,children:c.jsx(He.Provider,{value:re,children:c.jsx(Vt,{taskTemplate:n,readonly:B,cellBorders:L,highlightTime:Ce,onTableAPIChange:ye,multiTaskRows:ue,rowMapping:Te,marqueeSelect:V,copyPaste:ie,scrollToCurrentWeek:$e,currentWeekColor:de,allowTaskIntersection:De})})})});function os({api:s=null,items:n=[]}){const r=e.useContext(be.context.i18n),i=e.useMemo(()=>r||ve.locale(Be.en),[r]),l=e.useMemo(()=>i.getGroup("gantt"),[i]),W=D.useStoreLater(s,"_selected"),h=D.useStoreLater(s,"undo"),S=D.useStoreLater(s,"history"),o=D.useStoreLater(s,"splitTasks"),v=["undo","redo"],b=e.useMemo(()=>{const q=we.getToolbarButtons({undo:!0,splitTasks:!0});return(n.length?n:we.getToolbarButtons({undo:h,splitTasks:o})).map(y=>{let f={...y,disabled:!1};return f.handler=we.isHandledAction(q,f.id)?P=>we.handleAction(s,P.id,null,l):f.handler,f.text&&(f.text=l(f.text)),f.menuText&&(f.menuText=l(f.menuText)),f})},[n,s,l,h,o]),Y=e.useMemo(()=>{const q=[];return b.forEach(E=>{const y=E.id;if(y==="add-task")q.push(E);else if(v.includes(y))v.includes(y)&&q.push({...E,disabled:E.isDisabled(S)});else{if(!W?.length||!s)return;q.push({...E,disabled:E.isDisabled&&W.some(f=>E.isDisabled(f,s.getState()))})}}),q.filter((E,y)=>{if(s&&E.isHidden)return!W.some(f=>E.isHidden(f,s.getState()));if(E.comp==="separator"){const f=q[y+1];if(!f||f.comp==="separator")return!1}return!0})},[s,W,S,b]);return r?c.jsx(ut.Toolbar,{items:Y}):c.jsx(be.context.i18n.Provider,{value:i,children:c.jsx(ut.Toolbar,{items:Y})})}const ls=e.forwardRef(function({options:n=[],api:r=null,resolver:i=null,filter:l=null,at:W="point",children:h,onClick:S,css:o},v){const b=e.useRef(null),Y=e.useRef(null),q=e.useContext(be.context.i18n),E=e.useMemo(()=>q||ve.locale({...Be.en,...Je.en}),[q]),y=e.useMemo(()=>E.getGroup("gantt"),[E]),f=D.useStoreLater(r,"taskTypes"),P=D.useStoreLater(r,"selected"),B=D.useStoreLater(r,"_selected"),L=D.useStoreLater(r,"splitTasks"),Q=e.useMemo(()=>we.getMenuOptions({splitTasks:!0}),[]);e.useEffect(()=>{r&&(r.on("scroll-chart",()=>{b.current&&b.current.show&&b.current.show()}),r.on("drag-task",()=>{b.current&&b.current.show&&b.current.show()}))},[r]);function T($){return $.map(R=>(R={...R},R.text&&(R.text=y(R.text)),R.subtext&&(R.subtext=y(R.subtext)),R.data&&(R.data=T(R.data)),R))}function _(){const $=n.length?n:we.getMenuOptions({splitTasks:L}),R=$.find(p=>p.id==="convert-task");return R&&(R.data=[],(f||[]).forEach(p=>{R.data.push(R.dataFactory(p))})),T($)}const M=e.useMemo(()=>_(),[r,n,f,L,y]),Z=e.useMemo(()=>B&&B.length?B:[],[B]),J=e.useCallback(($,R)=>{let p=$?r?.getTask($):null;if(i){const ue=i($,R);p=ue===!0?p:ue}if(p){const ue=ve.locateID(R.target,"data-segment");ue!==null?Y.current={id:p.id,segmentIndex:ue}:Y.current=p.id,(!Array.isArray(P)||!P.includes(p.id))&&r&&r.exec&&r.exec("select-task",{id:p.id})}return p},[r,i,P]),ee=e.useCallback($=>{const R=$.action;R&&(we.isHandledAction(Q,R.id)&&we.handleAction(r,R.id,Y.current,y),S&&S($))},[r,y,S,Q]),te=e.useCallback(($,R)=>{const p=Z.length?Z:R?[R]:[];let ue=l?p.every(V=>l($,V)):!0;if(ue&&($.isHidden&&(ue=!p.some(V=>$.isHidden(V,r.getState(),Y.current))),$.isDisabled)){const V=p.some(ie=>$.isDisabled(ie,r.getState(),Y.current));$.disabled=V}return ue},[l,Z,r]);e.useImperativeHandle(v,()=>({show:($,R)=>{b.current&&b.current.show&&b.current.show($,R)}}));const se=e.useCallback($=>{b.current&&b.current.show&&b.current.show($)},[]),ne=c.jsxs(c.Fragment,{children:[c.jsx(It.ContextMenu,{filter:te,options:M,dataKey:"id",resolver:J,onClick:ee,at:W,ref:b,css:o}),c.jsx("span",{onContextMenu:se,"data-menu-ignore":"true",children:typeof h=="function"?h():h})]});if(!q&&be.context.i18n?.Provider){const $=be.context.i18n.Provider;return c.jsx($,{value:E,children:ne})}return ne});function cs({api:s,autoSave:n,onLinksChange:r}){const l=e.useContext(be.context.i18n).getGroup("gantt"),W=D.useStore(s,"activeTask"),h=D.useStore(s,"_activeTask"),S=D.useStore(s,"_links"),o=D.useStore(s,"schedule"),v=D.useStore(s,"unscheduledTasks"),[b,Y]=e.useState();function q(){if(W){const P=S.filter(L=>L.target==W).map(L=>({link:L,task:s.getTask(L.source)})),B=S.filter(L=>L.source==W).map(L=>({link:L,task:s.getTask(L.target)}));return[{title:l("Predecessors"),data:P},{title:l("Successors"),data:B}]}}e.useEffect(()=>{Y(q())},[W,S]);const E=e.useMemo(()=>[{id:"e2s",label:l("End-to-start")},{id:"s2s",label:l("Start-to-start")},{id:"e2e",label:l("End-to-end")},{id:"s2e",label:l("Start-to-end")}],[l]);function y(P){n?s.exec("delete-link",{id:P}):(Y(B=>(B||[]).map(L=>({...L,data:L.data.filter(Q=>Q.link.id!==P)}))),r&&r({id:P,action:"delete-link",data:{id:P}}))}function f(P,B){n?s.exec("update-link",{id:P,link:B}):(Y(L=>(L||[]).map(Q=>({...Q,data:Q.data.map(T=>T.link.id===P?{...T,link:{...T.link,...B}}:T)}))),r&&r({id:P,action:"update-link",data:{id:P,link:B}}))}return c.jsx(c.Fragment,{children:(b||[]).map((P,B)=>P.data.length?c.jsx("div",{className:"wx-j93aYGQf wx-links",children:c.jsx(be.Field,{label:P.title,position:"top",children:c.jsx("table",{children:c.jsx("tbody",{children:P.data.map(L=>c.jsxs("tr",{children:[c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("div",{className:"wx-j93aYGQf wx-task-name",children:L.task.text||""})}),o?.auto&&L.link.type==="e2s"?c.jsx("td",{className:"wx-j93aYGQf wx-cell wx-link-lag",children:c.jsx(be.Text,{type:"number",placeholder:l("Lag"),value:L.link.lag,disabled:v&&h?.unscheduled,onChange:Q=>{Q.input||f(L.link.id,{lag:Q.value})}})}):null,c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("div",{className:"wx-j93aYGQf wx-wrapper",children:c.jsx(be.Combo,{value:L.link.type,placeholder:l("Select link type"),options:E,onChange:Q=>f(L.link.id,{type:Q.value}),children:({option:Q})=>Q.label})})}),c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("i",{className:"wx-j93aYGQf wxi-delete wx-delete-icon",onClick:()=>y(L.link.id),role:"button"})})]},L.link.id))})})})},B):null)})}function is(s){const{value:n,time:r,format:i,onchange:l,onChange:W,...h}=s,S=W??l;function o(v){const b=new Date(v.value);b.setUTCHours(n.getUTCHours()),b.setUTCMinutes(n.getUTCMinutes()),S&&S({value:b})}return c.jsxs("div",{className:"wx-hFsbgDln date-time-controll",children:[c.jsx(be.DatePicker,{...h,value:n,onChange:o,format:i,buttons:["today"],clear:!1}),r?c.jsx(be.TimePicker,{value:n,onChange:S,format:i}):null]})}_e.registerEditorItem("select",be.RichSelect);_e.registerEditorItem("date",is);_e.registerEditorItem("twostate",be.TwoState);_e.registerEditorItem("slider",be.Slider);_e.registerEditorItem("counter",be.Counter);_e.registerEditorItem("links",cs);function as({api:s,items:n=[],css:r="",layout:i="default",readonly:l=!1,placement:W="sidebar",bottomBar:h=!0,topBar:S=!0,autoSave:o=!0,focus:v=!1,hotkeys:b={}}){const Y=e.useContext(be.context.i18n),q=e.useMemo(()=>Y||ve.locale({...Be.en,...Je.en}),[Y]),E=e.useMemo(()=>q.getGroup("gantt"),[q]),y=q.getRaw(),f=e.useMemo(()=>{const m=y.gantt?.dateFormat||y.formats?.dateFormat;return ve.dateToString(m,y.calendar)},[y]),P=e.useMemo(()=>{if(S===!0&&!l){const m=[{comp:"icon",icon:"wxi-close",id:"close"},{comp:"spacer"},{comp:"button",type:"danger",text:E("Delete"),id:"delete"}];return o?{items:m}:{items:[...m,{comp:"button",type:"primary",text:E("Save"),id:"save"}]}}return S},[S,l,o,E]),[B,L]=e.useState(!1),Q=e.useMemo(()=>B?"wx-full-screen":"",[B]),T=e.useCallback(m=>{L(m)},[]);e.useEffect(()=>{const m=pt(T);return m.observe(),()=>{m.disconnect()}},[T]);const _=D.useStore(s,"_activeTask"),M=D.useStore(s,"activeTask"),Z=D.useStore(s,"unscheduledTasks"),J=D.useStore(s,"links"),ee=D.useStore(s,"splitTasks"),te=e.useMemo(()=>ee&&M?.segmentIndex,[ee,M]),se=e.useMemo(()=>te||te===0,[te]),ne=e.useMemo(()=>we.getEditorItems({unscheduledTasks:Z}),[Z]),$=D.useStore(s,"undo"),[R,p]=e.useState({}),[ue,V]=e.useState(null),[ie,oe]=e.useState(),[de,$e]=e.useState(null),De=D.useStore(s,"taskTypes"),Ie=e.useMemo(()=>{if(!_)return null;let m;if(se&&_.segments?m={..._.segments[te]}:m={..._},l){let re={parent:m.parent};return ne.forEach(({key:xe,comp:U})=>{if(U!=="links"){const Ce=m[xe];U==="date"&&Ce instanceof Date?re[xe]=f(Ce):U==="slider"&&xe==="progress"?re[xe]=`${Ce}%`:re[xe]=Ce}}),re}return m||null},[_,se,te,l,ne,f]);e.useEffect(()=>{oe(Ie)},[Ie]),e.useEffect(()=>{p({}),$e(null),V(null)},[M]);function Re(m,re){return m.map(xe=>{const U={...xe};if(xe.config&&(U.config={...U.config}),U.comp==="links"&&s&&(U.api=s,U.autoSave=o,U.onLinksChange=x),U.comp==="select"&&U.key==="type"){const Ce=U.options??(De||[]);U.options=Ce.map(K=>({...K,label:E(K.label)}))}return U.comp==="slider"&&U.key==="progress"&&(U.labelTemplate=Ce=>`${E(U.label)} ${Ce}%`),U.label&&(U.label=E(U.label)),U.config?.placeholder&&(U.config.placeholder=E(U.config.placeholder)),re&&(U.isDisabled&&U.isDisabled(re,s.getState())?U.disabled=!0:delete U.disabled),U})}const pe=e.useMemo(()=>{let m=n.length?n:ne;return m=Re(m,ie),ie?m.filter(re=>!re.isHidden||!re.isHidden(ie,s.getState())):m},[n,ne,ie,De,E,s,o]),fe=e.useMemo(()=>pe.map(m=>m.key),[pe]);function x({id:m,action:re,data:xe}){p(U=>({...U,[m]:{action:re,data:xe}}))}const H=e.useCallback(()=>{for(let m in R)if(J.byId(m)){const{action:re,data:xe}=R[m];s.exec(re,xe)}},[s,R,J]),F=e.useCallback(()=>{const m=M?.id||M;if(se){if(_?.segments){const re=_.segments.filter((xe,U)=>U!==te);s.exec("update-task",{id:m,task:{segments:re}})}}else s.exec("delete-task",{id:m})},[s,M,se,_,te]),A=e.useCallback(()=>{s.exec("show-editor",{id:null})},[s]),z=e.useCallback(m=>{const{item:re,changes:xe}=m;re.id==="delete"&&F(),re.id==="save"&&(xe.length?A():H()),re.comp&&A()},[s,M,o,H,F,A]),me=e.useCallback((m,re,xe)=>(Z&&m.type==="summary"&&(m.unscheduled=!1),we.prepareEditTask(m,s.getState(),re),xe||V(!1),m),[Z,s]),Te=e.useCallback(m=>{m={...m,unscheduled:Z&&m.unscheduled&&m.type!=="summary"},delete m.links,delete m.data,(fe.indexOf("duration")===-1||m.segments&&!m.duration)&&delete m.duration;const re={id:M?.id||M,task:m,...se&&{segmentIndex:te}};o&&ue&&(re.inProgress=ue),s.exec("update-task",re),o||H()},[s,M,Z,o,H,fe,se,te,ue]),g=e.useCallback(m=>{let{update:re,key:xe,input:U}=m;if(U&&V(!0),m.update=me({...re},xe,U),!o)oe(m.update);else if(!de&&!U){const Ce=pe.find(ke=>ke.key===xe),K=re[xe];(!Ce.validation||Ce.validation(K))&&(!Ce.required||K)&&Te(m.update)}},[o,me,de,pe,Te]),X=e.useCallback(m=>{o||Te(m.values)},[o,Te]),ce=e.useCallback(m=>{$e(m.errors)},[]),ye=e.useMemo(()=>$?{"ctrl+z":m=>{m.preventDefault(),s.exec("undo")},"ctrl+y":m=>{m.preventDefault(),s.exec("redo")}}:{},[$,s]);return Ie?c.jsx(be.Locale,{children:c.jsx(_e.Editor,{css:`wx-XkvqDXuw wx-gantt-editor ${Q} ${r}`,items:pe,values:Ie,topBar:P,bottomBar:h,placement:W,layout:i,readonly:l,autoSave:o,focus:v,onAction:z,onSave:X,onValidation:ce,onChange:g,hotkeys:b&&{...ye,...b}})}):null}const us=({children:s,columns:n=null,api:r})=>{const[i,l]=e.useState(null);return e.useEffect(()=>{r&&r.getTable(!0).then(l)},[r]),c.jsx(wt.HeaderMenu,{api:i,columns:n,children:s})};function ds(s){const{api:n,content:r,children:i}=s,l=e.useRef(null),W=e.useRef(null),[h,S]=e.useState({}),[o,v]=e.useState(null),[b,Y]=e.useState({});function q(T){for(;T;){if(T.getAttribute){const _=T.getAttribute("data-tooltip-id"),M=T.getAttribute("data-tooltip-at"),Z=T.getAttribute("data-tooltip");if(_||Z)return{id:_,tooltip:Z,target:T,at:M}}T=T.parentNode}return{id:null,tooltip:null,target:null,at:null}}e.useEffect(()=>{const T=W.current;if(T&&b&&(b.text||r)){const _=T.getBoundingClientRect();let M=!1,Z=b.left,J=b.top;_.right>=h.right&&(Z=h.width-_.width-5,M=!0),_.bottom>=h.bottom&&(J=b.top-(_.bottom-h.bottom+2),M=!0),M&&Y(ee=>ee&&{...ee,left:Z,top:J})}},[b,h,r]);const E=e.useRef(null),y=300,f=T=>{clearTimeout(E.current),E.current=setTimeout(()=>{T()},y)};function P(T){let{id:_,tooltip:M,target:Z,at:J}=q(T.target);if(Y(null),v(null),!M)if(_)M=L(_);else{clearTimeout(E.current);return}const ee=T.clientX;f(()=>{_&&v(B(Q(_)));const te=Z.getBoundingClientRect(),se=l.current,ne=se?se.getBoundingClientRect():{top:0,left:0,right:0,bottom:0,width:0,height:0};let $,R;J==="left"?($=te.top+5-ne.top,R=te.right+5-ne.left):($=te.top+te.height-ne.top,R=ee-ne.left),S(ne),Y({top:$,left:R,text:M})})}function B(T){return n?.getTask(Q(T))||null}function L(T){return B(T)?.text||""}function Q(T){const _=parseInt(T);return isNaN(_)?T:_}return c.jsxs("div",{className:"wx-KG0Lwsqo wx-tooltip-area",ref:l,onMouseMove:P,children:[b&&(b.text||r)?c.jsx("div",{className:"wx-KG0Lwsqo wx-gantt-tooltip",ref:W,style:{top:`${b.top}px`,left:`${b.left}px`},children:r?c.jsx(r,{data:o}):b.text?c.jsx("div",{className:"wx-KG0Lwsqo wx-gantt-tooltip-text",children:b.text}):null}):null,i]})}function fs({fonts:s=!0,children:n}){return n?c.jsx(be.Material,{fonts:s,children:n()}):c.jsx(be.Material,{fonts:s})}function xs({fonts:s=!0,children:n}){return n?c.jsx(be.Willow,{fonts:s,children:n}):c.jsx(be.Willow,{fonts:s})}function hs({fonts:s=!0,children:n}){return n?c.jsx(be.WillowDark,{fonts:s,children:n}):c.jsx(be.WillowDark,{fonts:s})}Object.defineProperty(exports,"defaultColumns",{enumerable:!0,get:()=>we.defaultColumns});Object.defineProperty(exports,"defaultEditorItems",{enumerable:!0,get:()=>we.defaultEditorItems});Object.defineProperty(exports,"defaultMenuOptions",{enumerable:!0,get:()=>we.defaultMenuOptions});Object.defineProperty(exports,"defaultTaskTypes",{enumerable:!0,get:()=>we.defaultTaskTypes});Object.defineProperty(exports,"defaultToolbarButtons",{enumerable:!0,get:()=>we.defaultToolbarButtons});Object.defineProperty(exports,"getEditorItems",{enumerable:!0,get:()=>we.getEditorItems});Object.defineProperty(exports,"getMenuOptions",{enumerable:!0,get:()=>we.getMenuOptions});Object.defineProperty(exports,"getToolbarButtons",{enumerable:!0,get:()=>we.getToolbarButtons});Object.defineProperty(exports,"registerScaleUnit",{enumerable:!0,get:()=>we.registerScaleUnit});Object.defineProperty(exports,"registerEditorItem",{enumerable:!0,get:()=>_e.registerEditorItem});exports.ContextMenu=ls;exports.Editor=as;exports.Gantt=rs;exports.HeaderMenu=us;exports.Material=fs;exports.Toolbar=os;exports.Tooltip=ds;exports.Willow=xs;exports.WillowDark=hs;
//# sourceMappingURL=index.cjs.map
