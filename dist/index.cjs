"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const c=require("react/jsx-runtime"),e=require("react"),Te=require("@svar-ui/react-core"),Ee=require("@svar-ui/lib-dom"),Be=require("@svar-ui/gantt-locales"),Je=require("@svar-ui/core-locales"),jt=require("@svar-ui/lib-state"),pe=require("@svar-ui/gantt-store"),$=require("@svar-ui/lib-react"),gt=require("@svar-ui/grid-store"),wt=require("@svar-ui/react-grid"),$t=require("react-dom"),ut=require("@svar-ui/react-toolbar"),Dt=require("@svar-ui/react-menu"),_e=require("@svar-ui/react-editor"),He=e.createContext(null);function ze(s){const n=s.getAttribute("data-id"),r=parseInt(n);return isNaN(r)||r.toString()!=n?n:r}function It(s,n,r){const i=s.getBoundingClientRect(),l=n.querySelector(".wx-body").getBoundingClientRect();return{top:i.top-l.top,left:i.left-l.left,dt:i.bottom-r.clientY,db:r.clientY-i.top}}function dt(s){return s&&s.getAttribute("data-context-id")}const ft=5;function Lt(s,n){let r,i,l,N,h,T,o,C,k;function F(E){N=E.clientX,h=E.clientY,T={...It(r,s,E),y:n.getTask(l).$y},document.body.style.userSelect="none"}function Y(E){r=Ee.locate(E),dt(r)&&(l=ze(r),k=setTimeout(()=>{C=!0,n&&n.touchStart&&n.touchStart(),F(E.touches[0])},500),s.addEventListener("touchmove",_),s.addEventListener("contextmenu",M),window.addEventListener("touchend",K))}function M(E){if(C||k)return E.preventDefault(),!1}function w(E){E.which===1&&(r=Ee.locate(E),dt(r)&&(l=ze(r),s.addEventListener("mousemove",W),window.addEventListener("mouseup",S),F(E)))}function f(E){s.removeEventListener("mousemove",W),s.removeEventListener("touchmove",_),document.body.removeEventListener("mouseup",S),document.body.removeEventListener("touchend",K),document.body.style.userSelect="",E&&(s.removeEventListener("mousedown",w),s.removeEventListener("touchstart",Y))}function U(E){const V=E.clientX-N,se=E.clientY-h;if(!i){if(Math.abs(V)<ft&&Math.abs(se)<ft||n&&n.start&&n.start({id:l,e:E})===!1)return;i=r.cloneNode(!0),i.style.pointerEvents="none",i.classList.add("wx-reorder-task"),i.style.position="absolute",i.style.left=T.left+"px",i.style.top=T.top+"px",r.style.visibility="hidden",r.parentNode.insertBefore(i,r)}if(i){const Q=Math.round(Math.max(0,T.top+se));if(n&&n.move&&n.move({id:l,top:Q,detail:o})===!1)return;const ae=n.getTask(l),X=ae.$y;if(!T.start&&T.y==X)return P();T.start=!0,T.y=ae.$y-4,i.style.top=Q+"px";const le=document.elementFromPoint(E.clientX,E.clientY),R=Ee.locate(le);if(R&&R!==r){const x=ze(R),A=R.getBoundingClientRect(),ee=A.top+A.height/2,ue=E.clientY+T.db>ee&&R.nextElementSibling!==r,ne=E.clientY-T.dt<ee&&R.previousElementSibling!==r;o?.after==x||o?.before==x?o=null:ue?o={id:l,after:x}:ne&&(o={id:l,before:x})}}}function W(E){U(E)}function _(E){C?(E.preventDefault(),U(E.touches[0])):k&&(clearTimeout(k),k=null)}function K(){C=null,k&&(clearTimeout(k),k=null),P()}function S(){P()}function P(){r&&(r.style.visibility=""),i&&(i.parentNode.removeChild(i),n&&n.end&&n.end({id:l,top:T.top})),l=r=i=T=o=null,f()}return s.style.position!=="absolute"&&(s.style.position="relative"),s.addEventListener("mousedown",w),s.addEventListener("touchstart",Y),{destroy(){f(!0)}}}function Nt({row:s,column:n}){function r(l,N){return{justifyContent:N.align,paddingLeft:`${(l.$level-1)*20}px`}}const i=n&&n._cell;return c.jsxs("div",{className:"wx-pqc08MHU wx-content",style:r(s,n),children:[s.data||s.lazy?c.jsx("i",{className:`wx-pqc08MHU wx-toggle-icon wxi-menu-${s.open?"down":"right"}`,"data-action":"open-task"}):c.jsx("i",{className:"wx-pqc08MHU wx-toggle-placeholder"}),c.jsx("div",{className:"wx-pqc08MHU wx-text",children:i?c.jsx(i,{row:s,column:n}):s.text})]})}function xt({column:s,cell:n}){const r=e.useMemo(()=>s.id,[s?.id]);return n||s.id=="add-task"?c.jsx("div",{style:{textAlign:s.align},children:c.jsx("i",{className:"wx-9DAESAHW wx-action-icon wxi-plus","data-action":r})}):null}function Pt(s){const{readonly:n,compactMode:r,width:i=0,display:l="all",columnWidth:N=0,onTableAPIChange:h,multiTaskRows:T=!1,rowMapping:o=null}=s,[C,k]=$.useWritableProp(N),[F,Y]=e.useState(),M=e.useContext(Te.context.i18n),w=e.useMemo(()=>M.getGroup("gantt"),[M]),f=e.useContext(He),U=$.useStore(f,"scrollTop"),W=$.useStore(f,"cellHeight"),_=$.useStore(f,"_scrollTask"),K=$.useStore(f,"_selected"),S=$.useStore(f,"area"),P=$.useStore(f,"_tasks"),E=$.useStore(f,"_scales"),V=$.useStore(f,"columns"),se=$.useStore(f,"_sort"),Q=$.useStore(f,"calendar"),ae=$.useStore(f,"durationUnit"),X=$.useStore(f,"splitTasks"),[le,R]=e.useState(null),x=e.useMemo(()=>!P||!S?[]:T&&o?P:P.slice(S.start,S.end),[P,S,T,o]),A=e.useCallback((a,b)=>{if(b==="add-task")f.exec(b,{target:a,task:{text:w("New Task")},mode:"child",show:!0});else if(b==="open-task"){const D=x.find(H=>H.id===a);(D?.data||D?.lazy)&&f.exec(b,{id:a,mode:!D.open})}},[x]),ee=e.useCallback(a=>{const b=Ee.locateID(a),D=a.target.dataset.action;D&&a.preventDefault(),b?D==="add-task"||D==="open-task"?A(b,D):f.exec("select-task",{id:b,toggle:a.ctrlKey||a.metaKey,range:a.shiftKey,show:!0}):D==="add-task"&&A(null,D)},[f,A]),ue=e.useRef(null),ne=e.useRef(null),[ce,be]=e.useState(0),[je,De]=e.useState(!1);e.useEffect(()=>{const a=ne.current;if(!a||typeof ResizeObserver>"u")return;const b=()=>be(a.clientWidth);b();const D=new ResizeObserver(b);return D.observe(a),()=>D.disconnect()},[]);const ve=e.useRef(null),Le=e.useCallback(a=>{const b=a.id,{before:D,after:H}=a,he=a.onMove;let me=D||H,$e=D?"before":"after";if(he){if($e==="after"){const We=f.getTask(me);We.data?.length&&We.open&&($e="before",me=We.data[0].id)}ve.current={id:b,[$e]:me}}else ve.current=null;f.exec("move-task",{id:b,mode:$e,target:me,inProgress:he})},[f]),ke=e.useMemo(()=>T&&o?0:S?.from??0,[S,T,o]),J=e.useMemo(()=>E?.height??0,[E]),p=e.useMemo(()=>!r&&l!=="grid"?(C??0)>(i??0):(C??0)>(ce??0),[r,l,C,i,ce]),O=e.useMemo(()=>{const a={};return p&&l==="all"||l==="grid"&&p?a.width=C:l==="grid"&&(a.width="100%"),a},[p,l,C]),B=e.useMemo(()=>le&&!x.find(a=>a.id===le.id)?[...x,le]:x,[x,le]),q=e.useMemo(()=>{if(!T||!o)return B;const a=new Map,b=new Set;return B.forEach(D=>{const H=o.taskRows.get(D.id)??D.id;b.has(H)||(a.set(H,{...D,$rowTasks:o.rowMap.get(H)||[D.id]}),b.add(H))}),Array.from(a.values())},[B,T,o]),z=e.useMemo(()=>{let a=(V||[]).map(H=>{H={...H};const he=H.header;if(typeof he=="object"){const me=he.text&&w(he.text);H.header={...he,text:me}}else H.header=w(he);return H});const b=a.findIndex(H=>H.id==="text"),D=a.findIndex(H=>H.id==="add-task");if(b!==-1&&(a[b].cell&&(a[b]._cell=a[b].cell),a[b].cell=Nt),D!==-1){a[D].cell=a[D].cell||xt;const H=a[D].header;if(typeof H!="object"&&(a[D].header={text:H}),a[D].header.cell=H.cell||xt,n)a.splice(D,1);else if(r){const[he]=a.splice(D,1);a.unshift(he)}}return a.length>0&&(a[a.length-1].resize=!1),a},[V,w,n,r]),ge=e.useMemo(()=>l==="all"?`${i}px`:l==="grid"?"calc(100% - 4px)":z.find(a=>a.id==="add-task")?"50px":"0",[l,i,z]),re=e.useMemo(()=>{if(q&&se?.length){const a={};return se.forEach(({key:b,order:D},H)=>{a[b]={order:D,...se.length>1&&{index:H}}}),a}return{}},[q,se]),v=e.useCallback(()=>z.some(a=>a.flexgrow&&!a.hidden),[]),Z=e.useMemo(()=>v(),[v,je]),de=e.useMemo(()=>{let a=l==="chart"?z.filter(D=>D.id==="add-task"):z;const b=l==="all"?i:ce;if(!Z){let D=C,H=!1;if(z.some(he=>he.$width)){let he=0;D=z.reduce((me,$e)=>($e.hidden||(he+=$e.width,me+=$e.$width||$e.width),me),0),he>D&&D>b&&(H=!0)}if(H||D<b){let he=1;return H||(he=(b-50)/(D-50||1)),a.map(me=>(me.id!=="add-task"&&!me.hidden&&(me.$width||(me.$width=me.width),me.width=me.$width*he),me))}}return a},[l,z,Z,C,i,ce]),fe=e.useCallback(a=>{if(!v()){const b=de.reduce((D,H)=>(a&&H.$width&&(H.$width=H.width),D+(H.hidden?0:H.width)),0);b!==C&&k(b)}De(!0),De(!1)},[v,de,C,k]),m=e.useCallback(()=>{z.filter(b=>b.flexgrow&&!b.hidden).length===1&&z.forEach(b=>{b.$width&&!b.flexgrow&&!b.hidden&&(b.width=b.$width)})},[]),oe=e.useCallback(a=>{if(!n){const b=Ee.locateID(a),D=Ee.locateAttr(a,"data-col-id");!(D&&z.find(he=>he.id==D))?.editor&&b&&f.exec("show-editor",{id:b})}},[f,n]),xe=e.useMemo(()=>Array.isArray(K)?K.map(a=>a.id):[],[K]),G=e.useRef(ke);G.current=ke,e.useEffect(()=>{const a=D=>{if(ue.current){const H=ue.current.querySelector(".wx-body");H&&(H.style.top=-((D??0)-(G.current??0))+"px")}ne.current&&(ne.current.scrollTop=0)};return a(U),f.on("scroll-chart",({top:D})=>{D!==void 0&&a(D)})},[f,U]),e.useEffect(()=>{if(ue.current){const a=ue.current.querySelector(".wx-body");a&&(a.style.top=-((U??0)-(ke??0))+"px")}},[ke]),e.useEffect(()=>{const a=ue.current;if(!a)return;const b=a.querySelector(".wx-table-box .wx-body");if(!b||typeof ResizeObserver>"u")return;const D=new ResizeObserver(()=>{if(ue.current){const H=ue.current.querySelector(".wx-body");H&&(H.style.top=-((U??0)-(G.current??0))+"px")}});return D.observe(b),()=>{D.disconnect()}},[de,O,l,ge,q,U]),e.useEffect(()=>{if(!_||!F)return;const{id:a}=_,b=F.getState().focusCell;b&&b.row!==a&&ue.current&&ue.current.contains(document.activeElement)&&F.exec("focus-cell",{row:a,column:b.column})},[_,F]);const Ce=e.useCallback(({id:a})=>{if(n)return!1;f.getTask(a).open&&f.exec("open-task",{id:a,mode:!1});const b=f.getState()._tasks.find(D=>D.id===a);if(R(b||null),!b)return!1},[f,n]),te=e.useCallback(({id:a,top:b})=>{ve.current?Le({...ve.current,onMove:!1}):f.exec("drag-task",{id:a,top:b+(ke??0),inProgress:!1}),R(null)},[f,Le,ke]),Se=e.useCallback(({id:a,top:b,detail:D})=>{D&&Le({...D,onMove:!0}),f.exec("drag-task",{id:a,top:b+(ke??0),inProgress:!0})},[f,Le,ke]);e.useEffect(()=>{const a=ue.current;return a?Lt(a,{start:Ce,end:te,move:Se,getTask:f.getTask}).destroy:void 0},[f,Ce,te,Se]);const ye=e.useCallback(a=>{const{key:b,isInput:D}=a;if(!D&&(b==="arrowup"||b==="arrowdown"))return a.eventSource="grid",f.exec("hotkey",a),!1;if(b==="enter"){const H=F?.getState().focusCell;if(H){const{row:he,column:me}=H;me==="add-task"?A(he,"add-task"):me==="text"&&A(he,"open-task")}}},[f,A,F]),Me=e.useRef(null),Pe=()=>{Me.current={setTableAPI:Y,handleHotkey:ye,sortVal:se,api:f,adjustColumns:m,setColumnWidth:fe,tasks:x,calendarVal:Q,durationUnitVal:ae,splitTasksVal:X,onTableAPIChange:h}};Pe(),e.useEffect(()=>{Pe()},[Y,ye,se,f,m,fe,x,Q,ae,X,h]);const Oe=e.useCallback(a=>{Y(a),a.intercept("hotkey",b=>Me.current.handleHotkey(b)),a.intercept("scroll",()=>!1),a.intercept("select-row",()=>!1),a.intercept("sort-rows",b=>{const D=Me.current.sortVal,{key:H,add:he}=b,me=D?D.find(We=>We.key===H):null;let $e="asc";return me&&($e=!me||me.order==="asc"?"desc":"asc"),f.exec("sort-tasks",{key:H,order:$e,add:he}),!1}),a.on("resize-column",()=>{Me.current.setColumnWidth(!0)}),a.on("hide-column",b=>{b.mode||Me.current.adjustColumns(),Me.current.setColumnWidth()}),a.intercept("update-cell",b=>{const{id:D,column:H,value:he}=b,me=Me.current.tasks.find($e=>$e.id===D);if(me){const $e={...me};let We=he;We&&!isNaN(We)&&!(We instanceof Date)&&(We*=1),$e[H]=We,pe.prepareEditTask($e,{calendar:Me.current.calendarVal,durationUnit:Me.current.durationUnitVal,splitTasks:Me.current.splitTasksVal},H),f.exec("update-task",{id:D,task:$e})}return!1}),h&&h(a)},[]);return c.jsx("div",{className:"wx-rHj6070p wx-table-container",style:{flex:`0 0 ${ge}`},ref:ne,children:c.jsx("div",{ref:ue,style:O,className:"wx-rHj6070p wx-table",onClick:ee,onDoubleClick:oe,children:c.jsx(wt.Grid,{init:Oe,sizes:{rowHeight:W,headerHeight:(J??0)-1},rowStyle:a=>a.$reorder?"wx-rHj6070p wx-reorder-task":"wx-rHj6070p",columnStyle:a=>`wx-rHj6070p wx-text-${a.align}${a.id==="add-task"?" wx-action":""}`,data:q,columns:de,selectedRows:[...xe],sortMarks:re})})})}function Ot({borders:s=""}){const n=e.useContext(He),r=$.useStore(n,"cellWidth"),i=$.useStore(n,"cellHeight"),l=e.useRef(null),[N,h]=e.useState("#e4e4e4");e.useEffect(()=>{if(typeof getComputedStyle<"u"&&l.current){const o=getComputedStyle(l.current).getPropertyValue("--wx-gantt-border");h(o?o.substring(o.indexOf("#")):"#1d1e261a")}},[]);const T={width:"100%",height:"100%",background:r!=null&&i!=null?`url(${pe.grid(r,i,N,s)})`:void 0,position:"absolute",pointerEvents:"none"};return c.jsx("div",{ref:l,style:T})}function Wt({onSelectLink:s,selectedLink:n,readonly:r}){const i=e.useContext(He),l=$.useStore(i,"_links"),N=$.useStore(i,"criticalPath"),h=e.useRef(null),T=e.useCallback(o=>{const C=o?.target?.classList;!C?.contains("wx-line")&&!C?.contains("wx-delete-button")&&s(null)},[s]);return e.useEffect(()=>{if(!r&&n&&h.current){const o=C=>{h.current&&!h.current.contains(C.target)&&T(C)};return document.addEventListener("click",o),()=>{document.removeEventListener("click",o)}}},[r,n,T]),c.jsxs("svg",{className:"wx-dkx3NwEn wx-links",children:[(l||[]).map(o=>{const C="wx-dkx3NwEn wx-line"+(N&&o.$critical?" wx-critical":"")+(r?"":" wx-line-selectable");return c.jsx("polyline",{className:C,points:o.$p,onClick:()=>!r&&s(o.id),"data-link-id":o.id},o.id)}),!r&&n&&c.jsx("polyline",{ref:h,className:"wx-dkx3NwEn wx-line wx-line-selected wx-line-selectable wx-delete-link",points:n.$p})]})}function _t(s){const{task:n,type:r}=s;function i(N){const h=n.segments[N];return{left:`${h.$x}px`,top:"0px",width:`${h.$w}px`,height:"100%"}}function l(N){if(!n.progress)return 0;const h=n.duration*n.progress/100,T=n.segments;let o=0,C=0,k=null;do{const F=T[C];C===N&&(o>h?k=0:k=Math.min((h-o)/F.duration,1)*100),o+=F.duration,C++}while(k===null&&C<T.length);return k||0}return c.jsx("div",{className:"wx-segments wx-GKbcLEGA",children:n.segments.map((N,h)=>c.jsxs("div",{className:`wx-segment wx-bar wx-${r} wx-GKbcLEGA`,"data-segment":h,style:i(h),children:[n.progress?c.jsx("div",{className:"wx-progress-wrapper",children:c.jsx("div",{className:"wx-progress-percent wx-GKbcLEGA",style:{width:`${l(h)}%`}})}):null,c.jsx("div",{className:"wx-content",children:N.text||""})]},h))})}let Ye=[],Ze=null,ht=null;const mt=(s,n)=>{if(!n||!n.start)return null;const{start:r,lengthUnitWidth:i,lengthUnit:l}=n,N=864e5,h=l==="week"?7:l==="month"?30:l==="quarter"?91:l==="year"?365:1,T=Math.floor(s/i),o=new Date(r.getTime()+T*h*N);return o.setUTCHours(0,0,0,0),console.log("[pixelToDate]",{px:s,units:T,scalesStart:r.toISOString(),scalesStartDayOfWeek:r.getUTCDay(),result:o.toISOString()}),o},Ht=(s,n,r)=>{if(!r||!s||!n)return 0;const{lengthUnit:i}=r,h=(i==="week"?7:i==="month"?30:i==="quarter"?91:i==="year"?365:1)*864e5;return Math.round((s.getTime()-n.getTime())/h)},At=(s,n,r)=>{if(!r||!s)return s;const{lengthUnit:i}=r,h=(i==="week"?7:i==="month"?30:i==="quarter"?91:i==="year"?365:1)*864e5,T=new Date(s.getTime()+n*h);return T.setUTCHours(0,0,0,0),T},zt=(s,n,r,i)=>s<i&&n>r;function Gt(s){const{readonly:n,taskTemplate:r,multiTaskRows:i=!1,rowMapping:l=null,marqueeSelect:N=!1,copyPaste:h=!1,allowTaskIntersection:T=!0}=s,o=e.useContext(He),[C,k]=$.useStoreWithCounter(o,"_tasks"),[F,Y]=$.useStoreWithCounter(o,"_links"),M=$.useStore(o,"area"),w=$.useStore(o,"_scales"),f=$.useStore(o,"taskTypes"),U=$.useStore(o,"baselines"),[W,_]=$.useStoreWithCounter(o,"_selected"),K=$.useStore(o,"_scrollTask"),S=$.useStore(o,"criticalPath"),P=$.useStore(o,"tasks"),E=$.useStore(o,"schedule"),V=$.useStore(o,"splitTasks"),se=e.useMemo(()=>{if(!M||!Array.isArray(C))return[];const t=M.start??0,u=M.end??0;return i&&l?C.map(d=>({...d})):C.slice(t,u).map(d=>({...d}))},[k,M,i,l]),Q=$.useStore(o,"cellHeight"),ae=e.useMemo(()=>{if(!i||!l||!se.length)return se;const t=new Map,u=[];return C.forEach(d=>{const g=l.taskRows.get(d.id)??d.id;t.has(g)||(t.set(g,u.length),u.push(g))}),se.map(d=>{const g=l.taskRows.get(d.id)??d.id,j=t.get(g)??0;return{...d,$y:j*Q,$y_base:d.$y_base!==void 0?j*Q:void 0}})},[se,i,l,C,Q]),X=e.useMemo(()=>w.lengthUnitWidth,[w]),le=e.useMemo(()=>w.lengthUnit||"day",[w]),R=e.useRef(!1),[x,A]=e.useState(void 0),[ee,ue]=e.useState(null),ne=e.useRef(null),[ce,be]=e.useState(null),[je,De]=e.useState(void 0),ve=e.useRef(null),[Le,ke]=e.useState(0),[J,p]=e.useState(null),O=e.useRef(null),[B,q]=e.useState(null),[z,ge]=e.useState(null),[re,v]=e.useState(null),Z=e.useRef(null);Z.current=z;const de=e.useRef(200),fe=e.useRef(null),m=e.useMemo(()=>{const t=fe.current;return!!(W.length&&t&&t.contains(document.activeElement))},[W,fe.current]),oe=e.useMemo(()=>m&&W[W.length-1]?.id,[m,W]);e.useEffect(()=>{if(K&&m&&K){const{id:t}=K,u=fe.current?.querySelector(`.wx-bar[data-id='${t}']`);u&&u.focus({preventScroll:!0})}},[K]),e.useEffect(()=>{const t=fe.current;if(t&&(ke(t.offsetWidth||0),typeof ResizeObserver<"u")){const u=new ResizeObserver(d=>{d[0]&&ke(d[0].contentRect.width)});return u.observe(t),()=>u.disconnect()}},[fe.current]);const xe=e.useCallback(()=>{document.body.style.userSelect="none"},[]),G=e.useCallback(()=>{document.body.style.userSelect=""},[]),Ce=e.useCallback((t,u,d)=>{if(u.target.classList.contains("wx-line")||(d||(d=o.getTask(ze(t))),d.type==="milestone"||d.type==="summary"))return"";const g=Ee.locate(u,"data-segment");g&&(t=g);const{left:j,width:I}=t.getBoundingClientRect(),y=(u.clientX-j)/I;let L=.2/(I>200?I/200:1);return y<L?"start":y>1-L?"end":""},[o]),te=e.useMemo(()=>{const t=new Set;if(T||!i||!l)return t;const u=new Map;return C.forEach(d=>{if(d.type==="summary"||d.type==="milestone")return;const g=l.taskRows.get(d.id)??d.id;u.has(g)||u.set(g,[]),u.get(g).push(d)}),u.forEach(d=>{if(!(d.length<2))for(let g=0;g<d.length;g++)for(let j=g+1;j<d.length;j++){const I=d[g],y=d[j],L=I.$x,ie=I.$x+I.$w,we=y.$x,Re=y.$x+y.$w;zt(L,ie,we,Re)&&(t.add(I.id),t.add(y.id))}}),t},[T,i,l,C,k]),Se=e.useMemo(()=>{const t=new Map;if(!i||!l)return C.forEach(g=>{t.set(g.id,g.$y)}),t;const u=new Map,d=[];return C.forEach(g=>{const j=l.taskRows.get(g.id)??g.id;u.has(j)||(u.set(j,d.length),d.push(j))}),C.forEach(g=>{const j=l.taskRows.get(g.id)??g.id,I=u.get(j)??0;t.set(g.id,I*Q)}),t},[C,i,l,Q]),ye=e.useMemo(()=>{const t=new Map;if(!i||!l)return C.forEach(g=>{t.set(g.id,g.$y),g.row!==void 0&&t.set(g.row,g.$y)}),t;const u=new Map,d=[];return C.forEach(g=>{const j=l.taskRows.get(g.id)??g.id;u.has(j)||(u.set(j,d.length),d.push(j))}),u.forEach((g,j)=>{t.set(j,g*Q)}),t},[C,i,l,Q]),Me=e.useCallback(t=>{if(!fe.current)return[];const d=Math.min(t.startX,t.currentX),g=Math.max(t.startX,t.currentX),j=Math.min(t.startY,t.currentY),I=Math.max(t.startY,t.currentY);return C.filter(y=>{const L=y.$x,ie=y.$x+y.$w,Re=Se.get(y.id)??y.$y,Ne=Re+y.$h;return L<g&&ie>d&&Re<I&&Ne>j})},[C,Se]),Pe=e.useMemo(()=>new Set(W.map(t=>t.id)),[W,_]),Oe=e.useCallback(t=>Pe.has(t),[Pe]),a=e.useCallback((t,u)=>{const{clientX:d}=u,g=ze(t),j=o.getTask(g),I=u.target.classList;if(!u.target.closest(".wx-delete-button")&&!n){if(I.contains("wx-progress-marker")){const{progress:y}=o.getTask(g);ne.current={id:g,x:d,progress:y,dx:0,node:t,marker:u.target},u.target.classList.add("wx-progress-in-drag")}else{const y=Ce(t,u,j)||"move",L={id:g,mode:y,x:d,dx:0,l:j.$x,w:j.$w};if(V&&j.segments?.length){const ie=Ee.locate(u,"data-segment");ie&&(L.segmentIndex=ie.dataset.segment*1,pe.extendDragOptions(j,L))}ue(L)}xe()}},[o,n,Ce,xe,V]),b=e.useCallback(t=>{if(t.button!==0||re)return;const u=Ee.locate(t);if(!u&&N&&!n){const d=fe.current;if(!d)return;const g=d.getBoundingClientRect(),j=t.clientX-g.left,I=t.clientY-g.top;if(h){const L=mt(j,w);L&&(Z.current=L,ge(L))}const y={startX:j,startY:I,currentX:j,currentY:I,ctrlKey:t.ctrlKey||t.metaKey};p(y),O.current=y,xe();return}if(u){if(N&&!n&&W.length>1){const d=ze(u);if(Oe(d)){const g=t.target.classList;if(!g.contains("wx-link")&&!g.contains("wx-progress-marker")&&!t.target.closest(".wx-delete-button")){const j=o.getTask(d);if(!Ce(u,t,j)){const y=new Map;W.forEach(L=>{const ie=o.getTask(L.id);if(ie){if(E?.auto&&ie.type==="summary")return;y.set(L.id,{$x:ie.$x,$w:ie.$w,start:ie.start,end:ie.end})}}),q({baseTaskId:d,startX:t.clientX,dx:0,originalPositions:y}),xe();return}}}}a(u,t)}},[a,N,h,n,W,Oe,o,Ce,E,xe,w,re]),D=e.useCallback(t=>{const u=Ee.locate(t);u&&(ve.current=setTimeout(()=>{De(!0),a(u,t.touches[0])},300))},[a]),H=e.useCallback(t=>{be(t&&{...F.find(u=>u.id===t)})},[F]),he=e.useCallback(()=>{const t=O.current;if(t){const u=Me(t);t.ctrlKey?u.forEach(d=>{o.exec("select-task",{id:d.id,toggle:!0,marquee:!0})}):(W.length>0&&o.exec("select-task",{id:null,marquee:!0}),u.forEach((d,g)=>{o.exec("select-task",{id:d.id,toggle:g>0,marquee:!0})})),p(null),O.current=null,G(),R.current=!0;return}if(B){const{dx:u,originalPositions:d}=B,g=Math.round(u/X);if(g!==0){let j=!0;d.forEach((I,y)=>{const L=o.getTask(y);L&&(o.exec("update-task",{id:y,diff:g,task:{start:L.start,end:L.end},skipUndo:!j}),j=!1)}),R.current=!0}else d.forEach((j,I)=>{o.exec("drag-task",{id:I,left:j.$x,width:j.$w,inProgress:!1})});q(null),G();return}if(ne.current){const{dx:u,id:d,marker:g,value:j}=ne.current;ne.current=null,typeof j<"u"&&u&&o.exec("update-task",{id:d,task:{progress:j},inProgress:!1}),g.classList.remove("wx-progress-in-drag"),R.current=!0,G()}else if(ee){const{id:u,mode:d,dx:g,l:j,w:I,start:y,segment:L,index:ie}=ee;if(ue(null),y){const we=Math.round(g/X);if(!we)o.exec("drag-task",{id:u,width:I,left:j,inProgress:!1,...L&&{segmentIndex:ie}});else{let Re={},Ne=o.getTask(u);L&&(Ne=Ne.segments[ie]);const Ge=1440*60*1e3,Ie=we*(le==="week"?7:le==="month"?30:le==="quarter"?91:le==="year"?365:1)*Ge;d==="move"?(Re.start=new Date(Ne.start.getTime()+Ie),Re.end=new Date(Ne.end.getTime()+Ie)):d==="start"?(Re.start=new Date(Ne.start.getTime()+Ie),Re.end=Ne.end):d==="end"&&(Re.start=Ne.start,Re.end=new Date(Ne.end.getTime()+Ie)),o.exec("update-task",{id:u,task:Re,...L&&{segmentIndex:ie}})}R.current=!0}G()}},[o,G,ee,X,le,J,B,Me,W]),me=e.useCallback((t,u)=>{const{clientX:d,clientY:g}=u,j=fe.current;if(j){const I=j.getBoundingClientRect();de.current=d-I.left}if(re){if(!j)return;const I=j.getBoundingClientRect(),y=d-I.left;v(L=>({...L,currentX:y}));return}if(!n){if(J){const I=fe.current;if(!I)return;const y=I.getBoundingClientRect(),L=d-y.left,ie=g-y.top;p(we=>({...we,currentX:L,currentY:ie})),O.current&&(O.current.currentX=L,O.current.currentY=ie);return}if(B){const I=d-B.startX;B.originalPositions.forEach((y,L)=>{const ie=y.$x+I;o.exec("drag-task",{id:L,left:ie,width:y.$w,inProgress:!0})}),q(y=>({...y,dx:I}));return}if(ne.current){const{node:I,x:y,id:L}=ne.current,ie=ne.current.dx=d-y,we=Math.round(ie/I.offsetWidth*100);let Re=ne.current.progress+we;ne.current.value=Re=Math.min(Math.max(0,Re),100),o.exec("update-task",{id:L,task:{progress:Re},inProgress:!0})}else if(ee){H(null);const{mode:I,l:y,w:L,x:ie,id:we,start:Re,segment:Ne,index:Ge}=ee,Ae=o.getTask(we),Ie=d-ie;if(!Re&&Math.abs(Ie)<20||I==="start"&&L-Ie<X||I==="end"&&L+Ie<X||I==="move"&&(Ie<0&&y+Ie<0||Ie>0&&y+L+Ie>Le)||ee.segment&&!pe.isSegmentMoveAllowed(Ae,ee))return;const Ke={...ee,dx:Ie};let Ue,qe;if(I==="start"?(Ue=y+Ie,qe=L-Ie):I==="end"?(Ue=y,qe=L+Ie):I==="move"&&(Ue=y+Ie,qe=L),o.exec("drag-task",{id:we,width:qe,left:Ue,inProgress:!0,...Ne&&{segmentIndex:Ge}}),!Ke.start&&(I==="move"&&Ae.$x==y||I!=="move"&&Ae.$w==L)){R.current=!0,he();return}Ke.start=!0,ue(Ke)}else{const I=Ee.locate(t);if(I){const y=o.getTask(ze(I)),ie=Ee.locate(t,"data-segment")||I,we=Ce(ie,u,y);ie.style.cursor=we&&!n?"col-resize":"pointer"}}}},[o,n,ee,X,Le,Ce,H,he,J,B,re]),$e=e.useCallback(t=>{me(t,t)},[me]),We=e.useCallback(t=>{je?(t.preventDefault(),me(t,t.touches[0])):ve.current&&(clearTimeout(ve.current),ve.current=null)},[je,me]),Ve=e.useCallback(()=>{he()},[he]),bt=e.useCallback(()=>{De(null),ve.current&&(clearTimeout(ve.current),ve.current=null),he()},[he]);e.useEffect(()=>(window.addEventListener("mouseup",Ve),()=>{window.removeEventListener("mouseup",Ve)}),[Ve]);const yt=e.useCallback(t=>{if(!n){const u=Ee.locateID(t.target);if(u&&!t.target.classList.contains("wx-link")){const d=Ee.locateID(t.target,"data-segment");o.exec("show-editor",{id:u,...d!==null&&{segmentIndex:d}})}}},[o,n]),Tt=["e2s","s2s","e2e","s2e"],Xe=e.useCallback((t,u)=>Tt[(t?1:0)+(u?0:2)],[]),Fe=e.useCallback((t,u)=>{const d=x.id,g=x.start;return t===d?!0:!!F.find(j=>j.target==t&&j.source==d&&j.type===Xe(g,u))},[x,Y,Xe]),et=e.useCallback(()=>{x&&A(null)},[x]),tt=e.useCallback((t,u,d)=>{if(!u.length||!t||d==null)return;console.log("[paste] executePaste called:",{targetDate:t.toISOString(),taskCount:u.length,parent:d});const g=864e5,j=o.getHistory();j?.startBatch();const I=new Date(t);I.setUTCHours(0,0,0,0),u.forEach((y,L)=>{const ie=`task-${Date.now()}-${L}`,we=At(I,y._startCellOffset||0,w),Re=new Date(we.getTime()+(y._startDayOfWeek||0)*g);Re.setUTCHours(0,0,0,0);const Ne=new Date(Re.getTime()+(y._durationDays||7)*g);Ne.setUTCHours(0,0,0,0),console.log("[paste] task:",{text:y.text,original:{start:y.start?.toISOString?.(),end:y.end?.toISOString?.()},calculated:{targetColumnStart:I.toISOString(),cellOffset:we.toISOString(),newStart:Re.toISOString(),newEnd:Ne.toISOString()},clipboard:{_startCellOffset:y._startCellOffset,_startDayOfWeek:y._startDayOfWeek,_durationDays:y._durationDays},row:y.row}),o.exec("add-task",{task:{id:ie,text:y.text,start:Re,end:Ne,type:y.type||"task",parent:d,row:y.row},target:d,mode:"child",skipUndo:L>0})}),j?.endBatch()},[o,w]),Ct=e.useCallback(t=>{if(R.current){R.current=!1;return}if(re&&re.currentX!=null){const d=mt(re.currentX,w);d&&tt(d,re.tasks,re.parent),v(null);return}const u=Ee.locateID(t.target);if(u){const d=o.getTask(u),g=C.find(I=>I.id===u);console.log("[click] task:",d?.text,"id:",u),console.log("[click] api.getTask:",{start:d?.start,end:d?.end,duration:d?.duration}),console.log("[click] rendered:",{start:g?.start,end:g?.end,$w:g?.$w,$x:g?.$x});const j=t.target.classList;if(j.contains("wx-link")){const I=j.contains("wx-left");if(!x){A({id:u,start:I});return}x.id!==u&&!Fe(u,I)&&o.exec("add-link",{link:{source:x.id,target:u,type:Xe(x.start,I)}})}else if(j.contains("wx-delete-button-icon"))o.exec("delete-link",{id:ce.id}),be(null);else{let I;const y=Ee.locate(t,"data-segment");y&&(I=y.dataset.segment*1),o.exec("select-task",{id:u,toggle:t.ctrlKey||t.metaKey,range:t.shiftKey,segmentIndex:I})}}et()},[o,x,Y,ce,Fe,Xe,et,re,w,tt]),St=e.useCallback(t=>({left:`${t.$x}px`,top:`${t.$y}px`,width:`${t.$w}px`,height:`${t.$h}px`}),[]),vt=e.useCallback(t=>({left:`${t.$x_base}px`,top:`${t.$y_base}px`,width:`${t.$w_base}px`,height:`${t.$h_base}px`}),[]),Mt=e.useCallback(t=>{if(je||ve.current)return t.preventDefault(),!1},[je]),st=e.useMemo(()=>f.map(t=>t.id),[f]),nt=e.useCallback(t=>{let u=st.includes(t)?t:"task";return["task","milestone","summary"].includes(t)||(u=`task ${u}`),u},[st]),rt=e.useCallback(t=>{o.exec(t.action,t.data)},[o]),Qe=e.useCallback(t=>S&&P.byId(t).$critical,[S,P]),ot=e.useCallback(t=>{if(E?.auto){const u=P.getSummaryId(t,!0),d=P.getSummaryId(x.id,!0);return x?.id&&!(Array.isArray(u)?u:[u]).includes(x.id)&&!(Array.isArray(d)?d:[d]).includes(t)}return x},[E,P,x]),lt=e.useCallback(()=>{const t=o.getState()._selected;if(!t||!t.length)return;const u=864e5,d=t.map(L=>{const ie=o.getTask(L.id);if(!ie)return null;const we=C.find(Rt=>Rt.id===L.id);if(!we)return null;const{$x:Re,$y:Ne,$h:Ge,$w:Ae,$skip:Ie,$level:Ke,$index:Ue,$y_base:qe,$x_base:hs,$w_base:ms,$h_base:gs,$skip_baseline:ws,$critical:ps,$reorder:ks,...Et}=we,it=we.end&&we.start?Math.round((we.end.getTime()-we.start.getTime())/u):0,at=we.start?(we.start.getUTCDay()+6)%7:0;return console.log("[copy] task:",{id:ie.id,text:ie.text,start:we.start?.toISOString?.(),end:we.end?.toISOString?.(),durationDays:it,startDayOfWeek:at,$w:Ae,$h:Ge,row:we.row,parent:we.parent}),{...Et,_durationDays:it,_startDayOfWeek:at,_originalWidth:Ae,_originalHeight:Ge}}).filter(Boolean);if(!d.length)return;const j=d[0].parent,I=d.filter(L=>L.parent===j);if(I.length===0)return;const y=I.reduce((L,ie)=>ie.start&&(!L||ie.start<L)?ie.start:L,null);Ye=I.map(L=>({...L,_startCellOffset:Ht(L.start,y,w)})),ht=j,Ze=y,console.log("[copy] clipboard stored:",{taskCount:Ye.length,baseDate:y?.toISOString?.(),parent:j,tasks:Ye.map(L=>({id:L.id,text:L.text,_startCellOffset:L._startCellOffset,_startDayOfWeek:L._startDayOfWeek,_durationDays:L._durationDays}))})},[o,w]);e.useEffect(()=>h?o.intercept("hotkey",u=>{if(u.key==="ctrl+c"||u.key==="meta+c")return lt(),!1;if(u.key==="ctrl+v"||u.key==="meta+v")return!Ye.length||!Ze||v({tasks:Ye,baseDate:Ze,parent:ht,currentX:de.current}),!1}):void 0,[h,o,lt]),e.useEffect(()=>{if(!re)return;const t=u=>{u.key==="Escape"&&(u.preventDefault(),u.stopPropagation(),v(null))};return document.addEventListener("keydown",t,!0),()=>document.removeEventListener("keydown",t,!0)},[re]);const ct=e.useMemo(()=>{if(!J)return null;const t=Math.min(J.startX,J.currentX),u=Math.min(J.startY,J.currentY),d=Math.abs(J.currentX-J.startX),g=Math.abs(J.currentY-J.startY);return{left:`${t}px`,top:`${u}px`,width:`${d}px`,height:`${g}px`}},[J]);return c.jsxs("div",{className:"wx-GKbcLEGA wx-bars",style:{lineHeight:`${ae.length?ae[0].$h:0}px`},ref:fe,onContextMenu:Mt,onMouseDown:b,onMouseMove:$e,onTouchStart:D,onTouchMove:We,onTouchEnd:bt,onClick:Ct,onDoubleClick:yt,onDragStart:t=>(t.preventDefault(),!1),children:[c.jsx(Wt,{onSelectLink:H,selectedLink:ce,readonly:n}),ae.map(t=>{if(t.$skip&&t.$skip_baseline)return null;const u=te.has(t.id),d=`wx-bar wx-${nt(t.type)}`+(je&&ee&&t.id===ee.id?" wx-touch":"")+(x&&x.id===t.id?" wx-selected":"")+(Pe.has(t.id)?" wx-selected":"")+(Qe(t.id)?" wx-critical":"")+(t.$reorder?" wx-reorder-task":"")+(V&&t.segments?" wx-split":"")+(u?" wx-collision":""),g="wx-link wx-left"+(x?" wx-visible":"")+(!x||!Fe(t.id,!0)&&ot(t.id)?" wx-target":"")+(x&&x.id===t.id&&x.start?" wx-selected":"")+(Qe(t.id)?" wx-critical":""),j="wx-link wx-right"+(x?" wx-visible":"")+(!x||!Fe(t.id,!1)&&ot(t.id)?" wx-target":"")+(x&&x.id===t.id&&!x.start?" wx-selected":"")+(Qe(t.id)?" wx-critical":"");return c.jsxs(e.Fragment,{children:[!t.$skip&&c.jsxs("div",{className:"wx-GKbcLEGA "+d,style:St(t),"data-tooltip-id":t.id,"data-id":t.id,tabIndex:oe===t.id?0:-1,children:[n?null:t.id===ce?.target&&ce?.type[2]==="s"?c.jsx(Te.Button,{type:"danger",css:"wx-left wx-delete-button wx-delete-link",children:c.jsx("i",{className:"wxi-close wx-delete-button-icon"})}):c.jsx("div",{className:"wx-GKbcLEGA "+g,children:c.jsx("div",{className:"wx-GKbcLEGA wx-inner"})}),t.type!=="milestone"?c.jsxs(c.Fragment,{children:[t.progress&&!(V&&t.segments)?c.jsx("div",{className:"wx-GKbcLEGA wx-progress-wrapper",children:c.jsx("div",{className:"wx-GKbcLEGA wx-progress-percent",style:{width:`${t.progress}%`}})}):null,!n&&!(V&&t.segments)?c.jsx("div",{className:"wx-GKbcLEGA wx-progress-marker",style:{left:`calc(${t.progress}% - 10px)`},children:t.progress}):null,r?c.jsx(r,{data:t,api:o,onAction:rt}):V&&t.segments?c.jsx(_t,{task:t,type:nt(t.type)}):c.jsx("div",{className:"wx-GKbcLEGA wx-content",children:t.text||""}),u&&c.jsx("div",{className:"wx-GKbcLEGA wx-collision-warning",title:"This task overlaps with another task in the same row",children:"!"})]}):c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"wx-GKbcLEGA wx-content"}),r?c.jsx(r,{data:t,api:o,onAction:rt}):c.jsx("div",{className:"wx-GKbcLEGA wx-text-out",children:t.text})]}),n?null:t.id===ce?.target&&ce?.type[2]==="e"?c.jsx(Te.Button,{type:"danger",css:"wx-right wx-delete-button wx-delete-link",children:c.jsx("i",{className:"wxi-close wx-delete-button-icon"})}):c.jsx("div",{className:"wx-GKbcLEGA "+j,children:c.jsx("div",{className:"wx-GKbcLEGA wx-inner"})})]}),U&&!t.$skip_baseline?c.jsx("div",{className:"wx-GKbcLEGA wx-baseline"+(t.type==="milestone"?" wx-milestone":""),style:vt(t)}):null]},t.id)}),J&&ct&&c.jsx("div",{className:"wx-GKbcLEGA wx-marquee-selection",style:ct}),re&&re.currentX!=null&&re.tasks.map((t,u)=>{const g=(Math.floor(re.currentX/X)+(t._startCellOffset||0))*X,j=t._originalWidth||X,I=t._originalHeight||Q,y=ye.get(t.row)??(t.$y||0);return c.jsx("div",{className:"wx-GKbcLEGA wx-bar wx-task wx-paste-preview",style:{left:g,top:y,width:j,height:I},children:c.jsx("div",{className:"wx-GKbcLEGA wx-content",children:t.text})},`preview-${u}`)})]})}function Ut(s){const{highlightTime:n}=s,r=e.useContext(He),i=$.useStore(r,"_scales");return c.jsx("div",{className:"wx-ZkvhDKir wx-scale",style:{width:i.width},children:(i?.rows||[]).map((l,N)=>c.jsx("div",{className:"wx-ZkvhDKir wx-row",style:{height:`${l.height}px`},children:(l.cells||[]).map((h,T)=>{const o=n?n(h.date,h.unit):"",C="wx-cell "+(h.css||"")+" "+(o||""),k=typeof h.value=="string"&&h.value.includes("<");return c.jsx("div",{className:"wx-ZkvhDKir "+C,style:{width:`${h.width}px`},...k?{dangerouslySetInnerHTML:{__html:h.value}}:{children:h.value}},T)})},N))})}const qt=new Map;function Yt(s){const n=e.useRef(null),r=e.useRef(0),i=e.useRef(null),l=typeof window<"u"&&window.__RENDER_METRICS_ENABLED__;n.current===null&&(n.current=performance.now()),r.current++,e.useEffect(()=>{if(l)return cancelAnimationFrame(i.current),i.current=requestAnimationFrame(()=>{const N={label:s,time:performance.now()-n.current,renders:r.current,timestamp:Date.now()};qt.set(s,N),window.dispatchEvent(new CustomEvent("render-metric",{detail:N}))}),()=>cancelAnimationFrame(i.current)})}function Xt(s){const{readonly:n,fullWidth:r,fullHeight:i,taskTemplate:l,cellBorders:N,highlightTime:h,multiTaskRows:T=!1,rowMapping:o=null,marqueeSelect:C=!1,copyPaste:k=!1,scrollToCurrentWeek:F=!1,currentWeekColor:Y=null,allowTaskIntersection:M=!0}=s,w=e.useContext(He),[f,U]=$.useStoreWithCounter(w,"_selected"),W=$.useStore(w,"scrollTop"),_=$.useStore(w,"cellHeight"),K=$.useStore(w,"cellWidth"),S=$.useStore(w,"_scales"),P=$.useStore(w,"_markers"),E=$.useStore(w,"_scrollTask"),V=$.useStore(w,"zoom"),se=$.useStore(w,"_tasks"),[Q,ae]=e.useState(),X=e.useRef(null),le=e.useRef(0),R=e.useRef(!1),x=1+(S?.rows?.length||0),A=e.useMemo(()=>{if(!T||!o||!se?.length)return null;const p=new Map,O=new Map,B=[];return se.forEach(q=>{const z=o.taskRows.get(q.id)??q.id;O.has(z)||(O.set(z,B.length),B.push(z))}),se.forEach(q=>{const z=o.taskRows.get(q.id)??q.id,ge=O.get(z)??0;p.set(q.id,ge*_)}),p},[se,T,o,_]),ee=e.useMemo(()=>{const p=[];return f&&f.length&&_&&f.forEach(O=>{const B=A?.get(O.id)??O.$y;p.push({height:`${_}px`,top:`${B-3}px`})}),p},[U,_,A]),ue=e.useMemo(()=>Math.max(Q||0,i),[Q,i]);e.useEffect(()=>{const p=X.current;p&&typeof W=="number"&&(p.scrollTop=W)},[W]);const ne=()=>{ce()};function ce(p){const O=X.current;if(!O)return;const B={};B.left=O.scrollLeft,w.exec("scroll-chart",B)}function be(){const p=X.current,B=Math.ceil((Q||0)/(_||1))+1,q=Math.floor((p&&p.scrollTop||0)/(_||1)),z=Math.max(0,q-x),ge=q+B+x,re=z*(_||0);w.exec("render-data",{start:z,end:ge,from:re})}e.useEffect(()=>{be()},[Q,W]);const je=e.useCallback(p=>{if(!p)return;const{id:O,mode:B}=p;if(B.toString().indexOf("x")<0)return;const q=X.current;if(!q)return;const{clientWidth:z}=q,ge=w.getTask(O);if(ge.$x+ge.$w<q.scrollLeft)w.exec("scroll-chart",{left:ge.$x-(K||0)}),q.scrollLeft=ge.$x-(K||0);else if(ge.$x>=z+q.scrollLeft){const re=z<ge.$w?K||0:ge.$w;w.exec("scroll-chart",{left:ge.$x-z+re}),q.scrollLeft=ge.$x-z+re}},[w,K]);e.useEffect(()=>{je(E)},[E]);function De(p){if(V&&(p.ctrlKey||p.metaKey)){p.preventDefault();const O=X.current,B=p.clientX-(O?O.getBoundingClientRect().left:0);if(le.current+=p.deltaY,Math.abs(le.current)>=150){const z=-Math.sign(le.current);le.current=0,w.exec("zoom-scale",{dir:z,offset:B})}}}const ve=e.useCallback(p=>{const O=h(p.date,p.unit);return O?{css:O,width:p.width}:null},[h]),Le=e.useMemo(()=>{if(!S||!h||!["hour","day","week"].includes(S.minUnit))return null;let O=0;return S.rows[S.rows.length-1].cells.map(B=>{const q=ve(B),z=O;return O+=B.width,q?{...q,left:z}:null})},[S,h,ve]),ke=e.useCallback(p=>{p.eventSource="chart",w.exec("hotkey",p)},[w]);e.useEffect(()=>{const p=X.current;if(!p)return;const O=()=>ae(p.clientHeight);O();const B=new ResizeObserver(()=>O());return B.observe(p),()=>{B.disconnect()}},[X.current]);const J=e.useRef(null);return e.useEffect(()=>{const p=X.current;if(p&&!J.current)return J.current=gt.hotkeys(p,{keys:{arrowup:!0,arrowdown:!0},exec:O=>ke(O)}),()=>{J.current?.destroy(),J.current=null}},[]),e.useEffect(()=>{const p=X.current;if(!p)return;const O=De;return p.addEventListener("wheel",O),()=>{p.removeEventListener("wheel",O)}},[De]),e.useEffect(()=>{if(!F||R.current||!S||!X.current||!Q)return;const p=X.current,{clientWidth:O}=p,B=new Date,q=S.rows[S.rows.length-1]?.cells;if(!q)return;let z=-1,ge=0;const re=[];for(let Z=0;Z<q.length;Z++){const de=q[Z];re.push({left:ge,width:de.width});const fe=de.date;if(de.unit==="week"){const m=new Date(fe);m.setUTCDate(m.getUTCDate()+7),B>=fe&&B<m&&(z=Z)}else de.unit==="day"&&B.getUTCFullYear()===fe.getUTCFullYear()&&B.getUTCMonth()===fe.getUTCMonth()&&B.getUTCDate()===fe.getUTCDate()&&(z=Z);ge+=de.width}let v=z;if(z>0&&(v=z-1),v>=0&&re[v]){const Z=re[v],de=Math.max(0,Z.left);p.scrollLeft=de,w.exec("scroll-chart",{left:de}),R.current=!0}},[F,S,Q,w]),Yt("chart"),c.jsxs("div",{className:"wx-mR7v2Xag wx-chart",tabIndex:-1,ref:X,onScroll:ne,children:[c.jsx(Ut,{highlightTime:h,scales:S}),P&&P.length?c.jsx("div",{className:"wx-mR7v2Xag wx-markers",style:{height:`${ue}px`},children:P.map((p,O)=>c.jsx("div",{className:`wx-mR7v2Xag wx-marker ${p.css||""}`,style:{left:`${p.left}px`},children:c.jsx("div",{className:"wx-mR7v2Xag wx-content",children:p.text})},O))}):null,c.jsxs("div",{className:"wx-mR7v2Xag wx-area",style:{width:`${r}px`,height:`${ue}px`},children:[Le?c.jsx("div",{className:"wx-mR7v2Xag wx-gantt-holidays",style:{height:"100%"},children:Le.map((p,O)=>p?c.jsx("div",{className:"wx-mR7v2Xag "+p.css,style:{width:`${p.width}px`,left:`${p.left}px`}},O):null)}):null,c.jsx(Ot,{borders:N}),f&&f.length?f.map((p,O)=>p.$y?c.jsx("div",{className:"wx-mR7v2Xag wx-selected","data-id":p.id,style:ee[O]},p.id):null):null,c.jsx(Gt,{readonly:n,taskTemplate:l,multiTaskRows:T,rowMapping:o,marqueeSelect:C,copyPaste:k,allowTaskIntersection:M})]})]})}function Ft(s){const{position:n="after",size:r=4,dir:i="x",onMove:l,onDisplayChange:N,compactMode:h,containerWidth:T=0,leftThreshold:o=50,rightThreshold:C=50}=s,[k,F]=$.useWritableProp(s.value??0),[Y,M]=$.useWritableProp(s.display??"all");function w(ne){let ce=0;n=="center"?ce=r/2:n=="before"&&(ce=r);const be={size:[r+"px","auto"],p:[ne-ce+"px","0px"],p2:["auto","0px"]};if(i!="x")for(let je in be)be[je]=be[je].reverse();return be}const[f,U]=e.useState(!1),[W,_]=e.useState(null),K=e.useRef(0),S=e.useRef(),P=e.useRef(),E=e.useRef(Y);e.useEffect(()=>{E.current=Y},[Y]),e.useEffect(()=>{W===null&&k>0&&_(k)},[W,k]);function V(ne){return i=="x"?ne.clientX:ne.clientY}const se=e.useCallback(ne=>{const ce=S.current+V(ne)-K.current;F(ce);let be;ce<=o?be="chart":T-ce<=C?be="grid":be="all",E.current!==be&&(M(be),E.current=be),P.current&&clearTimeout(P.current),P.current=setTimeout(()=>l&&l(ce),100)},[T,o,C,l]),Q=e.useCallback(()=>{document.body.style.cursor="",document.body.style.userSelect="",U(!1),window.removeEventListener("mousemove",se),window.removeEventListener("mouseup",Q)},[se]),ae=e.useMemo(()=>Y!=="all"?"auto":i=="x"?"ew-resize":"ns-resize",[Y,i]),X=e.useCallback(ne=>{!h&&(Y==="grid"||Y==="chart")||(K.current=V(ne),S.current=k,U(!0),document.body.style.cursor=ae,document.body.style.userSelect="none",window.addEventListener("mousemove",se),window.addEventListener("mouseup",Q))},[ae,se,Q,k,h,Y]);function le(){M("all"),W!==null&&(F(W),l&&l(W))}function R(ne){if(h){const ce=Y==="chart"?"grid":"chart";M(ce),N(ce)}else if(Y==="grid"||Y==="chart")le(),N("all");else{const ce=ne==="left"?"chart":"grid";M(ce),N(ce)}}function x(){R("left")}function A(){R("right")}const ee=e.useMemo(()=>w(k),[k,n,r,i]),ue=["wx-resizer",`wx-resizer-${i}`,`wx-resizer-display-${Y}`,f?"wx-resizer-active":""].filter(Boolean).join(" ");return c.jsxs("div",{className:"wx-pFykzMlT "+ue,onMouseDown:X,style:{width:ee.size[0],height:ee.size[1],cursor:ae},children:[c.jsxs("div",{className:"wx-pFykzMlT wx-button-expand-box",children:[c.jsx("div",{className:"wx-pFykzMlT wx-button-expand-content wx-button-expand-left",children:c.jsx("i",{className:"wx-pFykzMlT wxi-menu-left",onClick:x})}),c.jsx("div",{className:"wx-pFykzMlT wx-button-expand-content wx-button-expand-right",children:c.jsx("i",{className:"wx-pFykzMlT wxi-menu-right",onClick:A})})]}),c.jsx("div",{className:"wx-pFykzMlT wx-resizer-line"})]})}const Kt=650;function pt(s){let n;function r(){n=new ResizeObserver(l=>{for(let N of l)if(N.target===document.body){let h=N.contentRect.width<=Kt;s(h)}}),n.observe(document.body)}function i(){n&&(n.disconnect(),n=null)}return{observe:r,disconnect:i}}function Bt(s){const{taskTemplate:n,readonly:r,cellBorders:i,highlightTime:l,onTableAPIChange:N,multiTaskRows:h=!1,rowMapping:T=null,marqueeSelect:o=!1,copyPaste:C=!1,scrollToCurrentWeek:k=!1,currentWeekColor:F=null,allowTaskIntersection:Y=!0}=s,M=e.useContext(He),w=$.useStore(M,"_tasks"),f=$.useStore(M,"_scales"),U=$.useStore(M,"cellHeight"),W=$.useStore(M,"columns"),_=$.useStore(M,"_scrollTask"),K=$.useStore(M,"undo"),S=e.useMemo(()=>{if(!h)return T;const v=new Map,Z=new Map;return w.forEach(de=>{const fe=de.row??de.id;Z.set(de.id,fe),v.has(fe)||v.set(fe,[]),v.get(fe).push(de.id)}),{rowMap:v,taskRows:Z}},[w,h,T]),[P,E]=e.useState(!1);let[V,se]=e.useState(0);const[Q,ae]=e.useState(0),[X,le]=e.useState(0),[R,x]=e.useState(void 0),[A,ee]=e.useState("all"),ue=e.useRef(null),ne=e.useCallback(v=>{E(Z=>(v!==Z&&(v?(ue.current=A,A==="all"&&ee("grid")):(!ue.current||ue.current==="all")&&ee("all")),v))},[A]);e.useEffect(()=>{const v=pt(ne);return v.observe(),()=>{v.disconnect()}},[ne]);const ce=e.useMemo(()=>{let v;return W.every(Z=>Z.width&&!Z.flexgrow)?v=W.reduce((Z,de)=>Z+parseInt(de.width),0):P&&A==="chart"?v=parseInt(W.find(Z=>Z.id==="action")?.width)||50:v=440,V=v,v},[W,P,A]);e.useEffect(()=>{se(ce)},[ce]);const be=e.useMemo(()=>(Q??0)-(R??0),[Q,R]),je=e.useMemo(()=>f.width,[f]),De=e.useMemo(()=>{if(!h||!S)return w.length*U;const v=new Set;return w.forEach(Z=>{const de=S.taskRows.get(Z.id)??Z.id;v.add(de)}),v.size*U},[w,U,h,S]),ve=e.useMemo(()=>f.height+De+be,[f,De,be]),Le=e.useMemo(()=>V+je,[V,je]),ke=e.useRef(null),J=e.useCallback(()=>{Promise.resolve().then(()=>{if((Q??0)>(Le??0)){const v=(Q??0)-V;M.exec("expand-scale",{minWidth:v})}})},[Q,Le,V,M]);e.useEffect(()=>{let v;return ke.current&&(v=new ResizeObserver(J),v.observe(ke.current)),()=>{v&&v.disconnect()}},[ke.current,J]),e.useEffect(()=>{J()},[je]);const p=e.useRef(null),O=e.useRef(null),B=e.useCallback(()=>{const v=p.current;v&&M.exec("scroll-chart",{top:v.scrollTop})},[M]),q=e.useRef({rTasks:[],rScales:{height:0},rCellHeight:0,scrollSize:0,ganttDiv:null,ganttHeight:0});e.useEffect(()=>{q.current={rTasks:w,rScales:f,rCellHeight:U,scrollSize:be,ganttDiv:p.current,ganttHeight:X??0}},[w,f,U,be,X]);const z=e.useCallback(v=>{if(!v)return;const{rTasks:Z,rScales:de,rCellHeight:fe,scrollSize:m,ganttDiv:oe,ganttHeight:xe}=q.current;if(!oe)return;const{id:G}=v,Ce=Z.findIndex(te=>te.id===G);if(Ce>-1){const te=xe-de.height,Se=Ce*fe,ye=oe.scrollTop;let Me=null;Se<ye?Me=Se:Se+fe>ye+te&&(Me=Se-te+fe+m),Me!==null&&(M.exec("scroll-chart",{top:Math.max(Me,0)}),p.current.scrollTop=Math.max(Me,0))}},[M]);e.useEffect(()=>{z(_)},[_]),e.useEffect(()=>{const v=p.current,Z=O.current;if(!v||!Z)return;const de=()=>{$t.flushSync(()=>{le(v.offsetHeight),ae(v.offsetWidth),x(Z.offsetWidth)})},fe=new ResizeObserver(de);return fe.observe(v),()=>fe.disconnect()},[p.current]);const ge=e.useRef(null),re=e.useRef(null);return e.useEffect(()=>{re.current&&(re.current.destroy(),re.current=null);const v=ge.current;if(v)return re.current=gt.hotkeys(v,{keys:{"ctrl+c":!0,"ctrl+v":!0,"ctrl+x":!0,"ctrl+d":!0,"meta+c":!0,"meta+v":!0,"meta+x":!0,"meta+d":!0,backspace:!0,"ctrl+z":K,"ctrl+y":K,"meta+z":K,"meta+shift+z":K},exec:Z=>{if(Z.isInput)return;const de=Z.key;if(de==="ctrl+z"||de==="meta+z"){M.exec("undo",{});return}if(de==="ctrl+y"||de==="meta+shift+z"){M.exec("redo",{});return}M.exec("hotkey",Z)}}),()=>{re.current?.destroy(),re.current=null}},[K]),c.jsx("div",{className:"wx-jlbQoHOz wx-gantt",ref:p,onScroll:B,children:c.jsx("div",{className:"wx-jlbQoHOz wx-pseudo-rows",style:{height:ve,width:"100%"},ref:O,children:c.jsx("div",{className:"wx-jlbQoHOz wx-stuck",style:{height:X,width:R},children:c.jsxs("div",{tabIndex:0,className:"wx-jlbQoHOz wx-layout",ref:ge,children:[W.length?c.jsxs(c.Fragment,{children:[c.jsx(Pt,{display:A,compactMode:P,columnWidth:ce,width:V,readonly:r,fullHeight:De,onTableAPIChange:N,multiTaskRows:h,rowMapping:S}),c.jsx(Ft,{value:V,display:A,compactMode:P,containerWidth:Q,onMove:v=>se(v),onDisplayChange:v=>ee(v)})]}):null,c.jsx("div",{className:"wx-jlbQoHOz wx-content",ref:ke,children:c.jsx(Xt,{readonly:r,fullWidth:je,fullHeight:De,taskTemplate:n,cellBorders:i,highlightTime:l,multiTaskRows:h,rowMapping:S,marqueeSelect:o,copyPaste:C,scrollToCurrentWeek:k,currentWeekColor:F,allowTaskIntersection:Y})})]})})})})}function Vt(s){return{year:"%Y",quarter:`${s("Q")} %Q`,month:"%M",week:`${s("Week")} %w`,day:"%M %j",hour:"%H:%i"}}function Qt(s,n){return typeof s=="function"?s:Ee.dateToString(s,n)}function kt(s,n){return s.map(({format:r,...i})=>({...i,format:Qt(r,n)}))}function Zt(s,n){const r=Vt(n);for(let i in r)r[i]=Ee.dateToString(r[i],s);return r}function Jt(s,n){if(!s||!s.length)return s;const r=Ee.dateToString("%d-%m-%Y",n);return s.map(i=>i.template?i:i.id==="start"||i.id=="end"?{...i,_template:l=>r(l),template:l=>r(l)}:i.id==="duration"?{...i,_template:l=>l,template:l=>l}:i)}function es(s,n){return s.levels?{...s,levels:s.levels.map(r=>({...r,scales:kt(r.scales,n)}))}:s}const ts=s=>s.split("-").map(n=>n?n.charAt(0).toUpperCase()+n.slice(1):"").join(""),ss=[{unit:"month",step:1,format:"%F %Y"},{unit:"day",step:1,format:"%j"}],ns=e.forwardRef(function({taskTemplate:n=null,markers:r=[],taskTypes:i=pe.defaultTaskTypes,tasks:l=[],selected:N=[],activeTask:h=null,links:T=[],scales:o=ss,columns:C=pe.defaultColumns,start:k=null,end:F=null,lengthUnit:Y="day",durationUnit:M="day",cellWidth:w=100,cellHeight:f=38,scaleHeight:U=36,readonly:W=!1,cellBorders:_="full",zoom:K=!1,baselines:S=!1,highlightTime:P=null,init:E=null,autoScale:V=!0,unscheduledTasks:se=!1,criticalPath:Q=null,schedule:ae={type:"forward"},projectStart:X=null,projectEnd:le=null,calendar:R=null,undo:x=!1,splitTasks:A=!1,multiTaskRows:ee=!1,marqueeSelect:ue=!1,copyPaste:ne=!1,currentWeekHighlight:ce=!1,currentWeekColor:be=null,scrollToCurrentWeek:je=!1,allowTaskIntersection:De=!0,...ve},Le){const ke=e.useRef();ke.current=ve;const J=e.useMemo(()=>new pe.DataStore($.writable),[]),p=e.useMemo(()=>({...Je.en,...Be.en}),[]),O=e.useContext(Te.context.i18n),B=e.useMemo(()=>O?O.extend(p,!0):Ee.locale(p),[O,p]),q=e.useMemo(()=>B.getRaw().calendar,[B]),z=e.useMemo(()=>{let te={zoom:es(K,q),scales:kt(o,q),columns:Jt(C,q),links:pe.normalizeLinks(T),cellWidth:w};return te.zoom&&(te={...te,...pe.normalizeZoom(te.zoom,Zt(q,B.getGroup("gantt")),te.scales,w)}),te},[K,o,C,T,w,q,B]),ge=e.useRef(null);ge.current!==l&&(pe.parseTaskDates(l,{durationUnit:M,splitTasks:A,calendar:R}),ge.current=l),e.useEffect(()=>{pe.parseTaskDates(l,{durationUnit:M,splitTasks:A,calendar:R})},[l,M,R,A]);const re=e.useMemo(()=>{if(!ee)return null;const te=new Map,Se=new Map,ye=Me=>{Me.forEach(Pe=>{const Oe=Pe.row??Pe.id;Se.set(Pe.id,Oe),te.has(Oe)||te.set(Oe,[]),te.get(Oe).push(Pe.id),Pe.data&&Pe.data.length>0&&ye(Pe.data)})};return ye(l),{rowMap:te,taskRows:Se}},[l,ee]),v=e.useMemo(()=>J.in,[J]),Z=e.useRef(null);Z.current===null&&(Z.current=new jt.EventBusRouter((te,Se)=>{const ye="on"+ts(te);ke.current&&ke.current[ye]&&ke.current[ye](Se)}),v.setNext(Z.current));const[de,fe]=e.useState(null),m=e.useRef(null);m.current=de;const oe=e.useMemo(()=>({getState:J.getState.bind(J),getReactiveState:J.getReactive.bind(J),getStores:()=>({data:J}),exec:v.exec,setNext:te=>(Z.current=Z.current.setNext(te),Z.current),intercept:v.intercept.bind(v),on:v.on.bind(v),detach:v.detach.bind(v),getTask:J.getTask.bind(J),serialize:J.serialize.bind(J),getTable:te=>te?new Promise(Se=>setTimeout(()=>Se(m.current),1)):m.current,getHistory:()=>J.getHistory()}),[J,v]);e.useImperativeHandle(Le,()=>({...oe}),[oe]);const xe=e.useRef(0);e.useEffect(()=>{xe.current?J.init({tasks:l,links:z.links,start:k,columns:z.columns,end:F,lengthUnit:Y,cellWidth:z.cellWidth,cellHeight:f,scaleHeight:U,scales:z.scales,taskTypes:i,zoom:z.zoom,selected:N,activeTask:h,baselines:S,autoScale:V,unscheduledTasks:se,markers:r,durationUnit:M,criticalPath:Q,schedule:ae,projectStart:X,projectEnd:le,calendar:R,undo:x,_weekStart:q.weekStart,splitTasks:A}):E&&E(oe),xe.current++},[oe,E,l,z,k,F,Y,f,U,i,N,h,S,V,se,r,M,Q,ae,X,le,R,x,q,A,J]),xe.current===0&&J.init({tasks:l,links:z.links,start:k,columns:z.columns,end:F,lengthUnit:Y,cellWidth:z.cellWidth,cellHeight:f,scaleHeight:U,scales:z.scales,taskTypes:i,zoom:z.zoom,selected:N,activeTask:h,baselines:S,autoScale:V,unscheduledTasks:se,markers:r,durationUnit:M,criticalPath:Q,schedule:ae,projectStart:X,projectEnd:le,calendar:R,undo:x,_weekStart:q.weekStart,splitTasks:A});const G=e.useMemo(()=>{const te=new Date,Se=q?.weekStart??0,ye=new Date(Date.UTC(te.getUTCFullYear(),te.getUTCMonth(),te.getUTCDate())),Pe=(ye.getUTCDay()-Se+7)%7;ye.setUTCDate(ye.getUTCDate()-Pe),ye.setUTCHours(0,0,0,0);const Oe=new Date(ye);return Oe.setUTCDate(Oe.getUTCDate()+7),a=>a>=ye&&a<Oe},[q]),Ce=e.useMemo(()=>(te,Se)=>{let ye=[];if(R)Se=="day"&&!R.getDayHours(te)&&ye.push("wx-weekend"),Se=="hour"&&!R.getDayHours(te)&&ye.push("wx-weekend");else if(P){const Me=P(te,Se);Me&&ye.push(Me)}return ce&&(Se==="week"||Se==="day")&&G(te)&&ye.push("wx-current-week"),ye.join(" ")},[R,P,ce,G]);return c.jsx(Te.context.i18n.Provider,{value:B,children:c.jsx(He.Provider,{value:oe,children:c.jsx(Bt,{taskTemplate:n,readonly:W,cellBorders:_,highlightTime:Ce,onTableAPIChange:fe,multiTaskRows:ee,rowMapping:re,marqueeSelect:ue,copyPaste:ne,scrollToCurrentWeek:je,currentWeekColor:be,allowTaskIntersection:De})})})});function rs({api:s=null,items:n=[]}){const r=e.useContext(Te.context.i18n),i=e.useMemo(()=>r||Ee.locale(Be.en),[r]),l=e.useMemo(()=>i.getGroup("gantt"),[i]),N=$.useStoreLater(s,"_selected"),h=$.useStoreLater(s,"undo"),T=$.useStoreLater(s,"history"),o=$.useStoreLater(s,"splitTasks"),C=["undo","redo"],k=e.useMemo(()=>{const Y=pe.getToolbarButtons({undo:!0,splitTasks:!0});return(n.length?n:pe.getToolbarButtons({undo:h,splitTasks:o})).map(w=>{let f={...w,disabled:!1};return f.handler=pe.isHandledAction(Y,f.id)?U=>pe.handleAction(s,U.id,null,l):f.handler,f.text&&(f.text=l(f.text)),f.menuText&&(f.menuText=l(f.menuText)),f})},[n,s,l,h,o]),F=e.useMemo(()=>{const Y=[];return k.forEach(M=>{const w=M.id;if(w==="add-task")Y.push(M);else if(C.includes(w))C.includes(w)&&Y.push({...M,disabled:M.isDisabled(T)});else{if(!N?.length||!s)return;Y.push({...M,disabled:M.isDisabled&&N.some(f=>M.isDisabled(f,s.getState()))})}}),Y.filter((M,w)=>{if(s&&M.isHidden)return!N.some(f=>M.isHidden(f,s.getState()));if(M.comp==="separator"){const f=Y[w+1];if(!f||f.comp==="separator")return!1}return!0})},[s,N,T,k]);return r?c.jsx(ut.Toolbar,{items:F}):c.jsx(Te.context.i18n.Provider,{value:i,children:c.jsx(ut.Toolbar,{items:F})})}const os=e.forwardRef(function({options:n=[],api:r=null,resolver:i=null,filter:l=null,at:N="point",children:h,onClick:T,css:o},C){const k=e.useRef(null),F=e.useRef(null),Y=e.useContext(Te.context.i18n),M=e.useMemo(()=>Y||Ee.locale({...Be.en,...Je.en}),[Y]),w=e.useMemo(()=>M.getGroup("gantt"),[M]),f=$.useStoreLater(r,"taskTypes"),U=$.useStoreLater(r,"selected"),W=$.useStoreLater(r,"_selected"),_=$.useStoreLater(r,"splitTasks"),K=e.useMemo(()=>pe.getMenuOptions({splitTasks:!0}),[]);e.useEffect(()=>{r&&(r.on("scroll-chart",()=>{k.current&&k.current.show&&k.current.show()}),r.on("drag-task",()=>{k.current&&k.current.show&&k.current.show()}))},[r]);function S(R){return R.map(x=>(x={...x},x.text&&(x.text=w(x.text)),x.subtext&&(x.subtext=w(x.subtext)),x.data&&(x.data=S(x.data)),x))}function P(){const R=n.length?n:pe.getMenuOptions({splitTasks:_}),x=R.find(A=>A.id==="convert-task");return x&&(x.data=[],(f||[]).forEach(A=>{x.data.push(x.dataFactory(A))})),S(R)}const E=e.useMemo(()=>P(),[r,n,f,_,w]),V=e.useMemo(()=>W&&W.length?W:[],[W]),se=e.useCallback((R,x)=>{let A=R?r?.getTask(R):null;if(i){const ee=i(R,x);A=ee===!0?A:ee}if(A){const ee=Ee.locateID(x.target,"data-segment");ee!==null?F.current={id:A.id,segmentIndex:ee}:F.current=A.id,(!Array.isArray(U)||!U.includes(A.id))&&r&&r.exec&&r.exec("select-task",{id:A.id})}return A},[r,i,U]),Q=e.useCallback(R=>{const x=R.action;x&&(pe.isHandledAction(K,x.id)&&pe.handleAction(r,x.id,F.current,w),T&&T(R))},[r,w,T,K]),ae=e.useCallback((R,x)=>{const A=V.length?V:x?[x]:[];let ee=l?A.every(ue=>l(R,ue)):!0;if(ee&&(R.isHidden&&(ee=!A.some(ue=>R.isHidden(ue,r.getState(),F.current))),R.isDisabled)){const ue=A.some(ne=>R.isDisabled(ne,r.getState(),F.current));R.disabled=ue}return ee},[l,V,r]);e.useImperativeHandle(C,()=>({show:(R,x)=>{k.current&&k.current.show&&k.current.show(R,x)}}));const X=e.useCallback(R=>{k.current&&k.current.show&&k.current.show(R)},[]),le=c.jsxs(c.Fragment,{children:[c.jsx(Dt.ContextMenu,{filter:ae,options:E,dataKey:"id",resolver:se,onClick:Q,at:N,ref:k,css:o}),c.jsx("span",{onContextMenu:X,"data-menu-ignore":"true",children:typeof h=="function"?h():h})]});if(!Y&&Te.context.i18n?.Provider){const R=Te.context.i18n.Provider;return c.jsx(R,{value:M,children:le})}return le});function ls({api:s,autoSave:n,onLinksChange:r}){const l=e.useContext(Te.context.i18n).getGroup("gantt"),N=$.useStore(s,"activeTask"),h=$.useStore(s,"_activeTask"),T=$.useStore(s,"_links"),o=$.useStore(s,"schedule"),C=$.useStore(s,"unscheduledTasks"),[k,F]=e.useState();function Y(){if(N){const U=T.filter(_=>_.target==N).map(_=>({link:_,task:s.getTask(_.source)})),W=T.filter(_=>_.source==N).map(_=>({link:_,task:s.getTask(_.target)}));return[{title:l("Predecessors"),data:U},{title:l("Successors"),data:W}]}}e.useEffect(()=>{F(Y())},[N,T]);const M=e.useMemo(()=>[{id:"e2s",label:l("End-to-start")},{id:"s2s",label:l("Start-to-start")},{id:"e2e",label:l("End-to-end")},{id:"s2e",label:l("Start-to-end")}],[l]);function w(U){n?s.exec("delete-link",{id:U}):(F(W=>(W||[]).map(_=>({..._,data:_.data.filter(K=>K.link.id!==U)}))),r&&r({id:U,action:"delete-link",data:{id:U}}))}function f(U,W){n?s.exec("update-link",{id:U,link:W}):(F(_=>(_||[]).map(K=>({...K,data:K.data.map(S=>S.link.id===U?{...S,link:{...S.link,...W}}:S)}))),r&&r({id:U,action:"update-link",data:{id:U,link:W}}))}return c.jsx(c.Fragment,{children:(k||[]).map((U,W)=>U.data.length?c.jsx("div",{className:"wx-j93aYGQf wx-links",children:c.jsx(Te.Field,{label:U.title,position:"top",children:c.jsx("table",{children:c.jsx("tbody",{children:U.data.map(_=>c.jsxs("tr",{children:[c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("div",{className:"wx-j93aYGQf wx-task-name",children:_.task.text||""})}),o?.auto&&_.link.type==="e2s"?c.jsx("td",{className:"wx-j93aYGQf wx-cell wx-link-lag",children:c.jsx(Te.Text,{type:"number",placeholder:l("Lag"),value:_.link.lag,disabled:C&&h?.unscheduled,onChange:K=>{K.input||f(_.link.id,{lag:K.value})}})}):null,c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("div",{className:"wx-j93aYGQf wx-wrapper",children:c.jsx(Te.Combo,{value:_.link.type,placeholder:l("Select link type"),options:M,onChange:K=>f(_.link.id,{type:K.value}),children:({option:K})=>K.label})})}),c.jsx("td",{className:"wx-j93aYGQf wx-cell",children:c.jsx("i",{className:"wx-j93aYGQf wxi-delete wx-delete-icon",onClick:()=>w(_.link.id),role:"button"})})]},_.link.id))})})})},W):null)})}function cs(s){const{value:n,time:r,format:i,onchange:l,onChange:N,...h}=s,T=N??l;function o(C){const k=new Date(C.value);k.setUTCHours(n.getUTCHours()),k.setUTCMinutes(n.getUTCMinutes()),T&&T({value:k})}return c.jsxs("div",{className:"wx-hFsbgDln date-time-controll",children:[c.jsx(Te.DatePicker,{...h,value:n,onChange:o,format:i,buttons:["today"],clear:!1}),r?c.jsx(Te.TimePicker,{value:n,onChange:T,format:i}):null]})}_e.registerEditorItem("select",Te.RichSelect);_e.registerEditorItem("date",cs);_e.registerEditorItem("twostate",Te.TwoState);_e.registerEditorItem("slider",Te.Slider);_e.registerEditorItem("counter",Te.Counter);_e.registerEditorItem("links",ls);function is({api:s,items:n=[],css:r="",layout:i="default",readonly:l=!1,placement:N="sidebar",bottomBar:h=!0,topBar:T=!0,autoSave:o=!0,focus:C=!1,hotkeys:k={}}){const F=e.useContext(Te.context.i18n),Y=e.useMemo(()=>F||Ee.locale({...Be.en,...Je.en}),[F]),M=e.useMemo(()=>Y.getGroup("gantt"),[Y]),w=Y.getRaw(),f=e.useMemo(()=>{const m=w.gantt?.dateFormat||w.formats?.dateFormat;return Ee.dateToString(m,w.calendar)},[w]),U=e.useMemo(()=>{if(T===!0&&!l){const m=[{comp:"icon",icon:"wxi-close",id:"close"},{comp:"spacer"},{comp:"button",type:"danger",text:M("Delete"),id:"delete"}];return o?{items:m}:{items:[...m,{comp:"button",type:"primary",text:M("Save"),id:"save"}]}}return T},[T,l,o,M]),[W,_]=e.useState(!1),K=e.useMemo(()=>W?"wx-full-screen":"",[W]),S=e.useCallback(m=>{_(m)},[]);e.useEffect(()=>{const m=pt(S);return m.observe(),()=>{m.disconnect()}},[S]);const P=$.useStore(s,"_activeTask"),E=$.useStore(s,"activeTask"),V=$.useStore(s,"unscheduledTasks"),se=$.useStore(s,"links"),Q=$.useStore(s,"splitTasks"),ae=e.useMemo(()=>Q&&E?.segmentIndex,[Q,E]),X=e.useMemo(()=>ae||ae===0,[ae]),le=e.useMemo(()=>pe.getEditorItems({unscheduledTasks:V}),[V]),R=$.useStore(s,"undo"),[x,A]=e.useState({}),[ee,ue]=e.useState(null),[ne,ce]=e.useState(),[be,je]=e.useState(null),De=$.useStore(s,"taskTypes"),ve=e.useMemo(()=>{if(!P)return null;let m;if(X&&P.segments?m={...P.segments[ae]}:m={...P},l){let oe={parent:m.parent};return le.forEach(({key:xe,comp:G})=>{if(G!=="links"){const Ce=m[xe];G==="date"&&Ce instanceof Date?oe[xe]=f(Ce):G==="slider"&&xe==="progress"?oe[xe]=`${Ce}%`:oe[xe]=Ce}}),oe}return m||null},[P,X,ae,l,le,f]);e.useEffect(()=>{ce(ve)},[ve]),e.useEffect(()=>{A({}),je(null),ue(null)},[E]);function Le(m,oe){return m.map(xe=>{const G={...xe};if(xe.config&&(G.config={...G.config}),G.comp==="links"&&s&&(G.api=s,G.autoSave=o,G.onLinksChange=p),G.comp==="select"&&G.key==="type"){const Ce=G.options??(De||[]);G.options=Ce.map(te=>({...te,label:M(te.label)}))}return G.comp==="slider"&&G.key==="progress"&&(G.labelTemplate=Ce=>`${M(G.label)} ${Ce}%`),G.label&&(G.label=M(G.label)),G.config?.placeholder&&(G.config.placeholder=M(G.config.placeholder)),oe&&(G.isDisabled&&G.isDisabled(oe,s.getState())?G.disabled=!0:delete G.disabled),G})}const ke=e.useMemo(()=>{let m=n.length?n:le;return m=Le(m,ne),ne?m.filter(oe=>!oe.isHidden||!oe.isHidden(ne,s.getState())):m},[n,le,ne,De,M,s,o]),J=e.useMemo(()=>ke.map(m=>m.key),[ke]);function p({id:m,action:oe,data:xe}){A(G=>({...G,[m]:{action:oe,data:xe}}))}const O=e.useCallback(()=>{for(let m in x)if(se.byId(m)){const{action:oe,data:xe}=x[m];s.exec(oe,xe)}},[s,x,se]),B=e.useCallback(()=>{const m=E?.id||E;if(X){if(P?.segments){const oe=P.segments.filter((xe,G)=>G!==ae);s.exec("update-task",{id:m,task:{segments:oe}})}}else s.exec("delete-task",{id:m})},[s,E,X,P,ae]),q=e.useCallback(()=>{s.exec("show-editor",{id:null})},[s]),z=e.useCallback(m=>{const{item:oe,changes:xe}=m;oe.id==="delete"&&B(),oe.id==="save"&&(xe.length?q():O()),oe.comp&&q()},[s,E,o,O,B,q]),ge=e.useCallback((m,oe,xe)=>(V&&m.type==="summary"&&(m.unscheduled=!1),pe.prepareEditTask(m,s.getState(),oe),xe||ue(!1),m),[V,s]),re=e.useCallback(m=>{m={...m,unscheduled:V&&m.unscheduled&&m.type!=="summary"},delete m.links,delete m.data,(J.indexOf("duration")===-1||m.segments&&!m.duration)&&delete m.duration;const oe={id:E?.id||E,task:m,...X&&{segmentIndex:ae}};o&&ee&&(oe.inProgress=ee),s.exec("update-task",oe),o||O()},[s,E,V,o,O,J,X,ae,ee]),v=e.useCallback(m=>{let{update:oe,key:xe,input:G}=m;if(G&&ue(!0),m.update=ge({...oe},xe,G),!o)ce(m.update);else if(!be&&!G){const Ce=ke.find(ye=>ye.key===xe),te=oe[xe];(!Ce.validation||Ce.validation(te))&&(!Ce.required||te)&&re(m.update)}},[o,ge,be,ke,re]),Z=e.useCallback(m=>{o||re(m.values)},[o,re]),de=e.useCallback(m=>{je(m.errors)},[]),fe=e.useMemo(()=>R?{"ctrl+z":m=>{m.preventDefault(),s.exec("undo")},"ctrl+y":m=>{m.preventDefault(),s.exec("redo")}}:{},[R,s]);return ve?c.jsx(Te.Locale,{children:c.jsx(_e.Editor,{css:`wx-XkvqDXuw wx-gantt-editor ${K} ${r}`,items:ke,values:ve,topBar:U,bottomBar:h,placement:N,layout:i,readonly:l,autoSave:o,focus:C,onAction:z,onSave:Z,onValidation:de,onChange:v,hotkeys:k&&{...fe,...k}})}):null}const as=({children:s,columns:n=null,api:r})=>{const[i,l]=e.useState(null);return e.useEffect(()=>{r&&r.getTable(!0).then(l)},[r]),c.jsx(wt.HeaderMenu,{api:i,columns:n,children:s})};function us(s){const{api:n,content:r,children:i}=s,l=e.useRef(null),N=e.useRef(null),[h,T]=e.useState({}),[o,C]=e.useState(null),[k,F]=e.useState({});function Y(S){for(;S;){if(S.getAttribute){const P=S.getAttribute("data-tooltip-id"),E=S.getAttribute("data-tooltip-at"),V=S.getAttribute("data-tooltip");if(P||V)return{id:P,tooltip:V,target:S,at:E}}S=S.parentNode}return{id:null,tooltip:null,target:null,at:null}}e.useEffect(()=>{const S=N.current;if(S&&k&&(k.text||r)){const P=S.getBoundingClientRect();let E=!1,V=k.left,se=k.top;P.right>=h.right&&(V=h.width-P.width-5,E=!0),P.bottom>=h.bottom&&(se=k.top-(P.bottom-h.bottom+2),E=!0),E&&F(Q=>Q&&{...Q,left:V,top:se})}},[k,h,r]);const M=e.useRef(null),w=300,f=S=>{clearTimeout(M.current),M.current=setTimeout(()=>{S()},w)};function U(S){let{id:P,tooltip:E,target:V,at:se}=Y(S.target);if(F(null),C(null),!E)if(P)E=_(P);else{clearTimeout(M.current);return}const Q=S.clientX;f(()=>{P&&C(W(K(P)));const ae=V.getBoundingClientRect(),X=l.current,le=X?X.getBoundingClientRect():{top:0,left:0,right:0,bottom:0,width:0,height:0};let R,x;se==="left"?(R=ae.top+5-le.top,x=ae.right+5-le.left):(R=ae.top+ae.height-le.top,x=Q-le.left),T(le),F({top:R,left:x,text:E})})}function W(S){return n?.getTask(K(S))||null}function _(S){return W(S)?.text||""}function K(S){const P=parseInt(S);return isNaN(P)?S:P}return c.jsxs("div",{className:"wx-KG0Lwsqo wx-tooltip-area",ref:l,onMouseMove:U,children:[k&&(k.text||r)?c.jsx("div",{className:"wx-KG0Lwsqo wx-gantt-tooltip",ref:N,style:{top:`${k.top}px`,left:`${k.left}px`},children:r?c.jsx(r,{data:o}):k.text?c.jsx("div",{className:"wx-KG0Lwsqo wx-gantt-tooltip-text",children:k.text}):null}):null,i]})}function ds({fonts:s=!0,children:n}){return n?c.jsx(Te.Material,{fonts:s,children:n()}):c.jsx(Te.Material,{fonts:s})}function fs({fonts:s=!0,children:n}){return n?c.jsx(Te.Willow,{fonts:s,children:n}):c.jsx(Te.Willow,{fonts:s})}function xs({fonts:s=!0,children:n}){return n?c.jsx(Te.WillowDark,{fonts:s,children:n}):c.jsx(Te.WillowDark,{fonts:s})}Object.defineProperty(exports,"defaultColumns",{enumerable:!0,get:()=>pe.defaultColumns});Object.defineProperty(exports,"defaultEditorItems",{enumerable:!0,get:()=>pe.defaultEditorItems});Object.defineProperty(exports,"defaultMenuOptions",{enumerable:!0,get:()=>pe.defaultMenuOptions});Object.defineProperty(exports,"defaultTaskTypes",{enumerable:!0,get:()=>pe.defaultTaskTypes});Object.defineProperty(exports,"defaultToolbarButtons",{enumerable:!0,get:()=>pe.defaultToolbarButtons});Object.defineProperty(exports,"getEditorItems",{enumerable:!0,get:()=>pe.getEditorItems});Object.defineProperty(exports,"getMenuOptions",{enumerable:!0,get:()=>pe.getMenuOptions});Object.defineProperty(exports,"getToolbarButtons",{enumerable:!0,get:()=>pe.getToolbarButtons});Object.defineProperty(exports,"registerScaleUnit",{enumerable:!0,get:()=>pe.registerScaleUnit});Object.defineProperty(exports,"registerEditorItem",{enumerable:!0,get:()=>_e.registerEditorItem});exports.ContextMenu=os;exports.Editor=is;exports.Gantt=ns;exports.HeaderMenu=as;exports.Material=ds;exports.Toolbar=rs;exports.Tooltip=us;exports.Willow=fs;exports.WillowDark=xs;
//# sourceMappingURL=index.cjs.map
