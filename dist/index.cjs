"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l=require("react/jsx-runtime"),e=require("react"),ye=require("@svar-ui/react-core"),Ce=require("@svar-ui/lib-dom"),Ve=require("@svar-ui/gantt-locales"),et=require("@svar-ui/core-locales"),It=require("@svar-ui/lib-state"),he=require("@svar-ui/gantt-store"),D=require("@svar-ui/lib-react"),wt=require("@svar-ui/grid-store"),pt=require("@svar-ui/react-grid"),Lt=require("react-dom"),dt=require("@svar-ui/react-toolbar"),Nt=require("@svar-ui/react-menu"),_e=require("@svar-ui/react-editor"),Ae=e.createContext(null);function Ge(s){const n=s.getAttribute("data-id"),r=parseInt(n);return isNaN(r)||r.toString()!=n?n:r}function Pt(s,n,r){const i=s.getBoundingClientRect(),o=n.querySelector(".wx-body").getBoundingClientRect();return{top:i.top-o.top,left:i.left-o.left,dt:i.bottom-r.clientY,db:r.clientY-i.top}}function ft(s){return s&&s.getAttribute("data-context-id")}const xt=5;function Ot(s,n){let r,i,o,N,v,p,b,a,h;function F(T){N=T.clientX,v=T.clientY,p={...Pt(r,s,T),y:n.getTask(o).$y},document.body.style.userSelect="none"}function H(T){r=Ce.locate(T),ft(r)&&(o=Ge(r),h=setTimeout(()=>{a=!0,n&&n.touchStart&&n.touchStart(),F(T.touches[0])},500),s.addEventListener("touchmove",X),s.addEventListener("contextmenu",G),window.addEventListener("touchend",W))}function G(T){if(a||h)return T.preventDefault(),!1}function Q(T){T.which===1&&(r=Ce.locate(T),ft(r)&&(o=Ge(r),s.addEventListener("mousemove",P),window.addEventListener("mouseup",L),F(T)))}function f(T){s.removeEventListener("mousemove",P),s.removeEventListener("touchmove",X),document.body.removeEventListener("mouseup",L),document.body.removeEventListener("touchend",W),document.body.style.userSelect="",T&&(s.removeEventListener("mousedown",Q),s.removeEventListener("touchstart",H))}function M(T){const Z=T.clientX-N,ce=T.clientY-v;if(!i){if(Math.abs(Z)<xt&&Math.abs(ce)<xt||n&&n.start&&n.start({id:o,e:T})===!1)return;i=r.cloneNode(!0),i.style.pointerEvents="none",i.classList.add("wx-reorder-task"),i.style.position="absolute",i.style.left=p.left+"px",i.style.top=p.top+"px",r.style.visibility="hidden",r.parentNode.insertBefore(i,r)}if(i){const oe=Math.round(Math.max(0,p.top+ce));if(n&&n.move&&n.move({id:o,top:oe,detail:b})===!1)return;const te=n.getTask(o),J=te.$y;if(!p.start&&p.y==J)return O();p.start=!0,p.y=te.$y-4,i.style.top=oe+"px";const de=document.elementFromPoint(T.clientX,T.clientY),k=Ce.locate(de);if(k&&k!==r){const S=Ge(k),V=k.getBoundingClientRect(),le=V.top+V.height/2,I=T.clientY+p.db>le&&k.nextElementSibling!==r,ue=T.clientY-p.dt<le&&k.previousElementSibling!==r;b?.after==S||b?.before==S?b=null:I?b={id:o,after:S}:ue&&(b={id:o,before:S})}}}function P(T){M(T)}function X(T){a?(T.preventDefault(),M(T.touches[0])):h&&(clearTimeout(h),h=null)}function W(){a=null,h&&(clearTimeout(h),h=null),O()}function L(){O()}function O(){r&&(r.style.visibility=""),i&&(i.parentNode.removeChild(i),n&&n.end&&n.end({id:o,top:p.top})),o=r=i=p=b=null,f()}return s.style.position!=="absolute"&&(s.style.position="relative"),s.addEventListener("mousedown",Q),s.addEventListener("touchstart",H),{destroy(){f(!0)}}}function Wt({row:s,column:n}){function r(o,N){return{justifyContent:N.align,paddingLeft:`${(o.$level-1)*20}px`}}const i=n&&n._cell;return l.jsxs("div",{className:"wx-pqc08MHU wx-content",style:r(s,n),children:[s.data||s.lazy?l.jsx("i",{className:`wx-pqc08MHU wx-toggle-icon wxi-menu-${s.open?"down":"right"}`,"data-action":"open-task"}):l.jsx("i",{className:"wx-pqc08MHU wx-toggle-placeholder"}),l.jsx("div",{className:"wx-pqc08MHU wx-text",children:i?l.jsx(i,{row:s,column:n}):s.text})]})}function mt({column:s,cell:n}){const r=e.useMemo(()=>s.id,[s?.id]);return n||s.id=="add-task"?l.jsx("div",{style:{textAlign:s.align},children:l.jsx("i",{className:"wx-9DAESAHW wx-action-icon wxi-plus","data-action":r})}):null}function _t(s){const{readonly:n,compactMode:r,width:i=0,display:o="all",columnWidth:N=0,onTableAPIChange:v,multiTaskRows:p=!1,rowMapping:b=null}=s,[a,h]=D.useWritableProp(N),[F,H]=e.useState(),G=e.useContext(ye.context.i18n),Q=e.useMemo(()=>G.getGroup("gantt"),[G]),f=e.useContext(Ae),M=D.useStore(f,"scrollTop"),P=D.useStore(f,"cellHeight"),X=D.useStore(f,"_scrollTask"),W=D.useStore(f,"_selected"),L=D.useStore(f,"area"),O=D.useStore(f,"_tasks"),T=D.useStore(f,"_scales"),Z=D.useStore(f,"columns"),ce=D.useStore(f,"_sort"),oe=D.useStore(f,"calendar"),te=D.useStore(f,"durationUnit"),J=D.useStore(f,"splitTasks"),[de,k]=e.useState(null),S=e.useMemo(()=>!O||!L?[]:p&&b?O:O.slice(L.start,L.end),[O,L,p,b]),V=e.useCallback((c,w)=>{if(w==="add-task")f.exec(w,{target:c,task:{text:Q("New Task")},mode:"child",show:!0});else if(w==="open-task"){const R=S.find(A=>A.id===c);(R?.data||R?.lazy)&&f.exec(w,{id:c,mode:!R.open})}},[S]),le=e.useCallback(c=>{const w=Ce.locateID(c),R=c.target.dataset.action;R&&c.preventDefault(),w?R==="add-task"||R==="open-task"?V(w,R):f.exec("select-task",{id:w,toggle:c.ctrlKey||c.metaKey,range:c.shiftKey,show:!0}):R==="add-task"&&V(null,R)},[f,V]),I=e.useRef(null),ue=e.useRef(null),[se,we]=e.useState(0),[ke,ve]=e.useState(!1);e.useEffect(()=>{const c=ue.current;if(!c||typeof ResizeObserver>"u")return;const w=()=>we(c.clientWidth);w();const R=new ResizeObserver(w);return R.observe(c),()=>R.disconnect()},[]);const $e=e.useRef(null),Ee=e.useCallback(c=>{const w=c.id,{before:R,after:A}=c,ge=c.onMove;let me=R||A,Re=R?"before":"after";if(ge){if(Re==="after"){const Ne=f.getTask(me);Ne.data?.length&&Ne.open&&(Re="before",me=Ne.data[0].id)}$e.current={id:w,[Re]:me}}else $e.current=null;f.exec("move-task",{id:w,mode:Re,target:me,inProgress:ge})},[f]),Te=e.useMemo(()=>p&&b?0:L?.from??0,[L,p,b]),je=e.useMemo(()=>T?.height??0,[T]),De=e.useMemo(()=>!r&&o!=="grid"?(a??0)>(i??0):(a??0)>(se??0),[r,o,a,i,se]),ae=e.useMemo(()=>{const c={};return De&&o==="all"||o==="grid"&&De?c.width=a:o==="grid"&&(c.width="100%"),c},[De,o,a]),g=e.useMemo(()=>de&&!S.find(c=>c.id===de.id)?[...S,de]:S,[S,de]),_=e.useMemo(()=>{if(!p||!b)return g;const c=new Map,w=new Set;return g.forEach(R=>{const A=b.taskRows.get(R.id)??R.id;w.has(A)||(c.set(A,{...R,$rowTasks:b.rowMap.get(A)||[R.id]}),w.add(A))}),Array.from(c.values())},[g,p,b]),z=e.useMemo(()=>{let c=(Z||[]).map(A=>{A={...A};const ge=A.header;if(typeof ge=="object"){const me=ge.text&&Q(ge.text);A.header={...ge,text:me}}else A.header=Q(ge);return A});const w=c.findIndex(A=>A.id==="text"),R=c.findIndex(A=>A.id==="add-task");if(w!==-1&&(c[w].cell&&(c[w]._cell=c[w].cell),c[w].cell=Wt),R!==-1){c[R].cell=c[R].cell||mt;const A=c[R].header;if(typeof A!="object"&&(c[R].header={text:A}),c[R].header.cell=A.cell||mt,n)c.splice(R,1);else if(r){const[ge]=c.splice(R,1);c.unshift(ge)}}return c.length>0&&(c[c.length-1].resize=!1),c},[Z,Q,n,r]),Y=e.useMemo(()=>o==="all"?`${i}px`:o==="grid"?"calc(100% - 4px)":z.find(c=>c.id==="add-task")?"50px":"0",[o,i,z]),K=e.useMemo(()=>{if(_&&ce?.length){const c={};return ce.forEach(({key:w,order:R},A)=>{c[w]={order:R,...ce.length>1&&{index:A}}}),c}return{}},[_,ce]),xe=e.useCallback(()=>z.some(c=>c.flexgrow&&!c.hidden),[]),Se=e.useMemo(()=>xe(),[xe,ke]),y=e.useMemo(()=>{let c=o==="chart"?z.filter(R=>R.id==="add-task"):z;const w=o==="all"?i:se;if(!Se){let R=a,A=!1;if(z.some(ge=>ge.$width)){let ge=0;R=z.reduce((me,Re)=>(Re.hidden||(ge+=Re.width,me+=Re.$width||Re.width),me),0),ge>R&&R>w&&(A=!0)}if(A||R<w){let ge=1;return A||(ge=(w-50)/(R-50||1)),c.map(me=>(me.id!=="add-task"&&!me.hidden&&(me.$width||(me.$width=me.width),me.width=me.$width*ge),me))}}return c},[o,z,Se,a,i,se]),B=e.useCallback(c=>{if(!xe()){const w=y.reduce((R,A)=>(c&&A.$width&&(A.$width=A.width),R+(A.hidden?0:A.width)),0);w!==a&&h(w)}ve(!0),ve(!1)},[xe,y,a,h]),x=e.useCallback(()=>{z.filter(w=>w.flexgrow&&!w.hidden).length===1&&z.forEach(w=>{w.$width&&!w.flexgrow&&!w.hidden&&(w.width=w.$width)})},[]),q=e.useCallback(c=>{if(!n){const w=Ce.locateID(c),R=Ce.locateAttr(c,"data-col-id");!(R&&z.find(ge=>ge.id==R))?.editor&&w&&f.exec("show-editor",{id:w})}},[f,n]),ee=e.useMemo(()=>Array.isArray(W)?W.map(c=>c.id):[],[W]),U=e.useRef(Te);U.current=Te,e.useEffect(()=>{const c=R=>{if(I.current){const A=I.current.querySelector(".wx-body");A&&(A.style.top=-((R??0)-(U.current??0))+"px")}ue.current&&(ue.current.scrollTop=0)};return c(M),f.on("scroll-chart",({top:R})=>{R!==void 0&&c(R)})},[f,M]),e.useEffect(()=>{if(I.current){const c=I.current.querySelector(".wx-body");c&&(c.style.top=-((M??0)-(Te??0))+"px")}},[Te]),e.useEffect(()=>{const c=I.current;if(!c)return;const w=c.querySelector(".wx-table-box .wx-body");if(!w||typeof ResizeObserver>"u")return;const R=new ResizeObserver(()=>{if(I.current){const A=I.current.querySelector(".wx-body");A&&(A.style.top=-((M??0)-(U.current??0))+"px")}});return R.observe(w),()=>{R.disconnect()}},[y,ae,o,Y,_,M]),e.useEffect(()=>{if(!X||!F)return;const{id:c}=X,w=F.getState().focusCell;w&&w.row!==c&&I.current&&I.current.contains(document.activeElement)&&F.exec("focus-cell",{row:c,column:w.column})},[X,F]);const Me=e.useCallback(({id:c})=>{if(n)return!1;f.getTask(c).open&&f.exec("open-task",{id:c,mode:!1});const w=f.getState()._tasks.find(R=>R.id===c);if(k(w||null),!w)return!1},[f,n]),Le=e.useCallback(({id:c,top:w})=>{$e.current?Ee({...$e.current,onMove:!1}):f.exec("drag-task",{id:c,top:w+(Te??0),inProgress:!1}),k(null)},[f,Ee,Te]),We=e.useCallback(({id:c,top:w,detail:R})=>{R&&Ee({...R,onMove:!0}),f.exec("drag-task",{id:c,top:w+(Te??0),inProgress:!0})},[f,Ee,Te]);e.useEffect(()=>{const c=I.current;return c?Ot(c,{start:Me,end:Le,move:We,getTask:f.getTask}).destroy:void 0},[f,Me,Le,We]);const ne=e.useCallback(c=>{const{key:w,isInput:R}=c;if(!R&&(w==="arrowup"||w==="arrowdown"))return c.eventSource="grid",f.exec("hotkey",c),!1;if(w==="enter"){const A=F?.getState().focusCell;if(A){const{row:ge,column:me}=A;me==="add-task"?V(ge,"add-task"):me==="text"&&V(ge,"open-task")}}},[f,V,F]),fe=e.useRef(null),be=()=>{fe.current={setTableAPI:H,handleHotkey:ne,sortVal:ce,api:f,adjustColumns:x,setColumnWidth:B,tasks:S,calendarVal:oe,durationUnitVal:te,splitTasksVal:J,onTableAPIChange:v}};be(),e.useEffect(()=>{be()},[H,ne,ce,f,x,B,S,oe,te,J,v]);const Oe=e.useCallback(c=>{H(c),c.intercept("hotkey",w=>fe.current.handleHotkey(w)),c.intercept("scroll",()=>!1),c.intercept("select-row",()=>!1),c.intercept("sort-rows",w=>{const R=fe.current.sortVal,{key:A,add:ge}=w,me=R?R.find(Ne=>Ne.key===A):null;let Re="asc";return me&&(Re=!me||me.order==="asc"?"desc":"asc"),f.exec("sort-tasks",{key:A,order:Re,add:ge}),!1}),c.on("resize-column",()=>{fe.current.setColumnWidth(!0)}),c.on("hide-column",w=>{w.mode||fe.current.adjustColumns(),fe.current.setColumnWidth()}),c.intercept("update-cell",w=>{const{id:R,column:A,value:ge}=w,me=fe.current.tasks.find(Re=>Re.id===R);if(me){const Re={...me};let Ne=ge;Ne&&!isNaN(Ne)&&!(Ne instanceof Date)&&(Ne*=1),Re[A]=Ne,he.prepareEditTask(Re,{calendar:fe.current.calendarVal,durationUnit:fe.current.durationUnitVal,splitTasks:fe.current.splitTasksVal},A),f.exec("update-task",{id:R,task:Re})}return!1}),v&&v(c)},[]);return l.jsx("div",{className:"wx-rHj6070p wx-table-container",style:{flex:`0 0 ${Y}`},ref:ue,children:l.jsx("div",{ref:I,style:ae,className:"wx-rHj6070p wx-table",onClick:le,onDoubleClick:q,children:l.jsx(pt.Grid,{init:Oe,sizes:{rowHeight:P,headerHeight:(je??0)-1},rowStyle:c=>c.$reorder?"wx-rHj6070p wx-reorder-task":"wx-rHj6070p",columnStyle:c=>`wx-rHj6070p wx-text-${c.align}${c.id==="add-task"?" wx-action":""}`,data:_,columns:y,selectedRows:[...ee],sortMarks:K})})})}function At({borders:s=""}){const n=e.useContext(Ae),r=D.useStore(n,"cellWidth"),i=D.useStore(n,"cellHeight"),o=e.useRef(null),[N,v]=e.useState("#e4e4e4");e.useEffect(()=>{if(typeof getComputedStyle<"u"&&o.current){const b=getComputedStyle(o.current).getPropertyValue("--wx-gantt-border");v(b?b.substring(b.indexOf("#")):"#1d1e261a")}},[]);const p={width:"100%",height:"100%",background:r!=null&&i!=null?`url(${he.grid(r,i,N,s)})`:void 0,position:"absolute",pointerEvents:"none"};return l.jsx("div",{ref:o,style:p})}function Ht({onSelectLink:s,selectedLink:n,readonly:r}){const i=e.useContext(Ae),o=D.useStore(i,"_links"),N=D.useStore(i,"criticalPath"),v=e.useRef(null),p=e.useCallback(b=>{const a=b?.target?.classList;!a?.contains("wx-line")&&!a?.contains("wx-delete-button")&&s(null)},[s]);return e.useEffect(()=>{if(!r&&n&&v.current){const b=a=>{v.current&&!v.current.contains(a.target)&&p(a)};return document.addEventListener("click",b),()=>{document.removeEventListener("click",b)}}},[r,n,p]),l.jsxs("svg",{className:"wx-dkx3NwEn wx-links",children:[(o||[]).map(b=>{const a="wx-dkx3NwEn wx-line"+(N&&b.$critical?" wx-critical":"")+(r?"":" wx-line-selectable");return l.jsx("polyline",{className:a,points:b.$p,onClick:()=>!r&&s(b.id),"data-link-id":b.id},b.id)}),!r&&n&&l.jsx("polyline",{ref:v,className:"wx-dkx3NwEn wx-line wx-line-selected wx-line-selectable wx-delete-link",points:n.$p})]})}function Gt(s){const{task:n,type:r}=s;function i(N){const v=n.segments[N];return{left:`${v.$x}px`,top:"0px",width:`${v.$w}px`,height:"100%"}}function o(N){if(!n.progress)return 0;const v=n.duration*n.progress/100,p=n.segments;let b=0,a=0,h=null;do{const F=p[a];a===N&&(b>v?h=0:h=Math.min((v-b)/F.duration,1)*100),b+=F.duration,a++}while(h===null&&a<p.length);return h||0}return l.jsx("div",{className:"wx-segments wx-GKbcLEGA",children:n.segments.map((N,v)=>l.jsxs("div",{className:`wx-segment wx-bar wx-${r} wx-GKbcLEGA`,"data-segment":v,style:i(v),children:[n.progress?l.jsx("div",{className:"wx-progress-wrapper",children:l.jsx("div",{className:"wx-progress-percent wx-GKbcLEGA",style:{width:`${o(v)}%`}})}):null,l.jsx("div",{className:"wx-content",children:N.text||""})]},v))})}let Ye=[],Je=null,ht=null;const gt=(s,n)=>{if(!n||!n.start)return null;const{start:r,lengthUnitWidth:i,lengthUnit:o}=n,N=864e5,v=o==="week"?7:o==="month"?30:o==="quarter"?91:o==="year"?365:1,p=Math.floor(s/i),b=new Date(r.getTime()+p*v*N);return b.setUTCHours(0,0,0,0),console.log("[pixelToDate]",{px:s,units:p,scalesStart:r.toISOString(),result:b.toISOString()}),b},zt=(s,n,r)=>{if(!r||!s||!n)return 0;const{lengthUnit:i}=r,v=(i==="week"?7:i==="month"?30:i==="quarter"?91:i==="year"?365:1)*864e5;return Math.round((s.getTime()-n.getTime())/v)},Ut=(s,n,r)=>{if(!r||!s)return console.log("[addCells] early return:",{scales:!!r,date:s?.toISOString?.()}),s;const{lengthUnit:i}=r,v=(i==="week"?7:i==="month"?30:i==="quarter"?91:i==="year"?365:1)*864e5,p=new Date(s.getTime()+n*v);return p.setUTCHours(0,0,0,0),console.log("[addCells]",{date:s.toISOString(),cells:n,lengthUnit:i,result:p.toISOString()}),p},qt=(s,n,r,i)=>s<i&&n>r;function Yt(s){const{readonly:n,taskTemplate:r,multiTaskRows:i=!1,rowMapping:o=null,marqueeSelect:N=!1,copyPaste:v=!1,allowTaskIntersection:p=!0,summaryBarCounts:b=!1}=s,a=e.useContext(Ae),[h,F]=D.useStoreWithCounter(a,"_tasks"),[H,G]=D.useStoreWithCounter(a,"_links"),Q=D.useStore(a,"area"),f=D.useStore(a,"_scales"),M=D.useStore(a,"taskTypes"),P=e.useMemo(()=>{if(!f||!f.start)return f;const t=new Date(Date.UTC(f.start.getFullYear(),f.start.getMonth(),f.start.getDate())),u=t.getUTCDay(),d=u===0?-6:1-u,m=new Date(t.getTime()+d*864e5);return m.setUTCHours(0,0,0,0),console.log("[scales-normalize]",{raw:f.start.toISOString(),utc:t.toISOString(),dayOfWeek:u,daysToMonday:d,monday:m.toISOString()}),{...f,start:m}},[f]),X=D.useStore(a,"baselines"),[W,L]=D.useStoreWithCounter(a,"_selected"),O=D.useStore(a,"_scrollTask"),T=D.useStore(a,"criticalPath"),Z=D.useStore(a,"tasks"),ce=D.useStore(a,"schedule"),oe=D.useStore(a,"splitTasks"),te=e.useMemo(()=>{if(!Q||!Array.isArray(h))return[];const t=Q.start??0,u=Q.end??0;return i&&o?h.map(d=>({...d})):h.slice(t,u).map(d=>({...d}))},[F,Q,i,o]),J=D.useStore(a,"cellHeight"),de=e.useMemo(()=>{if(!i||!o||!te.length)return te;const t=new Map,u=[];return h.forEach(d=>{const m=o.taskRows.get(d.id)??d.id;t.has(m)||(t.set(m,u.length),u.push(m))}),te.map(d=>{const m=o.taskRows.get(d.id)??d.id,$=t.get(m)??0;return{...d,$y:$*J,$y_base:d.$y_base!==void 0?$*J:void 0}})},[te,i,o,h,J]),k=e.useMemo(()=>P.lengthUnitWidth,[P]),S=e.useMemo(()=>P.lengthUnit||"day",[P]),V=e.useMemo(()=>{if(!b||!h?.length||!k)return null;const t=new Map,u=new Set;h.forEach(m=>{m.type==="summary"&&u.add(m.id),m.parent&&m.parent!==0&&m.type!=="summary"&&(t.has(m.parent)||t.set(m.parent,[]),t.get(m.parent).push(m))});const d=new Map;return u.forEach(m=>{const $=t.get(m);if(!$?.length)return;const E=new Map;$.forEach(C=>{if(C.$x==null||C.$w==null)return;const j=Math.floor(C.$x/k),re=Math.ceil((C.$x+C.$w)/k);for(let ie=j;ie<re;ie++)E.set(ie,(E.get(ie)||0)+1)}),E.size>0&&d.set(m,E)}),d},[b,h,k]),le=e.useRef(!1),[I,ue]=e.useState(void 0),[se,we]=e.useState(null),ke=e.useRef(null),[ve,$e]=e.useState(null),[Ee,Te]=e.useState(void 0),je=e.useRef(null),[De,ae]=e.useState(0),[g,_]=e.useState(null),z=e.useRef(null),[Y,K]=e.useState(null),[xe,Se]=e.useState(null),[y,B]=e.useState(null),x=e.useRef(null);x.current=xe;const q=e.useRef(200),ee=e.useRef(null),U=e.useMemo(()=>{const t=ee.current;return!!(W.length&&t&&t.contains(document.activeElement))},[W,ee.current]),Me=e.useMemo(()=>U&&W[W.length-1]?.id,[U,W]);e.useEffect(()=>{if(O&&U&&O){const{id:t}=O,u=ee.current?.querySelector(`.wx-bar[data-id='${t}']`);u&&u.focus({preventScroll:!0})}},[O]),e.useEffect(()=>{const t=ee.current;if(t&&(ae(t.offsetWidth||0),typeof ResizeObserver<"u")){const u=new ResizeObserver(d=>{d[0]&&ae(d[0].contentRect.width)});return u.observe(t),()=>u.disconnect()}},[ee.current]);const Le=e.useCallback(()=>{document.body.style.userSelect="none"},[]),We=e.useCallback(()=>{document.body.style.userSelect=""},[]),ne=e.useCallback((t,u,d)=>{if(u.target.classList.contains("wx-line")||(d||(d=a.getTask(Ge(t))),d.type==="milestone"||d.type==="summary"))return"";const m=Ce.locate(u,"data-segment");m&&(t=m);const{left:$,width:E}=t.getBoundingClientRect(),C=(u.clientX-$)/E;let j=.2/(E>200?E/200:1);return C<j?"start":C>1-j?"end":""},[a]),fe=e.useMemo(()=>{const t=new Set;if(p||!i||!o)return t;const u=new Map;return h.forEach(d=>{if(d.type==="summary"||d.type==="milestone")return;const m=o.taskRows.get(d.id)??d.id;u.has(m)||u.set(m,[]),u.get(m).push(d)}),u.forEach(d=>{if(!(d.length<2))for(let m=0;m<d.length;m++)for(let $=m+1;$<d.length;$++){const E=d[m],C=d[$],j=E.$x,re=E.$x+E.$w,ie=C.$x,pe=C.$x+C.$w;qt(j,re,ie,pe)&&(t.add(E.id),t.add(C.id))}}),t},[p,i,o,h,F]),be=e.useMemo(()=>{const t=new Map;if(!i||!o)return h.forEach(m=>{t.set(m.id,m.$y)}),t;const u=new Map,d=[];return h.forEach(m=>{const $=o.taskRows.get(m.id)??m.id;u.has($)||(u.set($,d.length),d.push($))}),h.forEach(m=>{const $=o.taskRows.get(m.id)??m.id,E=u.get($)??0;t.set(m.id,E*J)}),t},[h,i,o,J]),Oe=e.useMemo(()=>{const t=new Map;if(!i||!o)return h.forEach(m=>{t.set(m.id,m.$y),m.row!==void 0&&t.set(m.row,m.$y)}),t;const u=new Map,d=[];return h.forEach(m=>{const $=o.taskRows.get(m.id)??m.id;u.has($)||(u.set($,d.length),d.push($))}),u.forEach((m,$)=>{t.set($,m*J)}),t},[h,i,o,J]),c=e.useCallback(t=>{if(!ee.current)return[];const d=Math.min(t.startX,t.currentX),m=Math.max(t.startX,t.currentX),$=Math.min(t.startY,t.currentY),E=Math.max(t.startY,t.currentY);return h.filter(C=>{const j=C.$x,re=C.$x+C.$w,pe=be.get(C.id)??C.$y,Ie=pe+C.$h;return j<m&&re>d&&pe<E&&Ie>$})},[h,be]),w=e.useMemo(()=>new Set(W.map(t=>t.id)),[W,L]),R=e.useCallback(t=>w.has(t),[w]),A=e.useCallback((t,u)=>{const{clientX:d}=u,m=Ge(t),$=a.getTask(m),E=u.target.classList;if(!u.target.closest(".wx-delete-button")&&!n){if(E.contains("wx-progress-marker")){const{progress:C}=a.getTask(m);ke.current={id:m,x:d,progress:C,dx:0,node:t,marker:u.target},u.target.classList.add("wx-progress-in-drag")}else{const C=ne(t,u,$)||"move",j={id:m,mode:C,x:d,dx:0,l:$.$x,w:$.$w};if(oe&&$.segments?.length){const re=Ce.locate(u,"data-segment");re&&(j.segmentIndex=re.dataset.segment*1,he.extendDragOptions($,j))}we(j)}Le()}},[a,n,ne,Le,oe]),ge=e.useCallback(t=>{if(t.button!==0||y)return;const u=Ce.locate(t);if(!u&&N&&!n){const d=ee.current;if(!d)return;const m=d.getBoundingClientRect(),$=t.clientX-m.left,E=t.clientY-m.top;if(v){const j=gt($,P);j&&(x.current=j,Se(j))}const C={startX:$,startY:E,currentX:$,currentY:E,ctrlKey:t.ctrlKey||t.metaKey};_(C),z.current=C,Le();return}if(u){if(N&&!n&&W.length>1){const d=Ge(u);if(R(d)){const m=t.target.classList;if(!m.contains("wx-link")&&!m.contains("wx-progress-marker")&&!t.target.closest(".wx-delete-button")){const $=a.getTask(d);if(!ne(u,t,$)){const C=new Map;W.forEach(j=>{const re=a.getTask(j.id);if(re){if(ce?.auto&&re.type==="summary")return;C.set(j.id,{$x:re.$x,$w:re.$w,start:re.start,end:re.end})}}),K({baseTaskId:d,startX:t.clientX,dx:0,originalPositions:C}),Le();return}}}}A(u,t)}},[A,N,v,n,W,R,a,ne,ce,Le,P,y]),me=e.useCallback(t=>{const u=Ce.locate(t);u&&(je.current=setTimeout(()=>{Te(!0),A(u,t.touches[0])},300))},[A]),Re=e.useCallback(t=>{$e(t&&{...H.find(u=>u.id===t)})},[H]),Ne=e.useCallback(()=>{const t=z.current;if(t){const u=c(t);t.ctrlKey?u.forEach(d=>{a.exec("select-task",{id:d.id,toggle:!0,marquee:!0})}):(W.length>0&&a.exec("select-task",{id:null,marquee:!0}),u.forEach((d,m)=>{a.exec("select-task",{id:d.id,toggle:m>0,marquee:!0})})),_(null),z.current=null,We(),le.current=!0;return}if(Y){const{dx:u,originalPositions:d}=Y,m=Math.round(u/k);if(m!==0){let $=!0;d.forEach((E,C)=>{const j=a.getTask(C);j&&(a.exec("update-task",{id:C,diff:m,task:{start:j.start,end:j.end},skipUndo:!$}),$=!1)}),le.current=!0}else d.forEach(($,E)=>{a.exec("drag-task",{id:E,left:$.$x,width:$.$w,inProgress:!1})});K(null),We();return}if(ke.current){const{dx:u,id:d,marker:m,value:$}=ke.current;ke.current=null,typeof $<"u"&&u&&a.exec("update-task",{id:d,task:{progress:$},inProgress:!1}),m.classList.remove("wx-progress-in-drag"),le.current=!0,We()}else if(se){const{id:u,mode:d,dx:m,l:$,w:E,start:C,segment:j,index:re}=se;if(we(null),C){const ie=Math.round(m/k);if(!ie)a.exec("drag-task",{id:u,width:E,left:$,inProgress:!1,...j&&{segmentIndex:re}});else{let pe={},Ie=a.getTask(u);j&&(Ie=Ie.segments[re]);const ze=1440*60*1e3,Pe=ie*(S==="week"?7:S==="month"?30:S==="quarter"?91:S==="year"?365:1)*ze;d==="move"?(pe.start=new Date(Ie.start.getTime()+Pe),pe.end=new Date(Ie.end.getTime()+Pe)):d==="start"?(pe.start=new Date(Ie.start.getTime()+Pe),pe.end=Ie.end):d==="end"&&(pe.start=Ie.start,pe.end=new Date(Ie.end.getTime()+Pe)),a.exec("update-task",{id:u,task:pe,...j&&{segmentIndex:re}})}le.current=!0}We()}},[a,We,se,k,S,g,Y,c,W]),Xe=e.useCallback((t,u)=>{const{clientX:d,clientY:m}=u,$=ee.current;if($){const E=$.getBoundingClientRect();q.current=d-E.left}if(y){if(!$)return;const E=$.getBoundingClientRect(),C=d-E.left;B(j=>({...j,currentX:C}));return}if(!n){if(g){const E=ee.current;if(!E)return;const C=E.getBoundingClientRect(),j=d-C.left,re=m-C.top;_(ie=>({...ie,currentX:j,currentY:re})),z.current&&(z.current.currentX=j,z.current.currentY=re);return}if(Y){const E=d-Y.startX;Y.originalPositions.forEach((C,j)=>{const re=C.$x+E;a.exec("drag-task",{id:j,left:re,width:C.$w,inProgress:!0})}),K(C=>({...C,dx:E}));return}if(ke.current){const{node:E,x:C,id:j}=ke.current,re=ke.current.dx=d-C,ie=Math.round(re/E.offsetWidth*100);let pe=ke.current.progress+ie;ke.current.value=pe=Math.min(Math.max(0,pe),100),a.exec("update-task",{id:j,task:{progress:pe},inProgress:!0})}else if(se){Re(null);const{mode:E,l:C,w:j,x:re,id:ie,start:pe,segment:Ie,index:ze}=se,He=a.getTask(ie),Pe=d-re;if(!pe&&Math.abs(Pe)<20||E==="start"&&j-Pe<k||E==="end"&&j+Pe<k||E==="move"&&(Pe<0&&C+Pe<0||Pe>0&&C+j+Pe>De)||se.segment&&!he.isSegmentMoveAllowed(He,se))return;const Be={...se,dx:Pe};let Ue,qe;if(E==="start"?(Ue=C+Pe,qe=j-Pe):E==="end"?(Ue=C,qe=j+Pe):E==="move"&&(Ue=C+Pe,qe=j),a.exec("drag-task",{id:ie,width:qe,left:Ue,inProgress:!0,...Ie&&{segmentIndex:ze}}),!Be.start&&(E==="move"&&He.$x==C||E!=="move"&&He.$w==j)){le.current=!0,Ne();return}Be.start=!0,we(Be)}else{const E=Ce.locate(t);if(E){const C=a.getTask(Ge(E)),re=Ce.locate(t,"data-segment")||E,ie=ne(re,u,C);re.style.cursor=ie&&!n?"col-resize":"pointer"}}}},[a,n,se,k,De,ne,Re,Ne,g,Y,y]),kt=e.useCallback(t=>{Xe(t,t)},[Xe]),Ct=e.useCallback(t=>{Ee?(t.preventDefault(),Xe(t,t.touches[0])):je.current&&(clearTimeout(je.current),je.current=null)},[Ee,Xe]),Qe=e.useCallback(()=>{Ne()},[Ne]),Tt=e.useCallback(()=>{Te(null),je.current&&(clearTimeout(je.current),je.current=null),Ne()},[Ne]);e.useEffect(()=>(window.addEventListener("mouseup",Qe),()=>{window.removeEventListener("mouseup",Qe)}),[Qe]);const St=e.useCallback(t=>{if(!n){const u=Ce.locateID(t.target);if(u&&!t.target.classList.contains("wx-link")){const d=Ce.locateID(t.target,"data-segment");a.exec("show-editor",{id:u,...d!==null&&{segmentIndex:d}})}}},[a,n]),vt=["e2s","s2s","e2e","s2e"],Fe=e.useCallback((t,u)=>vt[(t?1:0)+(u?0:2)],[]),Ke=e.useCallback((t,u)=>{const d=I.id,m=I.start;return t===d?!0:!!H.find($=>$.target==t&&$.source==d&&$.type===Fe(m,u))},[I,G,Fe]),tt=e.useCallback(()=>{I&&ue(null)},[I]),st=e.useCallback((t,u,d)=>{if(!u.length||!t||d==null)return;console.log("[paste] executePaste called:",{targetDate:t.toISOString(),taskCount:u.length,parent:d});const m=864e5,$=a.getHistory();$?.startBatch();const E=new Date(t);E.setUTCHours(0,0,0,0),console.log("[paste] scalesValue:",{start:P?.start?.toISOString?.(),lengthUnit:P?.lengthUnit,lengthUnitWidth:P?.lengthUnitWidth}),u.forEach((C,j)=>{const re=`task-${Date.now()}-${j}`;console.log("[paste] task input:",{text:C.text,_startCellOffset:C._startCellOffset,_startDayOfWeek:C._startDayOfWeek,_durationDays:C._durationDays,start:C.start?.toISOString?.(),end:C.end?.toISOString?.()});const ie=Ut(E,C._startCellOffset||0,P);console.log("[paste] cellOffset:",ie?.toISOString?.());const pe=new Date(ie.getTime()+(C._startDayOfWeek||0)*m);pe.setUTCHours(0,0,0,0);const Ie=new Date(pe.getTime()+(C._durationDays||7)*m);Ie.setUTCHours(0,0,0,0),console.log("[paste] task calculated:",{text:C.text,newStart:pe.toISOString(),newEnd:Ie.toISOString(),row:C.row}),a.exec("add-task",{task:{id:re,text:C.text,start:pe,end:Ie,type:C.type||"task",parent:d,row:C.row},target:d,mode:"child",skipUndo:j>0})}),$?.endBatch()},[a,P]),Mt=e.useCallback(t=>{if(le.current){le.current=!1;return}if(y&&y.currentX!=null){const d=gt(y.currentX,P);d&&st(d,y.tasks,y.parent),B(null);return}const u=Ce.locateID(t.target);if(u){const d=a.getTask(u),m=h.find(E=>E.id===u);console.log("[click] task:",d?.text,"id:",u),console.log("[click] api.getTask:",{start:d?.start,end:d?.end,duration:d?.duration}),console.log("[click] rendered:",{start:m?.start,end:m?.end,$w:m?.$w,$x:m?.$x});const $=t.target.classList;if($.contains("wx-link")){const E=$.contains("wx-left");if(!I){ue({id:u,start:E});return}I.id!==u&&!Ke(u,E)&&a.exec("add-link",{link:{source:I.id,target:u,type:Fe(I.start,E)}})}else if($.contains("wx-delete-button-icon"))a.exec("delete-link",{id:ve.id}),$e(null);else{let E;const C=Ce.locate(t,"data-segment");C&&(E=C.dataset.segment*1),a.exec("select-task",{id:u,toggle:t.ctrlKey||t.metaKey,range:t.shiftKey,segmentIndex:E})}}tt()},[a,I,G,ve,Ke,Fe,tt,y,P,st]),Et=e.useCallback(t=>({left:`${t.$x}px`,top:`${t.$y}px`,width:`${t.$w}px`,height:`${t.$h}px`}),[]),Rt=e.useCallback(t=>({left:`${t.$x_base}px`,top:`${t.$y_base}px`,width:`${t.$w_base}px`,height:`${t.$h_base}px`}),[]),$t=e.useCallback(t=>{if(Ee||je.current)return t.preventDefault(),!1},[Ee]),nt=e.useMemo(()=>M.map(t=>t.id),[M]),rt=e.useCallback(t=>{let u=nt.includes(t)?t:"task";return["task","milestone","summary"].includes(t)||(u=`task ${u}`),u},[nt]),ot=e.useCallback(t=>{a.exec(t.action,t.data)},[a]),Ze=e.useCallback(t=>T&&Z.byId(t).$critical,[T,Z]),lt=e.useCallback(t=>{if(ce?.auto){const u=Z.getSummaryId(t,!0),d=Z.getSummaryId(I.id,!0);return I?.id&&!(Array.isArray(u)?u:[u]).includes(I.id)&&!(Array.isArray(d)?d:[d]).includes(t)}return I},[ce,Z,I]),ct=e.useCallback(()=>{const t=a.getState()._selected;if(!t||!t.length)return;const u=864e5,d=t.map(j=>{const re=a.getTask(j.id);if(!re)return null;const ie=h.find(Dt=>Dt.id===j.id);if(!ie)return null;const{$x:pe,$y:Ie,$h:ze,$w:He,$skip:Pe,$level:Be,$index:Ue,$y_base:qe,$x_base:ws,$w_base:ps,$h_base:ys,$skip_baseline:bs,$critical:ks,$reorder:Cs,...jt}=ie,at=ie.end&&ie.start?Math.round((ie.end.getTime()-ie.start.getTime())/u):0,ut=ie.start?(ie.start.getUTCDay()+6)%7:0;return console.log("[copy] task:",{id:re.id,text:re.text,start:ie.start?.toISOString?.(),end:ie.end?.toISOString?.(),durationDays:at,startDayOfWeek:ut,$w:He,$h:ze,row:ie.row,parent:ie.parent}),{...jt,_durationDays:at,_startDayOfWeek:ut,_originalWidth:He,_originalHeight:ze}}).filter(Boolean);if(!d.length)return;const $=d[0].parent,E=d.filter(j=>j.parent===$);if(E.length===0)return;const C=E.reduce((j,re)=>re.start&&(!j||re.start<j)?re.start:j,null);Ye=E.map(j=>({...j,_startCellOffset:zt(j.start,C,P)})),ht=$,Je=C,console.log("[copy] clipboard stored:",{taskCount:Ye.length,baseDate:C?.toISOString?.(),parent:$,tasks:Ye.map(j=>({id:j.id,text:j.text,_startCellOffset:j._startCellOffset,_startDayOfWeek:j._startDayOfWeek,_durationDays:j._durationDays}))})},[a,P]);e.useEffect(()=>v?a.intercept("hotkey",u=>{if(u.key==="ctrl+c"||u.key==="meta+c")return ct(),!1;if(u.key==="ctrl+v"||u.key==="meta+v")return!Ye.length||!Je||B({tasks:Ye,baseDate:Je,parent:ht,currentX:q.current}),!1}):void 0,[v,a,ct]),e.useEffect(()=>{if(!y)return;const t=u=>{u.key==="Escape"&&(u.preventDefault(),u.stopPropagation(),B(null))};return document.addEventListener("keydown",t,!0),()=>document.removeEventListener("keydown",t,!0)},[y]);const it=e.useMemo(()=>{if(!g)return null;const t=Math.min(g.startX,g.currentX),u=Math.min(g.startY,g.currentY),d=Math.abs(g.currentX-g.startX),m=Math.abs(g.currentY-g.startY);return{left:`${t}px`,top:`${u}px`,width:`${d}px`,height:`${m}px`}},[g]);return l.jsxs("div",{className:"wx-GKbcLEGA wx-bars",style:{lineHeight:`${de.length?de[0].$h:0}px`},ref:ee,onContextMenu:$t,onMouseDown:ge,onMouseMove:kt,onTouchStart:me,onTouchMove:Ct,onTouchEnd:Tt,onClick:Mt,onDoubleClick:St,onDragStart:t=>(t.preventDefault(),!1),children:[l.jsx(Ht,{onSelectLink:Re,selectedLink:ve,readonly:n}),de.map(t=>{if(t.$skip&&t.$skip_baseline)return null;const u=fe.has(t.id),d=`wx-bar wx-${rt(t.type)}`+(t.$css?` ${t.$css}`:"")+(Ee&&se&&t.id===se.id?" wx-touch":"")+(I&&I.id===t.id?" wx-selected":"")+(w.has(t.id)?" wx-selected":"")+(Ze(t.id)?" wx-critical":"")+(t.$reorder?" wx-reorder-task":"")+(oe&&t.segments?" wx-split":"")+(u?" wx-collision":""),m="wx-link wx-left"+(I?" wx-visible":"")+(!I||!Ke(t.id,!0)&&lt(t.id)?" wx-target":"")+(I&&I.id===t.id&&I.start?" wx-selected":"")+(Ze(t.id)?" wx-critical":""),$="wx-link wx-right"+(I?" wx-visible":"")+(!I||!Ke(t.id,!1)&&lt(t.id)?" wx-target":"")+(I&&I.id===t.id&&!I.start?" wx-selected":"")+(Ze(t.id)?" wx-critical":"");return l.jsxs(e.Fragment,{children:[!t.$skip&&l.jsxs("div",{className:"wx-GKbcLEGA "+d,style:Et(t),"data-tooltip-id":t.id,"data-id":t.id,tabIndex:Me===t.id?0:-1,children:[n?null:t.id===ve?.target&&ve?.type[2]==="s"?l.jsx(ye.Button,{type:"danger",css:"wx-left wx-delete-button wx-delete-link",children:l.jsx("i",{className:"wxi-close wx-delete-button-icon"})}):l.jsx("div",{className:"wx-GKbcLEGA "+m,children:l.jsx("div",{className:"wx-GKbcLEGA wx-inner"})}),t.type!=="milestone"?l.jsxs(l.Fragment,{children:[t.progress&&!(oe&&t.segments)?l.jsx("div",{className:"wx-GKbcLEGA wx-progress-wrapper",children:l.jsx("div",{className:"wx-GKbcLEGA wx-progress-percent",style:{width:`${t.progress}%`}})}):null,!n&&!(oe&&t.segments)?l.jsx("div",{className:"wx-GKbcLEGA wx-progress-marker",style:{left:`calc(${t.progress}% - 10px)`},children:t.progress}):null,r?l.jsx(r,{data:t,api:a,onAction:ot}):oe&&t.segments?l.jsx(Gt,{task:t,type:rt(t.type)}):l.jsx("div",{className:"wx-GKbcLEGA wx-content",children:b&&t.type==="summary"?"":t.$barText||t.text||""}),u&&l.jsx("div",{className:"wx-GKbcLEGA wx-collision-warning",title:"This task overlaps with another task in the same row",children:"!"}),V&&t.type==="summary"&&(()=>{const E=V.get(t.id),C=Math.floor(t.$x/k),j=Math.ceil((t.$x+t.$w)/k);return l.jsx("div",{className:"wx-GKbcLEGA wx-summary-week-counts",children:Array.from({length:j-C},(re,ie)=>{const pe=C+ie,Ie=E?.get(pe)||0;return l.jsx("span",{className:`wx-GKbcLEGA wx-week-count${Ie===0?" wx-week-count-zero":""}`,style:{position:"absolute",left:`${pe*k-t.$x}px`,width:`${k}px`,top:0,height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:Ie},pe)})})})()]}):l.jsxs(l.Fragment,{children:[l.jsx("div",{className:"wx-GKbcLEGA wx-content"}),r?l.jsx(r,{data:t,api:a,onAction:ot}):l.jsx("div",{className:"wx-GKbcLEGA wx-text-out",children:t.$barText||t.text})]}),n?null:t.id===ve?.target&&ve?.type[2]==="e"?l.jsx(ye.Button,{type:"danger",css:"wx-right wx-delete-button wx-delete-link",children:l.jsx("i",{className:"wxi-close wx-delete-button-icon"})}):l.jsx("div",{className:"wx-GKbcLEGA "+$,children:l.jsx("div",{className:"wx-GKbcLEGA wx-inner"})})]}),X&&!t.$skip_baseline?l.jsx("div",{className:"wx-GKbcLEGA wx-baseline"+(t.type==="milestone"?" wx-milestone":""),style:Rt(t)}):null]},t.id)}),g&&it&&l.jsx("div",{className:"wx-GKbcLEGA wx-marquee-selection",style:it}),y&&y.currentX!=null&&y.tasks.map((t,u)=>{const m=(Math.floor(y.currentX/k)+(t._startCellOffset||0))*k,$=t._originalWidth||k,E=t._originalHeight||J,C=Oe.get(t.row)??(t.$y||0);return l.jsx("div",{className:"wx-GKbcLEGA wx-bar wx-task wx-paste-preview",style:{left:m,top:C,width:$,height:E},children:l.jsx("div",{className:"wx-GKbcLEGA wx-content",children:t.$barText||t.text})},`preview-${u}`)})]})}function Xt(s){const{highlightTime:n,onScaleClick:r}=s,i=e.useContext(Ae),o=D.useStore(i,"_scales");return l.jsx("div",{className:"wx-ZkvhDKir wx-scale",style:{width:o.width},children:(o?.rows||[]).map((N,v)=>l.jsx("div",{className:"wx-ZkvhDKir wx-row",style:{height:`${N.height}px`},children:(N.cells||[]).map((p,b)=>{const a=n?n(p.date,p.unit):"",h="wx-cell "+(p.css||"")+" "+(a||""),F=typeof p.value=="string"&&p.value.includes("<");return l.jsx("div",{className:"wx-ZkvhDKir "+h,style:{width:`${p.width}px`,cursor:r?"pointer":void 0},onClick:r?H=>r(p.date,p.unit,H.nativeEvent):void 0,...F?{dangerouslySetInnerHTML:{__html:p.value}}:{children:p.value}},b)})},v))})}const Ft=new Map;function Kt(s){const n=e.useRef(null),r=e.useRef(0),i=e.useRef(null),o=typeof window<"u"&&window.__RENDER_METRICS_ENABLED__;n.current===null&&(n.current=performance.now()),r.current++,e.useEffect(()=>{if(o)return cancelAnimationFrame(i.current),i.current=requestAnimationFrame(()=>{const N={label:s,time:performance.now()-n.current,renders:r.current,timestamp:Date.now()};Ft.set(s,N),window.dispatchEvent(new CustomEvent("render-metric",{detail:N}))}),()=>cancelAnimationFrame(i.current)})}function Bt(s){const{readonly:n,fullWidth:r,fullHeight:i,taskTemplate:o,cellBorders:N,highlightTime:v,onScaleClick:p,multiTaskRows:b=!1,rowMapping:a=null,marqueeSelect:h=!1,copyPaste:F=!1,scrollToCurrentWeek:H=!1,currentWeekColor:G=null,allowTaskIntersection:Q=!0,summaryBarCounts:f=!1}=s,M=e.useContext(Ae),[P,X]=D.useStoreWithCounter(M,"_selected"),W=D.useStore(M,"scrollTop"),L=D.useStore(M,"cellHeight"),O=D.useStore(M,"cellWidth"),T=D.useStore(M,"_scales"),Z=D.useStore(M,"_markers"),ce=D.useStore(M,"_scrollTask"),oe=D.useStore(M,"zoom"),te=D.useStore(M,"_tasks"),[J,de]=e.useState(),k=e.useRef(null),S=e.useRef(0),V=e.useRef(!1),le=1+(T?.rows?.length||0),I=e.useMemo(()=>{if(!b||!a||!te?.length)return null;const g=new Map,_=new Map,z=[];return te.forEach(Y=>{const K=a.taskRows.get(Y.id)??Y.id;_.has(K)||(_.set(K,z.length),z.push(K))}),te.forEach(Y=>{const K=a.taskRows.get(Y.id)??Y.id,xe=_.get(K)??0;g.set(Y.id,xe*L)}),g},[te,b,a,L]),ue=e.useMemo(()=>{const g=[];return P&&P.length&&L&&P.forEach(_=>{const z=I?.get(_.id)??_.$y;g.push({height:`${L}px`,top:`${z-3}px`})}),g},[X,L,I]),se=e.useMemo(()=>Math.max(J||0,i),[J,i]);e.useEffect(()=>{const g=k.current;g&&typeof W=="number"&&(g.scrollTop=W)},[W]);const we=()=>{ke()};function ke(g){const _=k.current;if(!_)return;const z={};z.left=_.scrollLeft,M.exec("scroll-chart",z)}function ve(){const g=k.current,z=Math.ceil((J||0)/(L||1))+1,Y=Math.floor((g&&g.scrollTop||0)/(L||1)),K=Math.max(0,Y-le),xe=Y+z+le,Se=K*(L||0);M.exec("render-data",{start:K,end:xe,from:Se})}e.useEffect(()=>{ve()},[J,W]);const $e=e.useCallback(g=>{if(!g)return;const{id:_,mode:z}=g;if(z.toString().indexOf("x")<0)return;const Y=k.current;if(!Y)return;const{clientWidth:K}=Y,xe=M.getTask(_);if(xe.$x+xe.$w<Y.scrollLeft)M.exec("scroll-chart",{left:xe.$x-(O||0)}),Y.scrollLeft=xe.$x-(O||0);else if(xe.$x>=K+Y.scrollLeft){const Se=K<xe.$w?O||0:xe.$w;M.exec("scroll-chart",{left:xe.$x-K+Se}),Y.scrollLeft=xe.$x-K+Se}},[M,O]);e.useEffect(()=>{$e(ce)},[ce]);function Ee(g){if(oe&&(g.ctrlKey||g.metaKey)){g.preventDefault();const _=k.current,z=g.clientX-(_?_.getBoundingClientRect().left:0);if(S.current+=g.deltaY,Math.abs(S.current)>=150){const K=-Math.sign(S.current);S.current=0,M.exec("zoom-scale",{dir:K,offset:z})}}}const Te=e.useCallback(g=>{const _=v(g.date,g.unit);return _?{css:_,width:g.width}:null},[v]),je=e.useMemo(()=>{if(!T||!v||!["hour","day","week"].includes(T.minUnit))return null;let _=0;return T.rows[T.rows.length-1].cells.map(z=>{const Y=Te(z),K=_;return _+=z.width,Y?{...Y,left:K}:null})},[T,v,Te]),De=e.useCallback(g=>{g.eventSource="chart",M.exec("hotkey",g)},[M]);e.useEffect(()=>{const g=k.current;if(!g)return;const _=()=>de(g.clientHeight);_();const z=new ResizeObserver(()=>_());return z.observe(g),()=>{z.disconnect()}},[k.current]);const ae=e.useRef(null);return e.useEffect(()=>{const g=k.current;if(g&&!ae.current)return ae.current=wt.hotkeys(g,{keys:{arrowup:!0,arrowdown:!0},exec:_=>De(_)}),()=>{ae.current?.destroy(),ae.current=null}},[]),e.useEffect(()=>{const g=k.current;if(!g)return;const _=Ee;return g.addEventListener("wheel",_),()=>{g.removeEventListener("wheel",_)}},[Ee]),e.useEffect(()=>{if(!H||V.current||!T||!k.current||!J)return;const g=k.current,{clientWidth:_}=g,z=new Date,Y=T.rows[T.rows.length-1]?.cells;if(!Y)return;let K=-1,xe=0;const Se=[];for(let B=0;B<Y.length;B++){const x=Y[B];Se.push({left:xe,width:x.width});const q=x.date;if(x.unit==="week"){const ee=new Date(q);ee.setUTCDate(ee.getUTCDate()+7),z>=q&&z<ee&&(K=B)}else x.unit==="day"&&z.getUTCFullYear()===q.getUTCFullYear()&&z.getUTCMonth()===q.getUTCMonth()&&z.getUTCDate()===q.getUTCDate()&&(K=B);xe+=x.width}let y=K;if(K>0&&(y=K-1),y>=0&&Se[y]){const B=Se[y],x=Math.max(0,B.left);g.scrollLeft=x,M.exec("scroll-chart",{left:x}),V.current=!0}},[H,T,J,M]),Kt("chart"),l.jsxs("div",{className:"wx-mR7v2Xag wx-chart",tabIndex:-1,ref:k,onScroll:we,children:[l.jsx(Xt,{highlightTime:v,onScaleClick:p,scales:T}),Z&&Z.length?l.jsx("div",{className:"wx-mR7v2Xag wx-markers",style:{height:`${se}px`},children:Z.map((g,_)=>l.jsx("div",{className:`wx-mR7v2Xag wx-marker ${g.css||""}`,style:{left:`${g.left}px`},children:l.jsx("div",{className:"wx-mR7v2Xag wx-content",children:g.text})},_))}):null,l.jsxs("div",{className:"wx-mR7v2Xag wx-area",style:{width:`${r}px`,height:`${se}px`},children:[je?l.jsx("div",{className:"wx-mR7v2Xag wx-gantt-holidays",style:{height:"100%"},children:je.map((g,_)=>g?l.jsx("div",{className:"wx-mR7v2Xag "+g.css,style:{width:`${g.width}px`,left:`${g.left}px`}},_):null)}):null,l.jsx(At,{borders:N}),P&&P.length?P.map((g,_)=>g.$y?l.jsx("div",{className:"wx-mR7v2Xag wx-selected","data-id":g.id,style:ue[_]},g.id):null):null,l.jsx(Yt,{readonly:n,taskTemplate:o,multiTaskRows:b,rowMapping:a,marqueeSelect:h,copyPaste:F,allowTaskIntersection:Q,summaryBarCounts:f})]})]})}function Vt(s){const{position:n="after",size:r=4,dir:i="x",onMove:o,onDisplayChange:N,compactMode:v,containerWidth:p=0,leftThreshold:b=50,rightThreshold:a=50}=s,[h,F]=D.useWritableProp(s.value??0),[H,G]=D.useWritableProp(s.display??"all");function Q(ue){let se=0;n=="center"?se=r/2:n=="before"&&(se=r);const we={size:[r+"px","auto"],p:[ue-se+"px","0px"],p2:["auto","0px"]};if(i!="x")for(let ke in we)we[ke]=we[ke].reverse();return we}const[f,M]=e.useState(!1),[P,X]=e.useState(null),W=e.useRef(0),L=e.useRef(),O=e.useRef(),T=e.useRef(H);e.useEffect(()=>{T.current=H},[H]),e.useEffect(()=>{P===null&&h>0&&X(h)},[P,h]);function Z(ue){return i=="x"?ue.clientX:ue.clientY}const ce=e.useCallback(ue=>{const se=L.current+Z(ue)-W.current;F(se);let we;se<=b?we="chart":p-se<=a?we="grid":we="all",T.current!==we&&(G(we),T.current=we),O.current&&clearTimeout(O.current),O.current=setTimeout(()=>o&&o(se),100)},[p,b,a,o]),oe=e.useCallback(()=>{document.body.style.cursor="",document.body.style.userSelect="",M(!1),window.removeEventListener("mousemove",ce),window.removeEventListener("mouseup",oe)},[ce]),te=e.useMemo(()=>H!=="all"?"auto":i=="x"?"ew-resize":"ns-resize",[H,i]),J=e.useCallback(ue=>{!v&&(H==="grid"||H==="chart")||(W.current=Z(ue),L.current=h,M(!0),document.body.style.cursor=te,document.body.style.userSelect="none",window.addEventListener("mousemove",ce),window.addEventListener("mouseup",oe))},[te,ce,oe,h,v,H]);function de(){G("all"),P!==null&&(F(P),o&&o(P))}function k(ue){if(v){const se=H==="chart"?"grid":"chart";G(se),N(se)}else if(H==="grid"||H==="chart")de(),N("all");else{const se=ue==="left"?"chart":"grid";G(se),N(se)}}function S(){k("left")}function V(){k("right")}const le=e.useMemo(()=>Q(h),[h,n,r,i]),I=["wx-resizer",`wx-resizer-${i}`,`wx-resizer-display-${H}`,f?"wx-resizer-active":""].filter(Boolean).join(" ");return l.jsxs("div",{className:"wx-pFykzMlT "+I,onMouseDown:J,style:{width:le.size[0],height:le.size[1],cursor:te},children:[l.jsxs("div",{className:"wx-pFykzMlT wx-button-expand-box",children:[l.jsx("div",{className:"wx-pFykzMlT wx-button-expand-content wx-button-expand-left",children:l.jsx("i",{className:"wx-pFykzMlT wxi-menu-left",onClick:S})}),l.jsx("div",{className:"wx-pFykzMlT wx-button-expand-content wx-button-expand-right",children:l.jsx("i",{className:"wx-pFykzMlT wxi-menu-right",onClick:V})})]}),l.jsx("div",{className:"wx-pFykzMlT wx-resizer-line"})]})}const Qt=650;function yt(s){let n;function r(){n=new ResizeObserver(o=>{for(let N of o)if(N.target===document.body){let v=N.contentRect.width<=Qt;s(v)}}),n.observe(document.body)}function i(){n&&(n.disconnect(),n=null)}return{observe:r,disconnect:i}}function Zt(s){const{taskTemplate:n,readonly:r,cellBorders:i,highlightTime:o,onScaleClick:N,onTableAPIChange:v,multiTaskRows:p=!1,rowMapping:b=null,marqueeSelect:a=!1,copyPaste:h=!1,scrollToCurrentWeek:F=!1,currentWeekColor:H=null,allowTaskIntersection:G=!0,summaryBarCounts:Q=!1}=s,f=e.useContext(Ae),M=D.useStore(f,"_tasks"),P=D.useStore(f,"_scales"),X=D.useStore(f,"cellHeight"),W=D.useStore(f,"columns"),L=D.useStore(f,"_scrollTask"),O=D.useStore(f,"undo"),T=e.useMemo(()=>{if(!p)return b;const y=new Map,B=new Map;return M.forEach(x=>{const q=x.row??x.id;B.set(x.id,q),y.has(q)||y.set(q,[]),y.get(q).push(x.id)}),{rowMap:y,taskRows:B}},[M,p,b]),[Z,ce]=e.useState(!1);let[oe,te]=e.useState(0);const[J,de]=e.useState(0),[k,S]=e.useState(0),[V,le]=e.useState(void 0),[I,ue]=e.useState("all"),se=e.useRef(null),we=e.useCallback(y=>{ce(B=>(y!==B&&(y?(se.current=I,I==="all"&&ue("grid")):(!se.current||se.current==="all")&&ue("all")),y))},[I]);e.useEffect(()=>{const y=yt(we);return y.observe(),()=>{y.disconnect()}},[we]);const ke=e.useMemo(()=>{let y;return W.every(B=>B.width&&!B.flexgrow)?y=W.reduce((B,x)=>B+parseInt(x.width),0):Z&&I==="chart"?y=parseInt(W.find(B=>B.id==="action")?.width)||50:y=440,oe=y,y},[W,Z,I]);e.useEffect(()=>{te(ke)},[ke]);const ve=e.useMemo(()=>(J??0)-(V??0),[J,V]),$e=e.useMemo(()=>P.width,[P]),Ee=e.useMemo(()=>{if(!p||!T)return M.length*X;const y=new Set;return M.forEach(B=>{const x=T.taskRows.get(B.id)??B.id;y.add(x)}),y.size*X},[M,X,p,T]),Te=e.useMemo(()=>P.height+Ee+ve,[P,Ee,ve]),je=e.useMemo(()=>oe+$e,[oe,$e]),De=e.useRef(null),ae=e.useCallback(()=>{Promise.resolve().then(()=>{if((J??0)>(je??0)){const y=(J??0)-oe;f.exec("expand-scale",{minWidth:y})}})},[J,je,oe,f]);e.useEffect(()=>{let y;return De.current&&(y=new ResizeObserver(ae),y.observe(De.current)),()=>{y&&y.disconnect()}},[De.current,ae]),e.useEffect(()=>{ae()},[$e]);const g=e.useRef(null),_=e.useRef(null),z=e.useCallback(()=>{const y=g.current;y&&f.exec("scroll-chart",{top:y.scrollTop})},[f]),Y=e.useRef({rTasks:[],rScales:{height:0},rCellHeight:0,scrollSize:0,ganttDiv:null,ganttHeight:0});e.useEffect(()=>{Y.current={rTasks:M,rScales:P,rCellHeight:X,scrollSize:ve,ganttDiv:g.current,ganttHeight:k??0}},[M,P,X,ve,k]);const K=e.useCallback(y=>{if(!y)return;const{rTasks:B,rScales:x,rCellHeight:q,scrollSize:ee,ganttDiv:U,ganttHeight:Me}=Y.current;if(!U)return;const{id:Le}=y,We=B.findIndex(ne=>ne.id===Le);if(We>-1){const ne=Me-x.height,fe=We*q,be=U.scrollTop;let Oe=null;fe<be?Oe=fe:fe+q>be+ne&&(Oe=fe-ne+q+ee),Oe!==null&&(f.exec("scroll-chart",{top:Math.max(Oe,0)}),g.current.scrollTop=Math.max(Oe,0))}},[f]);e.useEffect(()=>{K(L)},[L]),e.useEffect(()=>{const y=g.current,B=_.current;if(!y||!B)return;const x=()=>{Lt.flushSync(()=>{S(y.offsetHeight),de(y.offsetWidth),le(B.offsetWidth)})},q=new ResizeObserver(x);return q.observe(y),()=>q.disconnect()},[g.current]);const xe=e.useRef(null),Se=e.useRef(null);return e.useEffect(()=>{Se.current&&(Se.current.destroy(),Se.current=null);const y=xe.current;if(y)return Se.current=wt.hotkeys(y,{keys:{"ctrl+c":!0,"ctrl+v":!0,"ctrl+x":!0,"ctrl+d":!0,"meta+c":!0,"meta+v":!0,"meta+x":!0,"meta+d":!0,backspace:!0,"ctrl+z":O,"ctrl+y":O,"meta+z":O,"meta+shift+z":O},exec:B=>{if(B.isInput)return;const x=B.key;if(x==="ctrl+z"||x==="meta+z"){f.exec("undo",{});return}if(x==="ctrl+y"||x==="meta+shift+z"){f.exec("redo",{});return}f.exec("hotkey",B)}}),()=>{Se.current?.destroy(),Se.current=null}},[O]),l.jsx("div",{className:"wx-jlbQoHOz wx-gantt",ref:g,onScroll:z,children:l.jsx("div",{className:"wx-jlbQoHOz wx-pseudo-rows",style:{height:Te,width:"100%"},ref:_,children:l.jsx("div",{className:"wx-jlbQoHOz wx-stuck",style:{height:k,width:V},children:l.jsxs("div",{tabIndex:0,className:"wx-jlbQoHOz wx-layout",ref:xe,children:[W.length?l.jsxs(l.Fragment,{children:[l.jsx(_t,{display:I,compactMode:Z,columnWidth:ke,width:oe,readonly:r,fullHeight:Ee,onTableAPIChange:v,multiTaskRows:p,rowMapping:T}),l.jsx(Vt,{value:oe,display:I,compactMode:Z,containerWidth:J,onMove:y=>te(y),onDisplayChange:y=>ue(y)})]}):null,l.jsx("div",{className:"wx-jlbQoHOz wx-content",ref:De,children:l.jsx(Bt,{readonly:r,fullWidth:$e,fullHeight:Ee,taskTemplate:n,cellBorders:i,highlightTime:o,onScaleClick:N,multiTaskRows:p,rowMapping:T,marqueeSelect:a,copyPaste:h,scrollToCurrentWeek:F,currentWeekColor:H,allowTaskIntersection:G,summaryBarCounts:Q})})]})})})})}function Jt(s){return{year:"%Y",quarter:`${s("Q")} %Q`,month:"%M",week:`${s("Week")} %w`,day:"%M %j",hour:"%H:%i"}}function es(s,n){return typeof s=="function"?s:Ce.dateToString(s,n)}function bt(s,n){return s.map(({format:r,...i})=>({...i,format:es(r,n)}))}function ts(s,n){const r=Jt(n);for(let i in r)r[i]=Ce.dateToString(r[i],s);return r}function ss(s,n){if(!s||!s.length)return s;const r=Ce.dateToString("%d-%m-%Y",n);return s.map(i=>i.template?i:i.id==="start"||i.id=="end"?{...i,_template:o=>r(o),template:o=>r(o)}:i.id==="duration"?{...i,_template:o=>o,template:o=>o}:i)}function ns(s,n){return s.levels?{...s,levels:s.levels.map(r=>({...r,scales:bt(r.scales,n)}))}:s}const rs=s=>s.split("-").map(n=>n?n.charAt(0).toUpperCase()+n.slice(1):"").join(""),os=[{unit:"month",step:1,format:"%F %Y"},{unit:"day",step:1,format:"%j"}],ls=e.forwardRef(function({taskTemplate:n=null,markers:r=[],taskTypes:i=he.defaultTaskTypes,tasks:o=[],selected:N=[],activeTask:v=null,links:p=[],scales:b=os,columns:a=he.defaultColumns,start:h=null,end:F=null,lengthUnit:H="day",durationUnit:G="day",cellWidth:Q=100,cellHeight:f=38,scaleHeight:M=36,readonly:P=!1,cellBorders:X="full",zoom:W=!1,baselines:L=!1,highlightTime:O=null,onScaleClick:T=null,init:Z=null,autoScale:ce=!0,unscheduledTasks:oe=!1,criticalPath:te=null,schedule:J={type:"forward"},projectStart:de=null,projectEnd:k=null,calendar:S=null,undo:V=!1,splitTasks:le=!1,multiTaskRows:I=!1,marqueeSelect:ue=!1,copyPaste:se=!1,currentWeekHighlight:we=!1,currentWeekColor:ke=null,scrollToCurrentWeek:ve=!1,allowTaskIntersection:$e=!0,summaryBarCounts:Ee=!1,...Te},je){const De=e.useRef();De.current=Te;const ae=e.useMemo(()=>new he.DataStore(D.writable),[]),g=e.useMemo(()=>({...et.en,...Ve.en}),[]),_=e.useContext(ye.context.i18n),z=e.useMemo(()=>_?_.extend(g,!0):Ce.locale(g),[_,g]),Y=e.useMemo(()=>z.getRaw().calendar,[z]),K=e.useMemo(()=>{let ne={zoom:ns(W,Y),scales:bt(b,Y),columns:ss(a,Y),links:he.normalizeLinks(p),cellWidth:Q};return ne.zoom&&(ne={...ne,...he.normalizeZoom(ne.zoom,ts(Y,z.getGroup("gantt")),ne.scales,Q)}),ne},[W,b,a,p,Q,Y,z]),xe=e.useRef(null);xe.current!==o&&(he.parseTaskDates(o,{durationUnit:G,splitTasks:le,calendar:S}),xe.current=o),e.useEffect(()=>{he.parseTaskDates(o,{durationUnit:G,splitTasks:le,calendar:S})},[o,G,S,le]);const Se=e.useMemo(()=>{if(!I)return null;const ne=new Map,fe=new Map,be=Oe=>{Oe.forEach(c=>{const w=c.row??c.id;fe.set(c.id,w),ne.has(w)||ne.set(w,[]),ne.get(w).push(c.id),c.data&&c.data.length>0&&be(c.data)})};return be(o),{rowMap:ne,taskRows:fe}},[o,I]),y=e.useMemo(()=>ae.in,[ae]),B=e.useRef(null);B.current===null&&(B.current=new It.EventBusRouter((ne,fe)=>{const be="on"+rs(ne);De.current&&De.current[be]&&De.current[be](fe)}),y.setNext(B.current));const[x,q]=e.useState(null),ee=e.useRef(null);ee.current=x;const U=e.useMemo(()=>({getState:ae.getState.bind(ae),getReactiveState:ae.getReactive.bind(ae),getStores:()=>({data:ae}),exec:y.exec,setNext:ne=>(B.current=B.current.setNext(ne),B.current),intercept:y.intercept.bind(y),on:y.on.bind(y),detach:y.detach.bind(y),getTask:ae.getTask.bind(ae),serialize:ae.serialize.bind(ae),getTable:ne=>ne?new Promise(fe=>setTimeout(()=>fe(ee.current),1)):ee.current,getHistory:()=>ae.getHistory()}),[ae,y]);e.useImperativeHandle(je,()=>({...U}),[U]);const Me=e.useRef(0);e.useEffect(()=>{Me.current?ae.init({tasks:o,links:K.links,start:h,columns:K.columns,end:F,lengthUnit:H,cellWidth:K.cellWidth,cellHeight:f,scaleHeight:M,scales:K.scales,taskTypes:i,zoom:K.zoom,selected:N,activeTask:v,baselines:L,autoScale:ce,unscheduledTasks:oe,markers:r,durationUnit:G,criticalPath:te,schedule:J,projectStart:de,projectEnd:k,calendar:S,undo:V,_weekStart:Y.weekStart,splitTasks:le}):Z&&Z(U),Me.current++},[U,Z,o,K,h,F,H,f,M,i,N,v,L,ce,oe,r,G,te,J,de,k,S,V,Y,le,ae]),Me.current===0&&ae.init({tasks:o,links:K.links,start:h,columns:K.columns,end:F,lengthUnit:H,cellWidth:K.cellWidth,cellHeight:f,scaleHeight:M,scales:K.scales,taskTypes:i,zoom:K.zoom,selected:N,activeTask:v,baselines:L,autoScale:ce,unscheduledTasks:oe,markers:r,durationUnit:G,criticalPath:te,schedule:J,projectStart:de,projectEnd:k,calendar:S,undo:V,_weekStart:Y.weekStart,splitTasks:le});const Le=e.useMemo(()=>{const ne=new Date,fe=Y?.weekStart??0,be=new Date(Date.UTC(ne.getUTCFullYear(),ne.getUTCMonth(),ne.getUTCDate())),c=(be.getUTCDay()-fe+7)%7;be.setUTCDate(be.getUTCDate()-c),be.setUTCHours(0,0,0,0);const w=new Date(be);return w.setUTCDate(w.getUTCDate()+7),R=>R>=be&&R<w},[Y]),We=e.useMemo(()=>(ne,fe)=>{let be=[];if(S)fe=="day"&&!S.getDayHours(ne)&&be.push("wx-weekend"),fe=="hour"&&!S.getDayHours(ne)&&be.push("wx-weekend");else if(O){const Oe=O(ne,fe);Oe&&be.push(Oe)}return we&&(fe==="week"||fe==="day")&&Le(ne)&&be.push("wx-current-week"),be.join(" ")},[S,O,we,Le]);return l.jsx(ye.context.i18n.Provider,{value:z,children:l.jsx(Ae.Provider,{value:U,children:l.jsx(Zt,{taskTemplate:n,readonly:P,cellBorders:X,highlightTime:We,onScaleClick:T,onTableAPIChange:q,multiTaskRows:I,rowMapping:Se,marqueeSelect:ue,copyPaste:se,scrollToCurrentWeek:ve,currentWeekColor:ke,allowTaskIntersection:$e,summaryBarCounts:Ee})})})});function cs({api:s=null,items:n=[]}){const r=e.useContext(ye.context.i18n),i=e.useMemo(()=>r||Ce.locale(Ve.en),[r]),o=e.useMemo(()=>i.getGroup("gantt"),[i]),N=D.useStoreLater(s,"_selected"),v=D.useStoreLater(s,"undo"),p=D.useStoreLater(s,"history"),b=D.useStoreLater(s,"splitTasks"),a=["undo","redo"],h=e.useMemo(()=>{const H=he.getToolbarButtons({undo:!0,splitTasks:!0});return(n.length?n:he.getToolbarButtons({undo:v,splitTasks:b})).map(Q=>{let f={...Q,disabled:!1};return f.handler=he.isHandledAction(H,f.id)?M=>he.handleAction(s,M.id,null,o):f.handler,f.text&&(f.text=o(f.text)),f.menuText&&(f.menuText=o(f.menuText)),f})},[n,s,o,v,b]),F=e.useMemo(()=>{const H=[];return h.forEach(G=>{const Q=G.id;if(Q==="add-task")H.push(G);else if(a.includes(Q))a.includes(Q)&&H.push({...G,disabled:G.isDisabled(p)});else{if(!N?.length||!s)return;H.push({...G,disabled:G.isDisabled&&N.some(f=>G.isDisabled(f,s.getState()))})}}),H.filter((G,Q)=>{if(s&&G.isHidden)return!N.some(f=>G.isHidden(f,s.getState()));if(G.comp==="separator"){const f=H[Q+1];if(!f||f.comp==="separator")return!1}return!0})},[s,N,p,h]);return r?l.jsx(dt.Toolbar,{items:F}):l.jsx(ye.context.i18n.Provider,{value:i,children:l.jsx(dt.Toolbar,{items:F})})}const is=e.forwardRef(function({options:n=[],api:r=null,resolver:i=null,filter:o=null,at:N="point",children:v,onClick:p,css:b},a){const h=e.useRef(null),F=e.useRef(null),H=e.useContext(ye.context.i18n),G=e.useMemo(()=>H||Ce.locale({...Ve.en,...et.en}),[H]),Q=e.useMemo(()=>G.getGroup("gantt"),[G]),f=D.useStoreLater(r,"taskTypes"),M=D.useStoreLater(r,"selected"),P=D.useStoreLater(r,"_selected"),X=D.useStoreLater(r,"splitTasks"),W=e.useMemo(()=>he.getMenuOptions({splitTasks:!0}),[]);e.useEffect(()=>{r&&(r.on("scroll-chart",()=>{h.current&&h.current.show&&h.current.show()}),r.on("drag-task",()=>{h.current&&h.current.show&&h.current.show()}))},[r]);function L(k){return k.map(S=>(S={...S},S.text&&(S.text=Q(S.text)),S.subtext&&(S.subtext=Q(S.subtext)),S.data&&(S.data=L(S.data)),S))}function O(){const k=n.length?n:he.getMenuOptions({splitTasks:X}),S=k.find(V=>V.id==="convert-task");return S&&(S.data=[],(f||[]).forEach(V=>{S.data.push(S.dataFactory(V))})),L(k)}const T=e.useMemo(()=>O(),[r,n,f,X,Q]),Z=e.useMemo(()=>P&&P.length?P:[],[P]),ce=e.useCallback((k,S)=>{let V=k?r?.getTask(k):null;if(i){const le=i(k,S);V=le===!0?V:le}if(V){const le=Ce.locateID(S.target,"data-segment");le!==null?F.current={id:V.id,segmentIndex:le}:F.current=V.id,(!Array.isArray(M)||!M.includes(V.id))&&r&&r.exec&&r.exec("select-task",{id:V.id})}return V},[r,i,M]),oe=e.useCallback(k=>{const S=k.action;S&&(he.isHandledAction(W,S.id)&&he.handleAction(r,S.id,F.current,Q),p&&p(k))},[r,Q,p,W]),te=e.useCallback((k,S)=>{const V=Z.length?Z:S?[S]:[];let le=o?V.every(I=>o(k,I)):!0;if(le&&(k.isHidden&&(le=!V.some(I=>k.isHidden(I,r.getState(),F.current))),k.isDisabled)){const I=V.some(ue=>k.isDisabled(ue,r.getState(),F.current));k.disabled=I}return le},[o,Z,r]);e.useImperativeHandle(a,()=>({show:(k,S)=>{h.current&&h.current.show&&h.current.show(k,S)}}));const J=e.useCallback(k=>{h.current&&h.current.show&&h.current.show(k)},[]),de=l.jsxs(l.Fragment,{children:[l.jsx(Nt.ContextMenu,{filter:te,options:T,dataKey:"id",resolver:ce,onClick:oe,at:N,ref:h,css:b}),l.jsx("span",{onContextMenu:J,"data-menu-ignore":"true",children:typeof v=="function"?v():v})]});if(!H&&ye.context.i18n?.Provider){const k=ye.context.i18n.Provider;return l.jsx(k,{value:G,children:de})}return de});function as({api:s,autoSave:n,onLinksChange:r}){const o=e.useContext(ye.context.i18n).getGroup("gantt"),N=D.useStore(s,"activeTask"),v=D.useStore(s,"_activeTask"),p=D.useStore(s,"_links"),b=D.useStore(s,"schedule"),a=D.useStore(s,"unscheduledTasks"),[h,F]=e.useState();function H(){if(N){const M=p.filter(X=>X.target==N).map(X=>({link:X,task:s.getTask(X.source)})),P=p.filter(X=>X.source==N).map(X=>({link:X,task:s.getTask(X.target)}));return[{title:o("Predecessors"),data:M},{title:o("Successors"),data:P}]}}e.useEffect(()=>{F(H())},[N,p]);const G=e.useMemo(()=>[{id:"e2s",label:o("End-to-start")},{id:"s2s",label:o("Start-to-start")},{id:"e2e",label:o("End-to-end")},{id:"s2e",label:o("Start-to-end")}],[o]);function Q(M){n?s.exec("delete-link",{id:M}):(F(P=>(P||[]).map(X=>({...X,data:X.data.filter(W=>W.link.id!==M)}))),r&&r({id:M,action:"delete-link",data:{id:M}}))}function f(M,P){n?s.exec("update-link",{id:M,link:P}):(F(X=>(X||[]).map(W=>({...W,data:W.data.map(L=>L.link.id===M?{...L,link:{...L.link,...P}}:L)}))),r&&r({id:M,action:"update-link",data:{id:M,link:P}}))}return l.jsx(l.Fragment,{children:(h||[]).map((M,P)=>M.data.length?l.jsx("div",{className:"wx-j93aYGQf wx-links",children:l.jsx(ye.Field,{label:M.title,position:"top",children:l.jsx("table",{children:l.jsx("tbody",{children:M.data.map(X=>l.jsxs("tr",{children:[l.jsx("td",{className:"wx-j93aYGQf wx-cell",children:l.jsx("div",{className:"wx-j93aYGQf wx-task-name",children:X.task.text||""})}),b?.auto&&X.link.type==="e2s"?l.jsx("td",{className:"wx-j93aYGQf wx-cell wx-link-lag",children:l.jsx(ye.Text,{type:"number",placeholder:o("Lag"),value:X.link.lag,disabled:a&&v?.unscheduled,onChange:W=>{W.input||f(X.link.id,{lag:W.value})}})}):null,l.jsx("td",{className:"wx-j93aYGQf wx-cell",children:l.jsx("div",{className:"wx-j93aYGQf wx-wrapper",children:l.jsx(ye.Combo,{value:X.link.type,placeholder:o("Select link type"),options:G,onChange:W=>f(X.link.id,{type:W.value}),children:({option:W})=>W.label})})}),l.jsx("td",{className:"wx-j93aYGQf wx-cell",children:l.jsx("i",{className:"wx-j93aYGQf wxi-delete wx-delete-icon",onClick:()=>Q(X.link.id),role:"button"})})]},X.link.id))})})})},P):null)})}function us(s){const{value:n,time:r,format:i,onchange:o,onChange:N,...v}=s,p=N??o;function b(a){const h=new Date(a.value);h.setUTCHours(n.getUTCHours()),h.setUTCMinutes(n.getUTCMinutes()),p&&p({value:h})}return l.jsxs("div",{className:"wx-hFsbgDln date-time-controll",children:[l.jsx(ye.DatePicker,{...v,value:n,onChange:b,format:i,buttons:["today"],clear:!1}),r?l.jsx(ye.TimePicker,{value:n,onChange:p,format:i}):null]})}_e.registerEditorItem("select",ye.RichSelect);_e.registerEditorItem("date",us);_e.registerEditorItem("twostate",ye.TwoState);_e.registerEditorItem("slider",ye.Slider);_e.registerEditorItem("counter",ye.Counter);_e.registerEditorItem("links",as);function ds({api:s,items:n=[],css:r="",layout:i="default",readonly:o=!1,placement:N="sidebar",bottomBar:v=!0,topBar:p=!0,autoSave:b=!0,focus:a=!1,hotkeys:h={}}){const F=e.useContext(ye.context.i18n),H=e.useMemo(()=>F||Ce.locale({...Ve.en,...et.en}),[F]),G=e.useMemo(()=>H.getGroup("gantt"),[H]),Q=H.getRaw(),f=e.useMemo(()=>{const x=Q.gantt?.dateFormat||Q.formats?.dateFormat;return Ce.dateToString(x,Q.calendar)},[Q]),M=e.useMemo(()=>{if(p===!0&&!o){const x=[{comp:"icon",icon:"wxi-close",id:"close"},{comp:"spacer"},{comp:"button",type:"danger",text:G("Delete"),id:"delete"}];return b?{items:x}:{items:[...x,{comp:"button",type:"primary",text:G("Save"),id:"save"}]}}return p},[p,o,b,G]),[P,X]=e.useState(!1),W=e.useMemo(()=>P?"wx-full-screen":"",[P]),L=e.useCallback(x=>{X(x)},[]);e.useEffect(()=>{const x=yt(L);return x.observe(),()=>{x.disconnect()}},[L]);const O=D.useStore(s,"_activeTask"),T=D.useStore(s,"activeTask"),Z=D.useStore(s,"unscheduledTasks"),ce=D.useStore(s,"links"),oe=D.useStore(s,"splitTasks"),te=e.useMemo(()=>oe&&T?.segmentIndex,[oe,T]),J=e.useMemo(()=>te||te===0,[te]),de=e.useMemo(()=>he.getEditorItems({unscheduledTasks:Z}),[Z]),k=D.useStore(s,"undo"),[S,V]=e.useState({}),[le,I]=e.useState(null),[ue,se]=e.useState(),[we,ke]=e.useState(null),ve=D.useStore(s,"taskTypes"),$e=e.useMemo(()=>{if(!O)return null;let x;if(J&&O.segments?x={...O.segments[te]}:x={...O},o){let q={parent:x.parent};return de.forEach(({key:ee,comp:U})=>{if(U!=="links"){const Me=x[ee];U==="date"&&Me instanceof Date?q[ee]=f(Me):U==="slider"&&ee==="progress"?q[ee]=`${Me}%`:q[ee]=Me}}),q}return x||null},[O,J,te,o,de,f]);e.useEffect(()=>{se($e)},[$e]),e.useEffect(()=>{V({}),ke(null),I(null)},[T]);function Ee(x,q){return x.map(ee=>{const U={...ee};if(ee.config&&(U.config={...U.config}),U.comp==="links"&&s&&(U.api=s,U.autoSave=b,U.onLinksChange=De),U.comp==="select"&&U.key==="type"){const Me=U.options??(ve||[]);U.options=Me.map(Le=>({...Le,label:G(Le.label)}))}return U.comp==="slider"&&U.key==="progress"&&(U.labelTemplate=Me=>`${G(U.label)} ${Me}%`),U.label&&(U.label=G(U.label)),U.config?.placeholder&&(U.config.placeholder=G(U.config.placeholder)),q&&(U.isDisabled&&U.isDisabled(q,s.getState())?U.disabled=!0:delete U.disabled),U})}const Te=e.useMemo(()=>{let x=n.length?n:de;return x=Ee(x,ue),ue?x.filter(q=>!q.isHidden||!q.isHidden(ue,s.getState())):x},[n,de,ue,ve,G,s,b]),je=e.useMemo(()=>Te.map(x=>x.key),[Te]);function De({id:x,action:q,data:ee}){V(U=>({...U,[x]:{action:q,data:ee}}))}const ae=e.useCallback(()=>{for(let x in S)if(ce.byId(x)){const{action:q,data:ee}=S[x];s.exec(q,ee)}},[s,S,ce]),g=e.useCallback(()=>{const x=T?.id||T;if(J){if(O?.segments){const q=O.segments.filter((ee,U)=>U!==te);s.exec("update-task",{id:x,task:{segments:q}})}}else s.exec("delete-task",{id:x})},[s,T,J,O,te]),_=e.useCallback(()=>{s.exec("show-editor",{id:null})},[s]),z=e.useCallback(x=>{const{item:q,changes:ee}=x;q.id==="delete"&&g(),q.id==="save"&&(ee.length?_():ae()),q.comp&&_()},[s,T,b,ae,g,_]),Y=e.useCallback((x,q,ee)=>(Z&&x.type==="summary"&&(x.unscheduled=!1),he.prepareEditTask(x,s.getState(),q),ee||I(!1),x),[Z,s]),K=e.useCallback(x=>{x={...x,unscheduled:Z&&x.unscheduled&&x.type!=="summary"},delete x.links,delete x.data,(je.indexOf("duration")===-1||x.segments&&!x.duration)&&delete x.duration;const q={id:T?.id||T,task:x,...J&&{segmentIndex:te}};b&&le&&(q.inProgress=le),s.exec("update-task",q),b||ae()},[s,T,Z,b,ae,je,J,te,le]),xe=e.useCallback(x=>{let{update:q,key:ee,input:U}=x;if(U&&I(!0),x.update=Y({...q},ee,U),!b)se(x.update);else if(!we&&!U){const Me=Te.find(ne=>ne.key===ee),Le=q[ee];(!Me.validation||Me.validation(Le))&&(!Me.required||Le)&&K(x.update)}},[b,Y,we,Te,K]),Se=e.useCallback(x=>{b||K(x.values)},[b,K]),y=e.useCallback(x=>{ke(x.errors)},[]),B=e.useMemo(()=>k?{"ctrl+z":x=>{x.preventDefault(),s.exec("undo")},"ctrl+y":x=>{x.preventDefault(),s.exec("redo")}}:{},[k,s]);return $e?l.jsx(ye.Locale,{children:l.jsx(_e.Editor,{css:`wx-XkvqDXuw wx-gantt-editor ${W} ${r}`,items:Te,values:$e,topBar:M,bottomBar:v,placement:N,layout:i,readonly:o,autoSave:b,focus:a,onAction:z,onSave:Se,onValidation:y,onChange:xe,hotkeys:h&&{...B,...h}})}):null}const fs=({children:s,columns:n=null,api:r})=>{const[i,o]=e.useState(null);return e.useEffect(()=>{r&&r.getTable(!0).then(o)},[r]),l.jsx(pt.HeaderMenu,{api:i,columns:n,children:s})};function xs(s){const{api:n,content:r,children:i}=s,o=e.useRef(null),N=e.useRef(null),[v,p]=e.useState({}),[b,a]=e.useState(null),[h,F]=e.useState({});function H(L){for(;L;){if(L.getAttribute){const O=L.getAttribute("data-tooltip-id"),T=L.getAttribute("data-tooltip-at"),Z=L.getAttribute("data-tooltip");if(O||Z)return{id:O,tooltip:Z,target:L,at:T}}L=L.parentNode}return{id:null,tooltip:null,target:null,at:null}}e.useEffect(()=>{const L=N.current;if(L&&h&&(h.text||r)){const O=L.getBoundingClientRect();let T=!1,Z=h.left,ce=h.top;O.right>=v.right&&(Z=v.width-O.width-5,T=!0),O.bottom>=v.bottom&&(ce=h.top-(O.bottom-v.bottom+2),T=!0),T&&F(oe=>oe&&{...oe,left:Z,top:ce})}},[h,v,r]);const G=e.useRef(null),Q=300,f=L=>{clearTimeout(G.current),G.current=setTimeout(()=>{L()},Q)};function M(L){let{id:O,tooltip:T,target:Z,at:ce}=H(L.target);if(F(null),a(null),!T)if(O)T=X(O);else{clearTimeout(G.current);return}const oe=L.clientX;f(()=>{O&&a(P(W(O)));const te=Z.getBoundingClientRect(),J=o.current,de=J?J.getBoundingClientRect():{top:0,left:0,right:0,bottom:0,width:0,height:0};let k,S;ce==="left"?(k=te.top+5-de.top,S=te.right+5-de.left):(k=te.top+te.height-de.top,S=oe-de.left),p(de),F({top:k,left:S,text:T})})}function P(L){return n?.getTask(W(L))||null}function X(L){return P(L)?.text||""}function W(L){const O=parseInt(L);return isNaN(O)?L:O}return l.jsxs("div",{className:"wx-KG0Lwsqo wx-tooltip-area",ref:o,onMouseMove:M,children:[h&&(h.text||r)?l.jsx("div",{className:"wx-KG0Lwsqo wx-gantt-tooltip",ref:N,style:{top:`${h.top}px`,left:`${h.left}px`},children:r?l.jsx(r,{data:b}):h.text?l.jsx("div",{className:"wx-KG0Lwsqo wx-gantt-tooltip-text",children:h.text}):null}):null,i]})}function ms({fonts:s=!0,children:n}){return n?l.jsx(ye.Material,{fonts:s,children:n()}):l.jsx(ye.Material,{fonts:s})}function hs({fonts:s=!0,children:n}){return n?l.jsx(ye.Willow,{fonts:s,children:n}):l.jsx(ye.Willow,{fonts:s})}function gs({fonts:s=!0,children:n}){return n?l.jsx(ye.WillowDark,{fonts:s,children:n}):l.jsx(ye.WillowDark,{fonts:s})}Object.defineProperty(exports,"defaultColumns",{enumerable:!0,get:()=>he.defaultColumns});Object.defineProperty(exports,"defaultEditorItems",{enumerable:!0,get:()=>he.defaultEditorItems});Object.defineProperty(exports,"defaultMenuOptions",{enumerable:!0,get:()=>he.defaultMenuOptions});Object.defineProperty(exports,"defaultTaskTypes",{enumerable:!0,get:()=>he.defaultTaskTypes});Object.defineProperty(exports,"defaultToolbarButtons",{enumerable:!0,get:()=>he.defaultToolbarButtons});Object.defineProperty(exports,"getEditorItems",{enumerable:!0,get:()=>he.getEditorItems});Object.defineProperty(exports,"getMenuOptions",{enumerable:!0,get:()=>he.getMenuOptions});Object.defineProperty(exports,"getToolbarButtons",{enumerable:!0,get:()=>he.getToolbarButtons});Object.defineProperty(exports,"registerScaleUnit",{enumerable:!0,get:()=>he.registerScaleUnit});Object.defineProperty(exports,"registerEditorItem",{enumerable:!0,get:()=>_e.registerEditorItem});exports.ContextMenu=is;exports.Editor=ds;exports.Gantt=ls;exports.HeaderMenu=fs;exports.Material=ms;exports.Toolbar=cs;exports.Tooltip=xs;exports.Willow=hs;exports.WillowDark=gs;
//# sourceMappingURL=index.cjs.map
